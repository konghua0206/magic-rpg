<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é­”æ³•ä¿®ç…‰ RPGï¼šæ¸¬è©¦ç‰ˆ</title>
<link rel="stylesheet" href="css/style.css">
</head>

<body>

<!--å°è¦½ã€å…¨å±€ç‹€æ…‹èˆ‡å´é‚Šæ¬„ (Global & Nav)-->
<nav class="sidebar">
  <div class="nav-item active" onclick="switchPage('character')"><span>ğŸ‘¤</span>è§’è‰²</div>
  <div class="nav-item" onclick="switchPage('battle')"><span>âš”ï¸</span>æˆ°é¬¥</div>
  <div class="nav-item" onclick="switchPage('skills')"><span>ğŸ“œ</span>æŠ€èƒ½</div>
  <div class="nav-item" onclick="switchPage('inventory')"><span>ğŸ’</span>èƒŒåŒ…</div>
  <div class="nav-item" onclick="switchPage('exchange')"><span>ğŸ</span>å…Œæ›</div>
  <div class="nav-item" id="nav-settings" onclick="switchPage('settings')"><span>âš™ï¸</span>è¨­å®š</div>
</nav>

<div class="main-wrapper">
  <div class="main-content">
    <div class="magic">âœ¨ <span id="mana">0</span></div>
    <div class="mps" style="text-align:center; opacity:0.8; font-size:12px; margin-bottom: 15px;">
      é­”åŠ›æµå‹•ï¼š<span id="mps">0</span>/s
    </div>

<!--åˆ†é å…§å®¹å€ (Pages)-->

<!--è§’è‰²é é¢ (Character Page)-->
<div id="page-character" class="page active">
  <div style="text-align: center; margin-bottom: 15px;">
    <div id="nameDisplay" style="font-weight:bold; font-size:20px; color:var(--primary); letter-spacing: 1px;">æœªå‘½åå‹‡è€…</div>
    <input type="text" id="nameInput" style="display:none;" maxlength="8">
    <div class="small">Level <span id="charLv">1</span></div>
  </div>

  <div class="card" style="padding: 10px;">
    <div style="width: 100%; aspect-ratio: 1/1; position: relative; overflow: hidden; border-radius: 12px; border: 2px solid var(--primary); background: #000; margin-bottom: 20px;">
      <img id="avatarImg" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" src="https://via.placeholder.com/400" />
      <button id="editBtn" style="position: absolute; bottom: 10px; right: 10px; width: auto; font-size: 10px; padding: 5px 10px; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);">ç·¨è¼¯é ­åƒ/ID</button>
      <input type="file" id="avatarInput" style="display:none;" accept="image/*">
    </div>

    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; justify-items: center; padding: 10px;">
      <div class="equip-slot" id="slot-mainHand" data-label="ä¸»æ‰‹">ğŸ—¡ï¸</div>
      <div class="equip-slot" id="slot-offHand" data-label="å‰¯æ‰‹">ğŸ›¡ï¸</div>
      <div class="equip-slot" id="slot-necklace" data-label="é …éŠ">ğŸ“¿</div>
      <div class="equip-slot" id="slot-head" data-label="é ­éƒ¨">ğŸ“</div>
      <div class="equip-slot" id="slot-top" data-label="ä¸Šè¡£">ğŸ‘˜</div>
      <div class="equip-slot" id="slot-ring1" data-label="æˆ’æŒ‡1">ğŸ’</div>
      <div class="equip-slot" id="slot-shoes" data-label="é‹å­">ğŸ‘</div>
      <div class="equip-slot" id="slot-bottom" data-label="ä¸‹è¡£">ğŸ‘–</div>
      <div class="equip-slot" id="slot-ring2" data-label="æˆ’æŒ‡2">ğŸ’</div>
    </div>
  </div>

  <div class="card">
    <strong>ğŸ“Š æˆ°é¬¥å±¬æ€§</strong>
    <div class="small" style="margin: 10px 0;">ç”Ÿå‘½å€¼ HP: <span id="hpText">0 / 0</span></div>
    <div style="width: 100%; height: 10px; background: #441111; border-radius: 5px; overflow: hidden; margin-bottom: 15px;">
      <div id="hpBar" style="width: 100%; height: 100%; background: #ff4d4d; transition: width 0.3s;"></div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
      <div class="attr" style="font-size: 0.85em;"><span>âš”ï¸ æ”»æ“Š: <span id="atk">0</span><span id="atk-bonus" class="bonus-text"></span></span></div>
      <div class="attr" style="font-size: 0.85em;"><span>ğŸ›¡ï¸ é˜²ç¦¦: <span id="def">0</span><span id="def-bonus" class="bonus-text"></span></span></div>
      <div class="attr" style="font-size: 0.85em;"><span>ğŸ¯ æš´æ“Š: <span id="crit">0</span>%<span id="crit-bonus" class="bonus-text"></span></span></div>
      <div class="attr" style="font-size: 0.85em;"><span>ğŸƒ é–ƒé¿: <span id="dodge">0</span>%<span id="dodge-bonus" class="bonus-text"></span></span></div>
    </div>

    <hr style="opacity:0.1; margin: 15px 0;">

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <div style="font-size: 0.9em; font-weight: bold;">
        âœ¨ å¯ç”¨èƒ½åŠ›é»ï¼š<span id="points" style="color: var(--primary);">0</span>
      </div>
      <button onclick="resetStats()" style="padding: 5px 10px; font-size: 11px; background: rgba(255,118,117,0.1); color: #ff7675; border: 1px solid #ff7675; border-radius: 4px; cursor: pointer;">
        ğŸ”„ é‡ç½®é…é»
      </button>
    </div>

    <div class="attr"><span>ğŸ’ª åŠ›é‡ï¼š<span id="str">0</span><span id="str-bonus" class="bonus-text"></span></span> <button style="width:36px; padding:4px;" onclick="addAttr('str')">+</button></div>
    <div class="attr"><span>ğŸƒ æ•æ·ï¼š<span id="agi">0</span><span id="agi-bonus" class="bonus-text"></span></span> <button style="width:36px; padding:4px;" onclick="addAttr('agi')">+</button></div>
    <div class="attr"><span>ğŸ“˜ æ™ºåŠ›ï¼š<span id="int">0</span><span id="int-bonus" class="bonus-text"></span></span> <button style="width:36px; padding:4px;" onclick="addAttr('int')">+</button></div>
    <div class="attr"><span>â³ å†¥æƒ³ï¼š<span id="med">0</span><span id="med-bonus" class="bonus-text"></span></span> <button style="width:36px; padding:4px;" onclick="addAttr('med')">+</button></div>
    <div class="attr"><span>â¤ï¸ é«”è³ªï¼š<span id="vit">0</span><span id="vit-bonus" class="bonus-text"></span></span> <button style="width:36px; padding:4px;" onclick="addAttr('vit')">+</button></div>
    <div class="attr"><span>ğŸ€ å¹¸é‹ï¼š<span id="luk">0</span><span id="luk-bonus" class="bonus-text"></span></span> <button style="width:36px; padding:4px;" onclick="addAttr('luk')">+</button></div>

    <button id="upgradeChar" style="margin-top: 15px; width: 100%;">è§’è‰²ç­‰ç´šæå‡ (<span id="charCost">0</span>âœ¨)</button>
  </div>
</div>

<!--æˆ°é¬¥é é¢ (Battle Page)-->
<div id="page-battle" class="page" style="width: 100%; max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; box-sizing: border-box;">

  <div class="card" style="padding: 10px; background: #1a1a2e; border: 1px solid #7b1fa2; border-radius: 12px; display: flex; gap: 8px;">
    <button id="btnModeAdv" onclick="toggleBattleMode('adventure')" style="flex: 1; padding: 10px; border-radius: 8px; font-size: 13px; border: none; background: #7b1fa2; color: #fff; font-weight: bold; cursor: pointer;">ğŸŒ² å€åŸŸå†’éšª</button>
    <button id="btnModeBoss" onclick="toggleBattleMode('boss')" style="flex: 1; padding: 10px; border-radius: 8px; font-size: 13px; border: 1px solid #7b1fa2; background: #121212; color: #b39ddb; font-weight: bold; cursor: pointer;">ğŸ’€ é¦–é ˜æŒ‘æˆ°</button>
  </div>

  <div style="background: #161625; border: 1px solid #4a148c; border-radius: 16px; padding: 15px; display: flex; flex-direction: column; gap: 15px; box-shadow: inset 0 0 20px rgba(0,0,0,0.5);">
    
    <div id="controlSection">
      <div id="adventureControls">
        <select id="regionSelect" onchange="changeRegion(this.value)" 
                style="width: 100%; padding: 12px; background: #000; color: #e1bee7; border: 1px solid #9c27b0; border-radius: 8px; font-size: 14px; outline: none;">
        </select>
      </div>
      
      <div id="bossControls" style="display:none;">
        <style>
          /* ç‚º BOSS åˆ—è¡¨è¨­è¨ˆçš„ç²—æ©«å‘æ»¾è»¸ */
          #bossList::-webkit-scrollbar {
            height: 10px; /* å¢åŠ é«˜åº¦è®“ PC å¥½é»æ“Š */
          }
          #bossList::-webkit-scrollbar-track {
            background: #000;
            border-radius: 5px;
          }
          #bossList::-webkit-scrollbar-thumb {
            background: #7b1fa2;
            border-radius: 5px;
            border: 2px solid #000;
          }
          #bossList::-webkit-scrollbar-thumb:hover {
            background: #9c27b0;
          }
        </style>
        <div id="bossList" style="display: flex; gap: 12px; overflow-x: auto; padding: 10px 5px 15px 5px; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;">
          </div>
        <div style="text-align:center; color:#9c27b0; font-size: 11px; margin-top: 2px; font-weight: bold; letter-spacing: 1px;">
          â¬… å·¦å³æ»‘å‹•æˆ–æ‹–å‹•æ»¾è»¸é¸æ“‡å°æ‰‹ â¡
        </div>
      </div>
    </div>

    <div id="battleStatus" style="text-align: center; color: #f1c40f; font-weight: bold; font-size: 14px; letter-spacing: 1px; text-shadow: 0 0 8px rgba(241,196,15,0.4);">
      æº–å‚™å°±ç·’
    </div>

    <div id="battleDisplayArea" style="display: flex; flex-direction: column; gap: 10px;">
      <div id="battle-buffs" style="display:flex; gap:6px; justify-content:center; flex-wrap:wrap; min-height:22px;"></div>

      <div id="playerBattleArea" style="display:none; position: relative; overflow: hidden; min-height: 120px; border-left: 4px solid #2ecc71; padding: 12px; background: linear-gradient(90deg, #1b3320, #1a1a2e); border-radius: 10px;">
  <img id="battlePlayerImg" src="" style="position: absolute; right: -5px; top: -5px; height: 130%; opacity: 0.5; pointer-events: none; mask-image: linear-gradient(to left, black, transparent); -webkit-mask-image: linear-gradient(to left, black, transparent); object-fit: contain;">
  <div style="position: relative; z-index: 1;">
    <div id="playerSideName" style="font-weight: bold; color: #2ecc71; font-size: 16px; text-shadow: 0 0 5px rgba(46, 204, 113, 0.5);">ç©å®¶</div>
    <div style="font-size: 13px; color: #a2cfb6; margin-top: 4px;">HP: <span id="pBattleHpText">0 / 0</span></div>
    <div style="width:120px; height:10px; background:rgba(0,0,0,0.6); border-radius:5px; margin-top:8px; border: 1px solid #1e5631; overflow:hidden;">
      <div id="pBattleHpBar" style="width:100%; height:100%; background:linear-gradient(90deg, #27ae60, #2ecc71); transition: 0.3s; box-shadow: 0 0 8px rgba(46, 204, 113, 0.4);"></div>
    </div>
  </div>
</div>

      <div id="vsTitle" style="display:none; text-align: center; color: #4a148c; font-weight: 900; font-style: italic; font-size: 18px;">V.S.</div>

      <div id="monsterArea" style="display:none; position: relative; overflow: hidden; min-height: 120px; border-right: 4px solid #e74c3c; padding: 12px; background: linear-gradient(270deg, #3d1010, #1a1a2e); border-radius: 10px;">
        <img id="bossImg" src="" style="position: absolute; left: -5px; top: -5px; height: 130%; opacity: 0.5; pointer-events: none; mask-image: linear-gradient(to right, black, transparent); -webkit-mask-image: linear-gradient(to right, black, transparent); object-fit: contain;">
        <div style="position: relative; z-index: 1; text-align: right;">
          <div id="mName" style="font-weight: bold; color: #ffab91; font-size: 16px;">æ€ªç‰©åç¨±</div>
          <div style="font-size: 13px; color: #ffab91; margin-top: 4px;">HP: <span id="mHpText">0 / 0</span></div>
          <div style="width:120px; height:10px; background:rgba(0,0,0,0.6); border-radius:5px; margin-top:8px; border: 1px solid #bf360c; overflow:hidden; margin-left: auto;">
            <div id="mHpBar" style="width:100%; height:100%; background:linear-gradient(90deg, #ff4d4d, #ff9f43); transition: 0.3s;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<style>
  /* æˆ°é¬¥æ—¥èªŒå°ˆå±¬ç¾åŒ–æ»¾å‹•æ¢ */
  #battleLog::-webkit-scrollbar {
    width: 6px; /* ç¸±å‘æ‹‰æ¡¿å¯¬åº¦ */
  }
  #battleLog::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.3); /* è»Œé“èƒŒæ™¯ */
    border-radius: 10px;
  }
  #battleLog::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #7b1fa2, #4a148c); /* ä½¿ç”¨èˆ‡ä¸»é¡Œä¸€è‡´çš„ç´«è‰²æ¼¸å±¤ */
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  #battleLog::-webkit-scrollbar-thumb:hover {
    background: #9c27b0; /* æ‡¸åœæ™‚è®Šäº® */
  }

  /* ç‚ºäº†è®“æ—¥èªŒæ–‡å­—æ›´æ˜“è®€ï¼Œç¨å¾®èª¿æ•´é–“è· */
  #battleLog div {
    margin-bottom: 4px;
    padding-bottom: 2px;
    border-bottom: 1px border-bottom: 1px dotted rgba(255,255,255,0.05);
  }
</style>

<div class="card" style="background: #000; border: 1px solid #4a148c; border-radius: 12px; overflow: hidden;">
  <div style="background: #1a1a2e; padding: 8px 12px; font-size: 11px; color: #fff; border-bottom: 1px solid #4a148c; font-weight: bold; letter-spacing: 1px;">ğŸ“œ æˆ°é¬¥æƒ…å ±å›å ±</div>
  <div id="battleLog" style="height: 140px; overflow-y: auto; font-size: 12px; padding: 10px; color: #ffffff; line-height: 1.6; background: rgba(26, 26, 46, 0.4); scroll-behavior: smooth;"></div>
</div>

  <div style="margin-top: 5px;">
    <button id="startBattleBtn" onclick="startBattle()" 
            style="width: 100%; padding: 16px; background: linear-gradient(180deg, #7b1fa2, #4a148c); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; box-shadow: 0 4px 0 #2e0d5a; cursor: pointer;">
      âš”ï¸ é–‹å§‹æœå°‹å°æ‰‹
    </button>
    <button id="stopBattleBtn" onclick="stopBattle('å·²æ’¤é›¢æˆ°å ´')" 
            style="display:none; width: 100%; padding: 16px; background: #2c2c44; color: #b39ddb; border: 1px solid #4a148c; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer;">
      ğŸ³ï¸ åœæ­¢æˆ°é¬¥ / æ’¤é€€
    </button>
  </div>

</div>

<!--æŠ€èƒ½é é¢ (Skills Page)-->
<div id="page-skills" class="page" style="display:none;">
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <strong>ğŸ”® æŠ€èƒ½é…ç½®</strong>
      <span class="small">å·²ç¶å®š: <span id="activeSkillCount">0</span> / 3</span>
    </div>
    <div id="skillList" style="display:flex; flex-direction:column; gap:10px;"></div>
    <div class="small" style="margin-top:15px; color:rgba(255,255,255,0.4); text-align:center;">
      â€» é ˜æ‚ŸæŠ€èƒ½éœ€æ¶ˆè€—é­”åŠ›èˆ‡ç‰¹å®š BOSS ææ–™
    </div>
  </div>
</div>

<!--èƒŒåŒ…é é¢ (Inventory Page)-->
<div id="page-inventory" class="page">
  <div class="card">
    <div style="display:flex; gap:10px; margin-bottom:15px;">
      <button onclick="setInvTab('equip')" id="btnTabEquip" style="flex:1;">ğŸ›¡ï¸ è£å‚™</button>
      <button onclick="setInvTab('material')" id="btnTabMat" style="flex:1; background:#444;">ğŸ“¦ ææ–™</button>
    </div>

    <div id="inventoryControls" style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05);">
      
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span class="small" style="color: #aaa;">èƒŒåŒ…æ“ä½œæ¨¡å¼</span>
        <button id="invModeBtn" onclick="toggleInvMode()" style="background: rgba(255,255,255,0.05); color: #2ecc71; border: 1px solid #2ecc71; padding: 5px 15px; border-radius: 20px; font-size: 11px; cursor: pointer; transition: all 0.3s; font-weight: bold;">
          âš¡ ç•¶å‰ï¼šè£å‚™æ¨¡å¼
        </button>
      </div>

      <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.05); margin: 10px 0;">

      <div class="small" style="margin-bottom: 8px; color: var(--primary);">ğŸ’° æ‰¹é‡æ¸…ç†</div>
      <div style="display: flex; gap: 8px; align-items: center;">
        <select id="sellRarityFilter" style="flex: 2; background:#222; color:#fff; border:1px solid #444; border-radius:6px; padding:6px; font-size: 12px;">
          <option value="0">åƒ…é™ï¼šæ™®é€š (ç™½)</option>
          <option value="1">åŒ…å«ï¼šç¨€æœ‰ (è—) ä»¥ä¸‹</option>
          <option value="2">åŒ…å«ï¼šå²è©© (ç´«) ä»¥ä¸‹</option>
        </select>
        <button onclick="bulkSell()" style="flex: 1; background: #e74c3c; padding: 7px; font-size: 12px; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">ä¸€éµè²©å”®</button>
      </div>
    </div>

    <div id="inventoryContainer"></div>
  </div>
</div>

<!--å…Œæ›é é¢ (Settings Page)-->
<div id="page-exchange" class="page" style="display:none;">
  <div class="character-card" style="text-align:center; padding: 30px;">
    <p style="color:rgba(255,255,255,0.6); margin-bottom:20px;">è¼¸å…¥åºè™Ÿä¸¦æ”¯ä»˜æŒ‡å®šç´ æå³å¯å…Œæ›çå‹µ</p>
    
    <input type="text" id="exchangeInput" placeholder="è«‹è¼¸å…¥å…Œæ›ç¢¼..." 
           style="width: 80%; padding: 12px; border-radius: 8px; border: none; background: rgba(0,0,0,0.3); color: white; text-align: center; font-size: 16px;">
    
    <button class="btn-primary" onclick="processExchange()" style="margin-top: 20px; width: 60%;">ç¢ºèªå…Œæ›</button>
    
    <div id="exchangeHint" style="margin-top:20px; font-size: 14px; color: #fab1a0;"></div>
  </div>
</div>


<!--è¨­å®šé é¢ (Settings Page)-->
<div id="page-settings" class="page">
  <div class="card">
    <h3 style="margin-top: 0; color: var(--primary);">âš™ï¸ éŠæˆ²è¨­å®š</h3>
    <p class="small">åœ¨é€™è£¡ç®¡ç†ä½ çš„å†’éšªé€²åº¦èˆ‡éŠæˆ²é¸é …ã€‚</p>
    
    <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">

    <div class="card">
      <strong style="color: var(--primary);">ğŸ’¾ å­˜æª”ç®¡ç†</strong>
      <p class="small">å°‡ä½ çš„é€²åº¦ä¸‹è¼‰ç‚ºæª”æ¡ˆä¿å­˜ï¼Œæˆ–ä¸Šå‚³æª”æ¡ˆæ¢å¾©é€²åº¦ã€‚</p>
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button onclick="exportSaveFile()" style="flex: 1; background: #3498db;">ä¸‹è¼‰å­˜æª”æª”</button>
        <button onclick="document.getElementById('importFileInput').click()" style="flex: 1; background: #2ecc71;">ä¸Šå‚³å­˜æª”æª”</button>
      </div>
      <input type="file" id="importFileInput" style="display:none;" accept=".sav,.json" onchange="importSaveFile(this)">
    </div>

    <div style="padding: 15px; border: 1px dashed #e74c3c; border-radius: 12px; background: rgba(231, 76, 60, 0.05);">
      <strong style="color: #e74c3c; display: block; margin-bottom: 5px;">âš ï¸ å±éšªå€åŸŸ</strong>
      <span class="small">åˆªé™¤å¾Œå°‡å¤±å»æ‰€æœ‰ç­‰ç´šã€è£å‚™ã€ææ–™èˆ‡é­”åŠ›ã€‚æ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚</span>
      <button class="danger-btn" onclick="confirmReset()" style="margin-top: 15px; background: #e74c3c;">åˆªé™¤æ‰€æœ‰éŠæˆ²ç´€éŒ„</button>
    </div>
  </div>
  
  <div class="card">
    <div class="small" style="text-align: center;">
      éŠæˆ²ç‰ˆæœ¬ï¼šv0.5.3<br>
      æœ€å¾Œå­˜æª”æ™‚é–“ï¼š<span id="lastSaveTime">--:--:--</span>
    </div>
  </div>
</div>

<!--å½ˆçª—ã€é å°¾èˆ‡çµæŸæ¨™ç±¤ (Modals & Footer)-->
<div id="itemModal" class="modal-overlay" onclick="closeModal()">
  <div class="modal-container" onclick="event.stopPropagation()" style="
    display: flex; 
    flex-direction: column; 
    gap: 12px; 
    align-items: center; 
    width: 92%; 
    max-width: 380px; 
    max-height: 85vh; /* é™åˆ¶æœ€é«˜ç‚ºè¢å¹• 85%ï¼Œé˜²æ­¢æº¢å‡ºè¢å¹• */
    background: transparent;
  ">
    
    <div id="compareCard" style="
      display: none; 
      width: 100%; 
      background: rgba(26, 26, 46, 0.95);
      border: 1px dashed #7b1fa2; 
      padding: 10px;
      border-radius: 12px;
      box-sizing: border-box;
      flex-shrink: 0; /* ç¦æ­¢å£“ç¸® */
    ">
      <div style="font-size: 11px; color: #b39ddb; text-align: center; margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 4px;">ç•¶å‰ç©¿æˆ´</div>
      <div id="compRarity" class="modal-rarity" style="text-align: center; font-size: 11px;"></div>
      <strong id="compName" style="font-size: 14px; display: block; text-align: center; color: #fff;"></strong>
      <div id="compStats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; font-size: 11px; margin: 5px 0; color: #bbb;"></div>
    </div>

    <div class="modal-card" style="
      width: 100%; 
      background: #1a1a2e; 
      border: 1px solid #4a148c; 
      padding: 15px; 
      border-radius: 16px;
      box-sizing: border-box;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      overflow: hidden; /* é—œéµï¼šè®“å…§éƒ¨å®¹å™¨æ‰¿æ¥æ»¾å‹• */
    ">
      <div id="targetLabel" style="font-size: 10px; color: #888; text-align: center; margin-bottom: 5px; letter-spacing: 1px;">é¸ä¸­ç‰©å“</div>
      <div id="modalRarity" class="modal-rarity" style="text-align: center;"></div>
      
      <div style="overflow-y: auto; scrollbar-width: none; flex-grow: 1; padding: 5px 0;">
        <div id="modalIcon" style="text-align: center; margin: 10px 0;"></div>
        <strong id="modalName" style="font-size: 18px; display: block; text-align: center; color: #fff; margin-bottom: 10px;"></strong>
        
        <div id="modalStats" style="
          display: grid; 
          grid-template-columns: 1fr 1fr; 
          gap: 6px; 
          margin: 10px 0; 
          padding: 10px 0; 
          border-top: 1px solid rgba(255,255,255,0.1); 
          border-bottom: 1px solid rgba(255,255,255,0.1); 
          color: #2ecc71; 
          font-weight: bold; 
          font-size: 13px;
        "></div>
        
        <div id="modalSkills" style="margin-bottom: 8px;"></div>
        <div id="modalPassive" style="margin-bottom: 8px; font-size: 12px;"></div>
        <div id="modalDesc" style="margin-bottom: 10px; color: #888; font-size: 11px; font-style: italic; line-height: 1.4;"></div>
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px; flex-shrink: 0;">
        <button id="unequipBtn" style="padding: 14px; border-radius: 10px; border: none; color: white; font-weight: bold; cursor: pointer; font-size: 16px; background: #2ecc71; box-shadow: 0 4px 0 #27ae60;">
          è£å‚™ / æ›¿æ›
        </button>
        <button onclick="closeModal()" style="background: rgba(255,255,255,0.05); border: 1px solid #444; color: #aaa; padding: 8px; border-radius: 8px; font-size: 12px; cursor: pointer;">
          è¿”å›èƒŒåŒ…
        </button>
      </div>
    </div>
  </div>
</div>

  <footer class="copyright-notice">
    &copy; 2026 konghua_0206. All Rights Reserved.
  </footer>

</body>

<script src="js/skills.js"></script>
<script src="js/equips_skills.js"></script>
<script src="js/equips_passives.js"></script>
<script src="js/monsters.js"></script>
<script src="js/monsters_dropdown.js"></script>
<script src="js/bosses.js"></script>
<script src="js/equips.js"></script>
<script src="js/code_database.js"></script>

<script>

/** 
 * ============================================================
 * 1. æ ¸å¿ƒæ•¸æ“šå®šç¾©èˆ‡åˆå§‹åŒ–
 * ============================================================
 */

const SAVE_KEY = "magicRPG_v2"; 
const MAX_LEVEL = 100; 
const slotIcons = { head:"ğŸ“", top:"ğŸ‘˜", bottom:"ğŸ‘–", shoes:"ğŸ‘", mainHand:"ğŸ—¡ï¸", offHand:"ğŸ›¡ï¸", necklace:"ğŸ“¿", ring1:"ğŸ’", ring2:"ğŸ’" };

let game; // å…¨åŸŸéŠæˆ²ç‹€æ…‹
let isEditing = false;
let currentInvTab = 'equip';
let battleInterval = null;
let currentMonster = null;
let currentCooldowns = {}; // æ ¼å¼å¦‚: { "fireball": 3, "heal": 0 }

// å®šç¾©ç”¢ç”Ÿåˆå§‹è³‡æ–™çš„å‡½å¼
function getDefaultGameData() {
  return {
    charName: "æœªå‘½åå‹‡è€…", 
    avatarImage: "images/30N8diAK4J1Y928MusBotd.jpg",
    mana: 0, 
    charLv: 1, 
    points: 0, 
    str: 0, agi: 0, luk: 0, int: 0, med: 0, vit: 0, 
    currentHp: 100,
    learnedSkills: [], 
    equippedSkills: [], 
    inventory: [], 
    usedCodes: [], 
    materials: { "å¤è€é¹¿è§’": 0, "å®ˆè­·è€…æ ¸å¿ƒ": 0, "æ·±æ·µéˆé­‚": 0 },
    equipment: { 
      head: null, top: null, bottom: null, shoes: null, 
      mainHand: null, offHand: null, necklace: null, ring1: null, ring2: null 
    }
  };
}

// åˆå§‹åŒ–éŠæˆ²é‚è¼¯
function initGame() {
    const savedData = localStorage.getItem(SAVE_KEY);
    if (savedData) {
        try {
            game = Object.assign(getDefaultGameData(), JSON.parse(savedData));
            console.log("å­˜æª”è¼‰å…¥æˆåŠŸ");
        } catch (e) {
            console.error("å­˜æª”æå£ï¼Œé‡ç½®ç‚ºæ–°éŠæˆ²");
            game = getDefaultGameData();
        }
    } else {
        game = getDefaultGameData();
        console.log("ç„¡å­˜æª”ç´€éŒ„ï¼Œé–‹å•Ÿæ–°éŠæˆ²");
    }
    
    if (typeof renderRegionDropdown === "function") renderRegionDropdown();
    if (typeof updateUI === "function") updateUI(); 
}

// åŸ·è¡Œåˆå§‹åŒ–
initGame();

/**
 * ============================================================
 * 2. æ•¸å€¼é‹ç®—ä¸­å¿ƒ (ä¿®å¾©ç‰ˆï¼šæ”¯æ´è£å‚™é¡å¤–å±¬æ€§)
 * ============================================================
 */

// A. åŸºç¤èˆ‡é¡å¤–å±¬æ€§åŠ ç¸½
function getEquipStats() {
  // åˆå§‹åŒ–æ‰€æœ‰å¯èƒ½å¾è£å‚™ç²å¾—çš„æ•¸å€¼
  let s = { 
    atk: 0, def: 0, hp: 0, 
    str: 0, agi: 0, int: 0, vit: 0, luk: 0, med: 0 
  };
  
  for (let k in game.equipment) { 
    const item = game.equipment[k];
    if (item) { 
      // 1. åŠ ç¸½åŸºç¤ä¸‰å¤§å±¬æ€§
      s.atk += (item.atk || 0);
      s.def += (item.def || 0);
      s.hp  += (item.hp  || 0);
      
      // 2. åŠ ç¸½é¡å¤–å…­åœå±¬æ€§ (è™•ç† generateRandomEquip ç”¢ç”Ÿçš„ extraStats)
      if (item.extraStats) {
        for (let key in item.extraStats) {
          if (s.hasOwnProperty(key)) {
            s[key] += (item.extraStats[key] || 0);
          }
        }
      }
    } 
  }
  return s;
}

// B. è¼”åŠ©å·¥å…·ï¼šå–å¾—ã€Œè§’è‰² + è£å‚™ã€çš„ç¸½å±¬æ€§
function getTotalStat(key) {
  const equip = getEquipStats();
  // ç¢ºä¿ key å­˜åœ¨ï¼Œä¸å­˜åœ¨å‰‡å›å‚³ 0
  const charBase = game[key] || 0;
  const equipBonus = equip[key] || 0;
  return charBase + equipBonus;
}

// C. æ ¸å¿ƒæˆ°é¬¥å…¬å¼ (å¹³è¡¡èª¿æ•´ç‰ˆ)
function getAtk() { 
  const e = getEquipStats();
  // ç®—å¼ï¼š(ç­‰ç´š x 8) + (åŠ›é‡ x 4) + (æ™ºåŠ› x 3) + è£å‚™æ”»æ“Š
  return (game.charLv * 8) + (getTotalStat('str') * 4) + (getTotalStat('int') * 3) + e.atk; 
}

function getDef() { 
  const e = getEquipStats();
  // ç®—å¼ï¼š(ç­‰ç´š x 3) + (é«”è³ª x 3) + (åŠ›é‡ x 0.5) + è£å‚™é˜²ç¦¦
  return (game.charLv * 3) + (getTotalStat('vit') * 3) + (getTotalStat('str') * 0.5) + e.def; 
}

function getMaxHp() {
  const e = getEquipStats();
  // ç®—å¼ï¼š(ç­‰ç´šåŸºç¤ + è£å‚™è¡€é‡) * (1 + é«”è³ª x 5%)
  return Math.floor((100 + game.charLv * 30 + e.hp) * (1 + getTotalStat('vit') * 0.05));
}

// D. æ©Ÿç‡èˆ‡å€ç‡ (é£½å’Œæ›²ç·š)
function getCritRate() {
  const power = (getTotalStat('luk') * 0.4) + (getTotalStat('agi') * 0.1);
  // ç®—å¼ï¼š100 * (1 - 0.992 ^ å¨åŠ›å€¼)
  const rate = 100 * (1 - Math.pow(0.992, power));
  return rate.toFixed(1);
}

function getDodgeRate() {
  const power = (getTotalStat('agi') * 0.5) + (getTotalStat('luk') * 0.1);
  // ç®—å¼ï¼š100 * (1 - 0.985 ^ å¨åŠ›å€¼)ï¼Œæœ€é«˜ 75%
  const rate = 100 * (1 - Math.pow(0.985, power));
  return Math.min(75, rate).toFixed(1);
}

function getCritMultiplier() {
  const baseMulti = 1.5; 
  // ç®—å¼ï¼š1.5 + (å¹¸é‹ x 0.005) + (åŠ›é‡ x 0.002)
  const extraMulti = (getTotalStat('luk') * 0.005) + (getTotalStat('str') * 0.002);
  return parseFloat((baseMulti + extraMulti).toFixed(2));
}

// E. è³‡æºèˆ‡å›è¡€
function manaPerSecond() { 
  // ç®—å¼ï¼š(ç­‰ç´š x 2) * (1 + æ™ºåŠ› x 2% + å†¥æƒ³ x 5%)
  return Math.floor((game.charLv * 2) * (1 + getTotalStat('int') * 0.02 + getTotalStat('med') * 0.05)); 
}

function getHpRegen() {
  // ç®—å¼ï¼š(æœ€å¤§è¡€é‡ x 1%) + (é«”è³ª x 2) + (å†¥æƒ³ x 5)
  return (getMaxHp() * 0.01) + (getTotalStat('vit') * 2) + (getTotalStat('med') * 5);
}

// F. ç¶œåˆæˆ°é¬¥åŒ…
function getCombatStats() {
  return {
    atk: getAtk(),
    def: getDef(),
    maxHp: getMaxHp(),
    critRate: parseFloat(getCritRate()),
    dodgeRate: parseFloat(getDodgeRate()),
    critMulti: getCritMultiplier()
  };
}

/** 
 * ============================================================
 * 3. UI ä»‹é¢é©…å‹•èˆ‡åˆ†é æ§åˆ¶
 * ============================================================
 */

function updateUI() {
  // 0. é å…ˆå–å¾—è£å‚™åŠ æˆæ•¸æ“šèˆ‡ç¸½é«”æˆ°é¬¥æ•¸å€¼
  const e = getEquipStats(); 
  const totalAtk = getAtk();
  const totalDef = getDef();
  const totalCrit = getCritRate();
  const totalDodge = getDodgeRate();

  // --- åŸºç¤è³‡æºèˆ‡ç­‰ç´š ---
  document.getElementById("mana").innerText = Math.floor(game.mana).toLocaleString();
  document.getElementById("mps").innerText = manaPerSecond();
  document.getElementById("charLv").innerText = game.charLv;
  document.getElementById("nameDisplay").innerText = game.charName;
  document.getElementById("charCost").innerText = Math.floor(50 * Math.pow(1.3, game.charLv - 1)).toLocaleString();

  // --- åŸºç¤å±¬æ€§é» (å…­åœ) åŠ ä¸Š (+x) é¡¯ç¤º ---
  const coreAttrs = ['str', 'agi', 'int', 'med', 'vit', 'luk'];
  coreAttrs.forEach(attr => {
    const baseValue = game[attr] || 0;
    const bonusValue = e[attr] || 0;
    document.getElementById(attr).innerText = baseValue;
    // æ›´æ–°ç¶ è‰²åŠ æˆæ–‡å­—
    const bonusEl = document.getElementById(`${attr}-bonus`);
    if (bonusEl) {
      bonusEl.innerText = bonusValue > 0 ? ` (+${bonusValue})` : "";
    }
  });

  // --- æˆ°é¬¥é¢æ¿æ•¸å€¼ (ç¸½å€¼ - è£å‚™åŠ æˆ = åŸºç¤å€¼) ---
  // æ›´æ–°æ”»æ“ŠåŠ›
  const equipAtk = e.atk || 0;
  document.getElementById("atk").innerText = totalAtk - equipAtk;
  document.getElementById("atk-bonus").innerText = equipAtk > 0 ? ` (+${equipAtk})` : "";

  // æ›´æ–°é˜²ç¦¦åŠ›
  const equipDef = e.def || 0;
  document.getElementById("def").innerText = totalDef - equipDef;
  document.getElementById("def-bonus").innerText = equipDef > 0 ? ` (+${equipDef})` : "";

  // æ›´æ–°æš´æ“Š (å‡è¨­ getCritRate å‚³å›çš„æ˜¯æ•¸å­—æˆ–ç™¾åˆ†æ¯”å­—ä¸²)
  const equipCrit = e.critRate || 0;
  document.getElementById("crit").innerText = (parseFloat(totalCrit) - equipCrit).toFixed(1);
  document.getElementById("crit-bonus").innerText = equipCrit > 0 ? ` (+${equipCrit}%)` : "";

  // æ›´æ–°é–ƒé¿
  const equipDodge = e.dodgeRate || 0;
  document.getElementById("dodge").innerText = (parseFloat(totalDodge) - equipDodge).toFixed(1);
  document.getElementById("dodge-bonus").innerText = equipDodge > 0 ? ` (+${equipDodge}%)` : "";

  // --- åŸºç¤å±¬æ€§é» (å‰©é¤˜å¯ç”¨é»æ•¸) ---
  document.getElementById("points").innerText = game.points || 0;

  // --- è¡€é‡æ¢èˆ‡æ•¸å€¼ ---
  const mHp = getMaxHp();
  const curHp = Math.max(0, Math.floor(game.currentHp));
  document.getElementById("hpText").innerText = `${curHp} / ${mHp}`;
  document.getElementById("hpBar").style.width = (curHp / mHp * 100) + "%";
  
  // --- é ­åƒèˆ‡è£å‚™æ§½ä½ ---
  if (game.avatarImage) document.getElementById("avatarImg").src = game.avatarImage;
  renderEquipmentSlots(); 
}

// è¼”åŠ©æ›´æ–°è£å‚™æ§½
function renderEquipmentSlots() {
  for (let sid in slotIcons) {
    const el = document.getElementById(`slot-${sid}`);
    if (!el) continue;

    const item = game.equipment ? game.equipment[sid] : null;

    if (item) {
      // 1. è¨­å®šåŸºç¤ç‹€æ…‹
      el.className = "equip-slot occupied";
      el.style.borderColor = `var(--rarity-${item.rarity})`;
      el.style.display = "flex";
      el.style.alignItems = "center";
      el.style.justifyContent = "center";
      el.style.overflow = "hidden"; // ç¢ºä¿åœ–ç‰‡ä¸è¶…å‡ºæ ¼ç·š

      // 2. åˆ¤æ–· icon é¡å‹ä¸¦åˆ†åˆ¥è¨­å®šå¤§å°
      const isPath = item.icon && (item.icon.includes('/') || item.icon.includes('.'));
      
      if (isPath) {
        // --- æƒ…æ³ A: åœ–ç‰‡è·¯å¾‘ ---
        // åœ–ç‰‡è¨­ç‚º 85% å¯¬åº¦ä»¥ä¿ç•™ä¸€é»é‚Šè·ï¼Œæˆ– 100% å¡«æ»¿
        el.innerHTML = `
          <img src="${item.icon}" 
               style="width: 85%; height: 85%; object-fit: contain; display: block;">`;
      } else {
        // --- æƒ…æ³ B: Emoji ---
        // Emoji å»ºè­°è¨­å®šåœ¨ 24px - 28px ä¹‹é–“ï¼Œè¦–æ‚¨çš„æ ¼å­å¤§å°èª¿æ•´
        el.innerHTML = `
          <span style="font-size: 26px; color: white !important; line-height: 1;">
            ${item.icon || "â“"}
          </span>`;
      }

      el.onclick = () => showEquipDetail(sid);
      el.style.cursor = "pointer";
    } else {
      // --- è‹¥ç„¡è£å‚™ï¼Œæ¢å¾©é è¨­ç‹€æ…‹ ---
      el.className = "equip-slot";
      el.style.borderColor = "";
      // é è¨­åœ–æ¨™å¤§å°ï¼ˆé€šå¸¸è¼ƒæ·¡ã€è¼ƒå°ï¼‰
      el.innerHTML = `<span style="font-size: 20px; opacity: 0.5;">${slotIcons[sid]}</span>`; 
      el.onclick = null;
      el.style.cursor = "default";
    }
  }
}

// åˆ†é åˆ‡æ›é‚è¼¯
function switchPage(p) {
  document.querySelectorAll('.page').forEach(pg => {
    pg.classList.remove('active');
    pg.style.display = 'none';
  });
  
  const target = document.getElementById('page-' + p);
  if (target) {
    target.classList.add('active');
    target.style.display = 'block';
  }

  document.querySelectorAll('.nav-item').forEach(nav => {
    nav.classList.remove('active');
    const clickAttr = nav.getAttribute('onclick');
    if (clickAttr && clickAttr.includes(`'${p}'`)) nav.classList.add('active');
  });

  if (p === 'inventory') renderInventory();
  if (p === 'battle') updateBattleUI();
  if (p === 'skills' && typeof renderSkills === "function") renderSkills();
}

// æŒ‰éˆ•äº‹ä»¶ï¼šé»æ•¸èˆ‡å‡ç´š
function addAttr(a) { if(game.points > 0) { game[a]++; game.points--; updateUI(); saveData(); } }

document.getElementById("upgradeChar").onclick = () => {
  let cost = Math.floor(50 * Math.pow(1.3, game.charLv-1));
  if (game.mana >= cost) { game.mana -= cost; game.charLv++; game.points += 5; updateUI(); saveData(); }
};

// é‡ç½®å±¬æ€§é»æ•¸åŠŸèƒ½
function resetStats() {
  // 1. ç¢ºä¿è®€å–æ•¸å€¼æ™‚ï¼Œè‹¥ä¸å­˜åœ¨å‰‡è¨­ç‚º 0ï¼Œé¿å…å‡ºç¾ NaN
  const totalAllocated = 
    (Number(game.str) || 0) + 
    (Number(game.agi) || 0) + 
    (Number(game.int) || 0) + 
    (Number(game.med) || 0) + 
    (Number(game.vit) || 0) + 
    (Number(game.luk) || 0);
  
  if (totalAllocated <= 0) {
    alert("ç›®å‰å±¬æ€§çš†ç‚ºåˆå§‹å€¼ï¼Œç„¡éœ€é‡ç½®ã€‚");
    return;
  }

  if (confirm(`ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å±¬æ€§é»å—ï¼Ÿ\nå°‡æ­¸é‚„ ${totalAllocated} é»è‡³å¯ç”¨èƒ½åŠ›é»ã€‚`)) {
    // 2. é»æ•¸æ­¸é‚„ (æ³¨æ„è®Šæ•¸åç¨±å¿…é ˆæ˜¯ game.points)
    game.points = (Number(game.points) || 0) + totalAllocated;
    
    // 3. å±¬æ€§ç¢ºå¯¦æ­¸é›¶
    game.str = 0;
    game.agi = 0;
    game.int = 0;
    game.med = 0;
    game.vit = 0;
    game.luk = 0;
    
    // 4. é—œéµä¿®æ­£ï¼šå‘¼å«ä½ æª”æ¡ˆä¸­ç¢ºå¯¦å­˜åœ¨çš„å‡½å¼
    updateUI();       // æ›´æ–°é­”åŠ›èˆ‡é ‚éƒ¨æ•¸å€¼
    saveData();       // ä½ æª”æ¡ˆä¸­çš„å­˜æª”å‡½å¼åç¨±æ˜¯ saveData
    
    // 5. æ‰‹å‹•åˆ·æ–°è§’è‰²é¢æ¿çš„æ–‡å­— (å› ç‚ºä½ æ²’æœ‰ renderCharacter å‡½å¼)
    document.getElementById("points").innerText = game.points;
    document.getElementById("str").innerText = game.str;
    document.getElementById("agi").innerText = game.agi;
    document.getElementById("int").innerText = game.int;
    document.getElementById("med").innerText = game.med;
    document.getElementById("vit").innerText = game.vit;
    document.getElementById("luk").innerText = game.luk;

    alert("å±¬æ€§é‡ç½®æˆåŠŸï¼æ‰€æœ‰é»æ•¸å·²é€€é‚„ã€‚");
  }
}


/** 
 * ============================================================
 * 4. å€‹äººæª”æ¡ˆèˆ‡å­˜æª”ç®¡ç†
 * ============================================================
 */

let canSave = true; 

// çµ±ä¸€å­˜æª”ï¼šæ”¹ç‚ºäº‹ä»¶é©…å‹•ï¼Œä¸¦åŠ å…¥ try-catch ç¢ºä¿ localStorage ç©ºé–“ç•°å¸¸æ™‚ä¸å´©æ½°
function saveData() { 
    if (!canSave) return; 
    try {
        localStorage.setItem(SAVE_KEY, JSON.stringify(game)); 
        if (typeof updateSaveTime === "function") updateSaveTime(); 
    } catch (e) {
        console.error("âŒ å­˜æª”å¤±æ•—:", e);
    }
}

// ç·¨è¼¯æ¨¡å¼ï¼šåˆ‡æ›è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ•ç‹€æ…‹ï¼Œä¸¦åœ¨çµæŸç·¨è¼¯æ™‚åŒæ­¥è³‡æ–™
document.getElementById("editBtn").onclick = function() {
    isEditing = !isEditing;
    const nameDisplay = document.getElementById("nameDisplay");
    const nameInput = document.getElementById("nameInput");
    
    if (isEditing) {
        this.innerText = "ğŸ’¾ å„²å­˜è³‡æ–™";
        nameDisplay.style.display = "none";
        nameInput.style.display = "inline-block";
        nameInput.value = game.charName;
        document.getElementById("avatarInput").click(); // è§¸ç™¼é¸æ“‡åœ–ç‰‡
    } else {
        game.charName = nameInput.value || "æœªå‘½åå‹‡è€…";
        this.innerText = "ğŸ‘¤ ç·¨è¼¯é ­åƒ/ID";
        nameDisplay.style.display = "inline-block";
        nameInput.style.display = "none";
        saveData();
        updateUI();
    }
};

// é ­åƒè™•ç†ï¼šä½¿ç”¨ DataURL å­˜å„²ï¼Œé™åˆ¶ 1MB ä»¥å…è¶…å‡º localStorage ä¸Šé™ (5MB)
document.getElementById("avatarInput").onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
        if (file.size < 1024 * 1024) { 
            const reader = new FileReader();
            reader.onload = ev => { 
                game.avatarImage = ev.target.result; 
                updateUI(); 
                saveData(); 
            };
            reader.readAsDataURL(file);
        } else {
            alert("âŒ åœ–ç‰‡é™ 1MB å…§ï¼Œä»¥å…å­˜æª”å¤±æ•—ï¼");
        }
    }
};

// æ™ºæ…§å­˜æª”ï¼šåµæ¸¬åˆ‡æ›åˆ†é æˆ–é—œé–‰è¦–çª—æ™‚è‡ªå‹•å­˜æª”
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden' && canSave) saveData();
});

window.addEventListener("beforeunload", () => {
    if (canSave) saveData();
});

// å®‰å…¨é‡ç½®ï¼šè¨­å®š canSave ç‚º false é˜²æ­¢ reload ç¬é–“å†æ¬¡å¯«å…¥èˆŠè³‡æ–™
function confirmReset() {
    if (confirm("ğŸš¨ ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰é€²åº¦å—ï¼Ÿ") && confirm("æœ€å¾Œç¢ºèªï¼šçœŸçš„è¦æ¸…ç©ºå—ï¼Ÿ")) {
        canSave = false; 
        localStorage.removeItem(SAVE_KEY);
        alert("âœ¨ æ•¸æ“šå·²æ¸…ç©ºï¼");
        location.reload();
    }
}

// åŒ¯å…¥åŠŸèƒ½ï¼šåŒ…å«åŸºæœ¬çš„æ ¼å¼é©—è­‰ï¼Œé˜²æ­¢æ¯€æè³‡æ–™å¯«å…¥
function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedGame = JSON.parse(e.target.result);
            // åŸºç¤çµæ§‹æª¢æŸ¥
            if (importedGame && typeof importedGame === 'object' && importedGame.charName) {
                canSave = false; 
                game = importedGame;
                localStorage.setItem(SAVE_KEY, JSON.stringify(game));
                alert("ğŸ“‚ å­˜æª”åŒ¯å…¥æˆåŠŸï¼");
                location.reload();
            } else {
                throw new Error("Invalid Format");
            }
        } catch (err) {
            alert("âŒ å¤±æ•—ï¼šå­˜æª”æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼");
            canSave = true;
        }
    };
    reader.readAsText(file);
}

/**
 * ============================================================
 * èƒŒåŒ…èˆ‡è£å‚™ç³»çµ± (Inventory & Equipment System)
 * è² è²¬è£å‚™çš„ç©¿æˆ´ã€å¸ä¸‹ã€è²©è³£èˆ‡åˆ—è¡¨æ¸²æŸ“
 * ============================================================
 */

// é¡¯ç¤ºè£å‚™è©³ç´°å½ˆçª—
function showEquipDetail(source) {
    let targetItem;
    let isEquipped = false;
    let slotId = "";

    // åˆ¤æ–·ä¾†æº
    if (typeof source === 'string') {
        targetItem = game.equipment[source];
        slotId = source;
        isEquipped = true;
    } else {
        targetItem = source;
        slotId = targetItem.type; 
        isEquipped = false;
    }

    if (!targetItem) return;

    // --- è™•ç†å°æ¯”é‚è¼¯ ---
    const compareCard = document.getElementById("compareCard");
    const currentEquipped = game.equipment[slotId];

    if (!isEquipped && currentEquipped && currentEquipped.id !== targetItem.id) {
        compareCard.style.display = "block";
        renderItemToElement(currentEquipped, "comp"); 
        document.getElementById("targetLabel").style.display = "block";
    } else {
        compareCard.style.display = "none";
        document.getElementById("targetLabel").style.display = "none";
    }

    // --- æ¸²æŸ“å³å´ç›®æ¨™ç‰©å“ (åŒ…å«æ“´å±•è©æ¢) ---
    renderItemToElement(targetItem, "modal");
    document.getElementById("itemModal").style.display = "flex";

    // --- æ›´æ–°æŒ‰éˆ• ---
    const btn = document.getElementById("unequipBtn");
    if (isEquipped) {
        btn.innerText = "å¸ä¸‹è£å‚™";
        btn.style.background = "#e74c3c";
        btn.onclick = () => { unequipItem(slotId); closeModal(); };
    } else {
        btn.innerText = "ç©¿ä¸Š / æ›¿æ›";
        btn.style.background = "#2ecc71";
        btn.onclick = () => { equipItem(targetItem.id); closeModal(); };
    }
}


// è¼”åŠ©å‡½å¼ï¼šçµ±ä¸€æ¸²æŸ“è£å‚™å…§å®¹ (æ›´æ–°ç‰ˆï¼šåŒ…å«æŠ€èƒ½ã€è¢«å‹•ã€æè¿°)
function renderItemToElement(item, prefix) {
    const rarityNames = ["æ™®é€š", "ç¨€æœ‰", "å²è©©", "å‚³å¥‡"];
    const translation = { 
        atk: "æ”»æ“Š", def: "é˜²ç¦¦", hp: "è¡€é‡", 
        str: "åŠ›é‡", agi: "æ•æ·", int: "æ™ºåŠ›", 
        vit: "é«”è³ª", luk: "å¹¸é‹", med: "å†¥æƒ³" 
    };

    // åŸºç¤è³‡è¨Šæ¸²æŸ“
    const rarityEl = document.getElementById(`${prefix}Rarity`);
    if (rarityEl) {
        rarityEl.innerText = rarityNames[item.rarity];
        rarityEl.style.color = `var(--rarity-${item.rarity})`;
    }
    
    const nameEl = document.getElementById(`${prefix}Name`);
    if (nameEl) nameEl.innerText = item.name;
    
    // Icon æ¸²æŸ“ï¼šåœ¨å°æ¯”æ¨¡å¼(comp)ä¸‹è‡ªå‹•ç¸®å°ï¼Œç¯€çœç©ºé–“
    const iconEl = document.getElementById(`${prefix}Icon`);
    if (iconEl) {
        const iconSize = (prefix === "comp") ? "64px" : "128px"; // å°æ¯”å¡åœ–æ¨™æ¸›åŠ
        const isImagePath = item.icon && (item.icon.includes('/') || item.icon.includes('.'));
        if (isImagePath) {
            iconEl.innerHTML = `<img src="${item.icon}" style="width: ${iconSize}; height: ${iconSize}; object-fit: contain; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));">`;
        } else {
            iconEl.innerHTML = `<span style="font-size: ${prefix === "comp" ? '30px' : '60px'};">${item.icon || "â“"}</span>`;
        }
    }

    // --- å±¬æ€§ç¶²æ ¼æ¸²æŸ“ ---
    let statsHtml = "";
    const textColor = (prefix === "comp") ? "#bdc3c7" : "#2ecc71";
    
    // åŸºç¤å±¬æ€§ (atk, def, hp)
    ['atk', 'def', 'hp'].forEach(k => { 
        if (item[k]) {
            statsHtml += `<div style="color: ${textColor}; text-align: center;">${translation[k]} +${item[k]}</div>`; 
        }
    });

    // é¡å¤–å…­åœå±¬æ€§
    if (item.extraStats) {
        Object.keys(item.extraStats).forEach(k => { 
            if (item.extraStats[k]) {
                statsHtml += `<div style="color: ${textColor}; text-align: center;">${translation[k] || k} +${item.extraStats[k]}</div>`; 
            }
        });
    }
    document.getElementById(`${prefix}Stats`).innerHTML = statsHtml;

    // --- æŠ€èƒ½åˆ—è¡¨æ¸²æŸ“ (æ–°å¢ï¼šå°æ¯”æ¨¡å¼ä¸‹ç°¡åŒ–é¡¯ç¤º) ---
    const skillsEl = document.getElementById(`${prefix}Skills`);
    if (skillsEl) {
        if (item.skills && Array.isArray(item.skills) && item.skills.length > 0) {
            skillsEl.innerHTML = item.skills.map(sName => {
                const dbInfo = (typeof equipSkillsDB !== 'undefined') ? equipSkillsDB[sName] : null;
                const color = dbInfo ? dbInfo.color : "#a29bfe";
                // å¦‚æœæ˜¯å°æ¯”å¡ï¼Œæ¨™ç±¤ç¨å¾®ç¸®å°
                const fontSize = (prefix === "comp") ? "11px" : "13px";
                return `<div style="color:${color}; margin-top:4px; font-size:${fontSize}; text-align:center;"><b>â˜… æŠ€èƒ½ï¼š</b>${sName}</div>`;
            }).join("");
            skillsEl.style.display = "block";
        } else {
            skillsEl.style.display = "none";
        }
    }

    // --- è¢«å‹•æ•ˆæœæ¸²æŸ“ ---
    const passiveEl = document.getElementById(`${prefix}Passive`);
    if (passiveEl) {
        if (item.passive) {
            passiveEl.innerHTML = `<div style="color: #f1c40f; margin-top:8px; font-size: 12px; border-top: 1px solid rgba(255,255,255,0.1); padding-top:4px; text-align:center;"><b>ğŸ’ è¢«å‹•ï¼š</b>${item.passive}</div>`;
            passiveEl.style.display = "block";
        } else {
            passiveEl.style.display = "none";
        }
    }

    // --- è£å‚™æè¿°æ¸²æŸ“ ---
    const descEl = document.getElementById(`${prefix}Desc`);
    if (descEl) {
        // å°æ¯”æ¨¡å¼ä¸‹é€šå¸¸ä¸é¡¯ç¤ºæè¿°ï¼Œä»¥ç¯€çœç©ºé–“é˜²æ­¢å½ˆçª—éé•·
        if (item.description && prefix !== "comp") {
            descEl.innerHTML = `<div style="color: #888; font-style: italic; margin-top:8px; font-size: 11px; line-height:1.4; text-align:center;">"${item.description}"</div>`;
            descEl.style.display = "block";
        } else {
            descEl.style.display = "none";
        }
    }
}

// å¸ä¸‹è£å‚™é‚è¼¯
function unequipItem(slotId) {
    const item = game.equipment[slotId];
    if (!item) return;

    // ç§»å›èƒŒåŒ…ä¸¦æ¸…ç©ºæ§½ä½
    game.inventory.push(item);
    game.equipment[slotId] = null;
    
    // é—œéµï¼šå…ˆé—œé–‰å½ˆçª—ï¼Œå†æ›´æ–°ä»‹é¢èˆ‡å­˜æª”
    closeModal();
    updateUI(); 
    saveData();
}

// é—œé–‰å½ˆçª—å‡½å¼
function closeModal() {
    const modal = document.getElementById("itemModal");
    if (modal) {
        modal.style.display = "none";
    }
}

// é¡å¤–å»ºè­°ï¼šé»æ“Šå½ˆçª—å¤–éƒ¨é»‘è‰²å€åŸŸä¹Ÿæ‡‰è©²é—œé–‰
window.onclick = function(event) {
    const modal = document.getElementById("itemModal");
    if (event.target == modal) {
        closeModal();
    }
};

// çµ±ä¸€çš„è£å‚™åƒ¹å€¼è¨ˆç®—å…¬å¼
function getEquipValue(item) {
  // 1. å–å¾—ç­‰ç´š (Lv)
  const lvMatch = item.name.match(/\[Lv\.(\d+)\]/);
  const lv = lvMatch ? parseInt(lvMatch[1]) : 1;

  // 2. åƒæ•¸è¨­å®š
  const baseValue = 50;        // åˆå§‹åº•åƒ¹ä¸‹ä¿®ï¼Œè®“å‰æœŸæ•¸å­—æ›´æ¼‚äº®
  const growthRate = 1.08;     // 8% æˆé•·ç‡ï¼Œç¢ºä¿ 80 ç­‰ç™½è£ç´„ç‚º 2~3 è¬
  
  // 3. æ•¸é‡ç´šå€ç‡ (é—œéµä¿®æ”¹ï¼šæ¯éšå·® 10 å€)
  // æ™®é€š: 1x (è¬ç´š), ç¨€æœ‰: 10x (åè¬ç´š), å²è©©: 100x (ç™¾è¬ç´š), å‚³å¥‡: 1000x (åƒè¬ç´š)
  const rarityMults = [1, 10, 100, 1000];
  const rMult = rarityMults[item.rarity] || 1;

  // 4. å±¬æ€§åŠ æˆ (ç¶­æŒå¾®å¹…æº¢åƒ¹)
  let statsMult = 1;
  if (item.extraStats) {
    const statsSum = Object.values(item.extraStats).reduce((a, b) => a + b, 0);
    // æ¯é»å±¬æ€§æä¾› 1% é¡å¤–åƒ¹å€¼ï¼Œé¿å…ç ´å£æ•¸é‡ç´šçµæ§‹
    statsMult = 1 + (statsSum * 0.01);
  }

  // 5. æœ€çµ‚è¨ˆç®—
  // å…¬å¼ï¼šåº•åƒ¹ * (1.08 ^ Lv) * ç¨€æœ‰åº¦å€ç‡ * å±¬æ€§å€ç‡
  const finalValue = Math.floor(
    baseValue * Math.pow(growthRate, lv) * rMult * statsMult
  );

  return finalValue;
}

let pressTimer;

// é–‹å§‹è¨ˆæ™‚é•·æŒ‰
function startPress(item) {
    pressTimer = setTimeout(() => {
        toggleItemLock(item);
    }, 700); // 0.7ç§’è§¸ç™¼é•·æŒ‰
}

// å–æ¶ˆè¨ˆæ™‚ (ç•¶æ»‘é¼ æ”¾é–‹æˆ–ç§»é–‹æ™‚)
function cancelPress() {
    clearTimeout(pressTimer);
}

// åˆ‡æ›é–å®šç‹€æ…‹
function toggleItemLock(item) {
    item.isLocked = !item.isLocked;
    
    // éœ‡å‹•å›é¥‹ (æ”¯æ´è¡Œå‹•è£ç½®)
    if (navigator.vibrate) navigator.vibrate(50);
    
    // ç«‹å³é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é–å®šå°åœ–ç¤º
    renderInventory();
    saveData();
}

// è²©è³£èƒŒåŒ…ç‰©å“
function sellItem(id) {
    const idx = game.inventory.findIndex(i => i.id === id);
    if (idx === -1) return;
    
    const item = game.inventory[idx];

    // --- é—œéµä¿®æ”¹ï¼šæª¢æŸ¥é–å®š ---
    if (item.isLocked) {
        alert(`ğŸ›¡ï¸ [${item.name}] å·²é–å®šï¼Œè«‹å…ˆé•·æŒ‰è£å‚™è§£é–å†è²©å”®ã€‚`);
        return;
    }

    const price = getEquipValue(item);
    
    if (confirm(`ç¢ºå®šè¦è³£æ‰ [${item.name}] å—ï¼Ÿ (åƒ¹å€¼: âœ¨${price})`)) {
        game.mana += price;
        game.inventory.splice(idx, 1);
        renderInventory();
        updateUI();
        saveData();
    }
}

//ä¸€éµè²©å”®åŠŸèƒ½:æ ¹æ“šé¸æ“‡çš„å“è³ªç­‰ç´šï¼Œå°‡èƒŒåŒ…å…§å°æ–¼ç­‰æ–¼è©²ç­‰ç´šçš„è£å‚™å…¨éƒ¨è³£æ‰
function bulkSell() {
    const filterEl = document.getElementById("sellRarityFilter");
    if (!filterEl) return;
    const maxRarity = parseInt(filterEl.value);
    
    // --- é—œéµä¿®æ”¹ï¼šéæ¿¾æ™‚æ’é™¤ isLocked çš„ç‰©å“ ---
    const toSell = game.inventory.filter(item => item.rarity <= maxRarity && !item.isLocked);
    
    if (toSell.length === 0) {
        alert("æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è£å‚™ï¼ˆæˆ–ç¬¦åˆæ¢ä»¶çš„è£å‚™çš†å·²é–å®šï¼‰ã€‚");
        return;
    }

    if (confirm(`ç¢ºå®šè²©å”® ${toSell.length} ä»¶è£å‚™å—ï¼Ÿ (å·²è‡ªå‹•æ’é™¤é–å®šè£å‚™)`)) {
        let totalIncome = 0;
        
        // ä½¿ç”¨æ–°çš„æ¸…å–®è¦†è“‹èˆŠæ¸…å–®ï¼Œä½†ä¿ç•™ã€Œç¨€æœ‰åº¦éé«˜ã€æˆ–ã€Œå·²é–å®šã€çš„ç‰©å“
        game.inventory = game.inventory.filter(item => {
            const isMatchRarity = item.rarity <= maxRarity;
            
            if (isMatchRarity && !item.isLocked) {
                totalIncome += getEquipValue(item);
                return false; // ä¸ä¿ç•™ï¼ŒåŸ·è¡Œè²©å”®
            }
            return true; // ä¿ç•™ï¼ˆå¯èƒ½æ˜¯ç¨€æœ‰åº¦å¤ªé«˜ï¼Œæˆ–æ˜¯è¢«é–å®šäº†ï¼‰
        });

        game.mana += totalIncome;
        alert(`æ‰¹æ¬¡è²©å”®å®Œæˆï¼Œå…±ç²å¾— âœ¨ ${totalIncome}`);
        renderInventory();
        updateUI();
        saveData();
    }
}

let isSellMode = false; // é è¨­ç‚ºè£å‚™æ¨¡å¼

function toggleInvMode() {
    isSellMode = !isSellMode;
    const btn = document.getElementById("invModeBtn");
    
    // æ”¹è®Šåˆ‡æ›éˆ•çš„è¦–è¦º
    if (isSellMode) {
        btn.innerText = "ğŸ”„ æ¨¡å¼ï¼šè²©è³£ä¸­";
        btn.style.color = "#ff4d4d";
        btn.style.borderColor = "#ff4d4d";
        btn.style.background = "rgba(255, 77, 77, 0.1)";
    } else {
        btn.innerText = "ğŸ”„ æ¨¡å¼ï¼šè£å‚™ä¸­";
        btn.style.color = "#aaa";
        btn.style.borderColor = "#444";
        btn.style.background = "rgba(255,255,255,0.05)";
    }
    renderInventory(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
}

// æ¸²æŸ“èƒŒåŒ…å…§å®¹
function renderInventory() {
  const container = document.getElementById("inventoryContainer");
  if (!container) return;
  container.innerHTML = "";

  if (currentInvTab === 'equip') {
    if (game.inventory.length === 0) {
      container.innerHTML = `<div style="text-align:center; padding:40px; color:#555; font-size:14px;">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</div>`;
      return;
    }

    game.inventory.forEach((item) => {
      let div = document.createElement("div");
      div.className = `item-card`;
      div.style.cssText = `display:flex; align-items:center; padding:12px 15px; margin-bottom:8px; border-left:5px solid var(--rarity-${item.rarity}); background: rgba(255,255,255,0.02); border-radius: 12px; position: relative;`;

      // 1. åœ–æ¨™è¨­å®š (44px)
      let iconHtml = "";
      const isPath = item.icon && (item.icon.includes('/') || item.icon.includes('.'));
      const iconStyle = `width:44px; height:44px; object-fit:contain; flex-shrink:0; margin-right:15px;`;
      
      if (isPath) {
        iconHtml = `<img src="${item.icon}" style="${iconStyle}">`;
      } else {
        iconHtml = `<div style="${iconStyle} display:flex; align-items:center; justify-content:center; font-size:26px; background:rgba(255,255,255,0.03); border-radius:10px;">${item.icon || 'âš”ï¸'}</div>`;
      }

      // 2. é–å®šç‹€æ…‹é¡¯ç¤º (å¦‚æœæœ‰é–å®šï¼Œé¡¯ç¤ºä¸€å€‹å°æ›é–)
      const lockHtml = item.isLocked ? `<div style="position:absolute; top:2px; left:2px; background:#f1c40f; color:#000; border-radius:50%; width:18px; height:18px; display:flex; align-items:center; justify-content:center; font-size:10px; z-index:10; box-shadow:0 2px 4px rgba(0,0,0,0.5);">ğŸ”’</div>` : "";

      // 3. æ¨¡å¼æŒ‰éˆ•åˆ¤å®š
      let actionBtn = "";
      if (isSellMode) {
        actionBtn = `<button onclick="sellItem(${item.id})" style="background:#e74c3c; color:white; border:none; padding:10px 18px; border-radius:10px; font-size:13px; cursor:pointer; font-weight:bold; transition: 0.2s; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3); ${item.isLocked ? 'opacity:0.5; filter:grayscale(1); cursor:not-allowed;' : ''}">è²©è³£</button>`;
      } else {
        actionBtn = `<button onclick="equipItem(${item.id})" style="background:#2ecc71; color:white; border:none; padding:10px 18px; border-radius:10px; font-size:13px; cursor:pointer; font-weight:bold; transition: 0.2s; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);">è£å‚™</button>`;
      }

      div.innerHTML = `
        ${lockHtml}
        <div class="item-click-area" style="flex:1; display:flex; align-items:center; cursor:pointer; user-select:none; -webkit-user-select:none;">
          ${iconHtml}
          <div style="color: var(--rarity-${item.rarity}); font-weight:bold; font-size:16px;">${item.name}</div>
        </div>
        <div style="flex-shrink:0; margin-left:10px;">
          ${actionBtn}
        </div>
      `;

      // --- é•·æŒ‰é‚è¼¯ç¶å®š ---
      const clickArea = div.querySelector('.item-click-area');
      
      // é»æ“Šè©³æƒ…
      clickArea.onclick = () => showEquipDetail(item);

      // é•·æŒ‰ç›£æ¸¬ï¼šæ»‘é¼ ç‰ˆ
      clickArea.onmousedown = () => startPress(item);
      clickArea.onmouseup = cancelPress;
      clickArea.onmouseleave = cancelPress;

      // é•·æŒ‰ç›£æ¸¬ï¼šæ‰‹æ©Ÿç‰ˆ
      clickArea.ontouchstart = () => startPress(item);
      clickArea.ontouchend = cancelPress;

      container.appendChild(div);
    });
  } else {
    // ææ–™åˆ†é é‚è¼¯ (ä¿æŒä¸è®Š)
    let hasMaterial = false;
    let materialHtml = "";
    for (let mat in game.materials) {
      if (game.materials[mat] > 0) {
        hasMaterial = true;
        materialHtml += `
          <div class="item-card" style="display:flex; justify-content:space-between; align-items:center; padding:15px; margin-bottom:8px; border-left: 5px solid #555;">
            <span style="font-size:15px;">ğŸ“¦ ${mat}</span>
            <span style="color:var(--primary); font-weight:bold; font-size:16px;">x${game.materials[mat]}</span>
          </div>`;
      }
    }
    container.innerHTML = hasMaterial ? materialHtml : `<div class="small" style="text-align:center; padding:20px; color:#666;">å°šç„¡ä»»ä½•ææ–™...</div>`;
  }
}

// åˆ‡æ›èƒŒåŒ…æ¨™ç±¤
function setInvTab(t) {
  currentInvTab = t;
  const btnEquip = document.getElementById("btnTabEquip");
  const btnMat = document.getElementById("btnTabMat");
  const sellArea = document.getElementById("quickSellArea");

  if (btnEquip) btnEquip.style.background = (t === 'equip') ? '' : '#444';
  if (btnMat) btnMat.style.background = (t === 'material') ? '' : '#444';
  
  // å¢åŠ å®‰å…¨æ€§æª¢æŸ¥ï¼Œé˜²æ­¢ sellArea é‚„æ²’è®€å–åˆ°å°±å ±éŒ¯
  if (sellArea) {
    sellArea.style.display = (t === 'equip') ? 'block' : 'none';
  }
  
  renderInventory();
}

// ç©¿ä¸Šè£å‚™è™•ç† (æœƒèˆ‡ç¾æœ‰è£å‚™æ›¿æ›)
function equipItem(id) {
  const idx = game.inventory.findIndex(i => i.id === id);
  if (idx === -1) return;
  const item = game.inventory[idx];
  
  let targetSlot = item.type;

  // --- æˆ’æŒ‡ç‰¹æ®Šé‚è¼¯ ---
  if (item.type === "ring1" || item.type === "ring2") {
    // å¦‚æœ ring1 æ˜¯ç©ºçš„ï¼Œå°±ç©¿åœ¨ ring1
    if (!game.equipment["ring1"]) {
      targetSlot = "ring1";
    } 
    // å¦‚æœ ring1 æœ‰äººä½† ring2 æ˜¯ç©ºçš„ï¼Œå°±ç©¿åœ¨ ring2
    else if (!game.equipment["ring2"]) {
      targetSlot = "ring2";
    } 
    // å¦‚æœéƒ½æ»¿äº†ï¼Œé è¨­æ›¿æ›æ‰ ring1 (ä½ ä¹Ÿå¯ä»¥æ ¹æ“šéœ€æ±‚æ”¹ç‚ºæ›¿æ› ring2)
    else {
      targetSlot = "ring1";
    }
  }

  // --- åŸ·è¡Œè£å‚™æ›´æ› ---
  // å¦‚æœç›®æ¨™æ§½ä½åŸæœ¬å°±æœ‰è£å‚™ï¼Œå…ˆæŠŠå®ƒè¸¢å›èƒŒåŒ…
  if (game.equipment[targetSlot]) {
    game.inventory.push(game.equipment[targetSlot]);
  }

  // å°‡æ–°è£å‚™æ”¾å…¥ç›®æ¨™æ§½ä½
  game.equipment[targetSlot] = item;
  
  // å¾èƒŒåŒ…ç§»é™¤è©²ç‰©å“
  game.inventory.splice(idx, 1);

  // æ›´æ–°ä»‹é¢èˆ‡å­˜æª”
  if (typeof renderInventory === 'function') renderInventory();
  updateUI();
  saveData();
}

/**
 * ============================================================
 * æŠ€èƒ½ç³»çµ± (Skills System)
 * åŒ…å«ï¼šæŠ€èƒ½ç¿’å¾—ã€ç¶å®šæŠ€èƒ½
 * ============================================================
 */

// åˆå§‹åŒ–ç©å®¶æŠ€èƒ½æ•¸æ“š (æ”¾å…¥ getDefaultGameData)
// game.learnedSkills = ["fireball", "heal", "shield"]; // å‡è¨­é è¨­å…¨å­¸æœƒ
// game.equippedSkills = []; // ç›®å‰è£å‚™ä¸­çš„æŠ€èƒ½ ID

// æ¸²æŸ“æŠ€èƒ½åˆ—è¡¨
function renderSkills() {
  const container = document.getElementById("skillList"); // ç¢ºä¿ ID èˆ‡ HTML å°æ‡‰
  if (!container) return;
  container.innerHTML = "";
  
  allSkills.forEach(skill => {
    const isLearned = game.learnedSkills.includes(skill.id);
    const isEquipped = game.equippedSkills.includes(skill.id);
    
    const div = document.createElement("div");
    div.className = "item-card";
    
    // åŸºæœ¬æ¨£å¼è¨­å®š
    div.style = `
      border-left: 4px solid ${isLearned ? skill.color : '#555'}; 
      display: flex; 
      align-items: center; 
      margin-bottom: 10px; 
      padding: 12px; 
      background: rgba(255,255,255,0.05); 
      border-radius: 8px;
      gap: 12px;
    `;
    
    // --- æŠ€èƒ½è³‡è¨Š HTML æ¨¡æ¿ ---
    let skillContent = "";
    if (isLearned) {
      skillContent = `
        <div style="flex:1;">
          <div style="font-weight:bold; color:${skill.color}">${skill.name} 
            <span style="font-size:10px; color:#aaa;">(æ¶ˆè€—: ${skill.cost}âœ¨ | CD: ${skill.cooldown}s)</span>
          </div>
          <div class="small" style="color:#ccc;">${skill.desc}</div>
        </div>
        <button onclick="toggleSkill('${skill.id}')" style="width:80px; padding:8px; font-size:12px; background:${isEquipped ? '#e74c3c' : 'var(--primary)'}">
          ${isEquipped ? 'å¸ä¸‹' : 'è£å‚™'}
        </button>
      `;
    } else {
      skillContent = `
        <div style="flex:1;">
          <div style="font-weight:bold; color:#888;">${skill.name} (å°šæœªé ˜æ‚Ÿ)</div>
          <div class="small" style="color:#777;">éœ€æ±‚: ${skill.learnCost.toLocaleString()} âœ¨</div>
          <div class="small" style="color:#f1c40f;">ææ–™: ${skill.requireMat}</div>
        </div>
        <button onclick="learnSkill('${skill.id}')" style="width:80px; padding:8px; font-size:12px; background:#2c3e50; border:1px solid #f1c40f; color:#f1c40f;">
          é ˜æ‚Ÿ
        </button>
      `;
    }

    // å°‡åœ–ç¤ºæ’å…¥åˆ°æœ€å‰æ–¹
    div.innerHTML = `
      <div class="skill-icon-box" style="flex-shrink:0;">
        <img src="${skill.icon}" alt="${skill.name}" 
             onerror="this.style.display='none'; this.parentElement.style.background='${skill.color}'; this.parentElement.style.opacity='0.5';"
             style="width:40px; height:40px; border-radius:6px; object-fit:cover; display:block; border:1px solid rgba(255,255,255,0.1);">
      </div>
      ${skillContent}
    `;
    
    container.appendChild(div);
  });
  
  // æ›´æ–°å·²è£å‚™æ•¸é‡é¡¯ç¤º
  const countEl = document.getElementById("activeSkillCount");
  if (countEl) countEl.innerText = game.equippedSkills.length;
}

// é ˜æ‚ŸæŠ€èƒ½é‚è¼¯
function learnSkill(id) {
  const skill = allSkills.find(s => s.id === id);
  if (!skill) return;

  // è§£æ "ç´ æ xæ•¸é‡" çš„è¤‡åˆæ ¼å¼
  const requirements = skill.requireMat.split(',').map(item => {
    const parts = item.trim().split(' x');
    return { name: parts[0], count: parseInt(parts[1]) || 1 };
  });

  const hasMana = game.mana >= skill.learnCost;

 // --- ç²¾ç¢ºæª¢æŸ¥ææ–™ç¼ºå£ä¸¦æº–å‚™å½ˆçª—æ–‡å­— ---
  let missingList = [];
  requirements.forEach(req => {
    const currentOwned = game.materials[req.name] || 0;
    if (currentOwned < req.count) {
      missingList.push(`âŒ ${req.name}ï¼šé‚„å·® ${req.count - currentOwned} å€‹ (ç¾æœ‰: ${currentOwned})`);
    }
  });

  if (!hasMana) { 
    alert(`ã€é­”åŠ›ä¸è¶³ã€‘\né ˜æ‚Ÿéœ€è¦: ${skill.learnCost}\nç›®å‰æ“æœ‰: ${game.mana}`); 
    return; 
  }
  
  if (missingList.length > 0) { 
    // ä½¿ç”¨ alert è§¸ç™¼å¼·åˆ¶å½ˆçª—
    const msg = `é ˜æ‚Ÿã€${skill.name}ã€‘æ‰€éœ€çš„ææ–™ä¸è¶³ï¼š\n\n` + missingList.join('\n') + `\n\nå¿«å»ç‹©çµå°æ‡‰çš„æ€ªç‰©å§ï¼`;
    alert(msg); 
    return; 
  }
  // ----------------------------------

  if (confirm(`ç¢ºå®šæ¶ˆè€— ${skill.learnCost} é­”åŠ›èˆ‡ç›¸é—œææ–™é ˜æ‚Ÿã€${skill.name}ã€‘ï¼Ÿ`)) {
    game.mana -= skill.learnCost;
    // æ‰£é™¤æ‰€æœ‰è¦æ±‚çš„ç´ æ
    requirements.forEach(req => {
      game.materials[req.name] -= req.count;
    });
    game.learnedSkills.push(id);
    renderSkills();
    updateUI();
    saveData();
    showNotification(`æˆåŠŸé ˜æ‚ŸæŠ€èƒ½ï¼š${skill.name}ï¼`);
  }
}

function toggleSkill(id) {
  const index = game.equippedSkills.indexOf(id);
  if (index > -1) {
    game.equippedSkills.splice(index, 1);
  } else {
    if (game.equippedSkills.length >= 3) { // é™åˆ¶æœ€å¤šè£å‚™ 3 å€‹
      alert("æœ€å¤šåªèƒ½è£å‚™ 3 å€‹æŠ€èƒ½ï¼");
      return;
    }
    game.equippedSkills.push(id);
  }
  renderSkills();
  saveData();
}

/**
 * é€²éšé£„æµ®ç‰¹æ•ˆ (è§£æåº¦è‡ªé©æ‡‰)
 * @param {Object} skill - å‚³å…¥æŠ€èƒ½ç‰©ä»¶
 */
function spawnSkillEffect(skill) {
  const container = document.getElementById('battleDisplayArea');
  if (!container || container.offsetParent === null) return;

  const effect = document.createElement('div');
  effect.className = 'skill-popup';
  
  // å¼·åˆ¶è¨­å®šå®¹å™¨å±¤ç´šèˆ‡åŸºç¤æ¨£å¼ï¼Œé¿å…è¢« BOSS æˆ°å®¹å™¨æ¨£å¼å£“ç¸®
  effect.style.position = "absolute";
  effect.style.zIndex = "9999";
  effect.style.pointerEvents = "none";
  effect.style.display = "flex";
  effect.style.alignItems = "center";
  effect.style.justifyContent = "center";

  // --- åˆ¤æ–·æ˜¯åœ–ç‰‡é‚„æ˜¯æ–‡å­— ---
  if (skill.icon.includes('.') || skill.icon.includes('/')) {
    const img = document.createElement('img');
    img.src = skill.icon;
    
    // ã€æ ¸å¿ƒèª¿æ•´ã€‘ä½¿ç”¨ vmin ç¢ºä¿åœ¨ä¸åŒè§£æåº¦ä¸‹è¦–è¦ºå¤§å°ä¸€è‡´
    // 12vmin ä»£è¡¨è¢å¹•çŸ­é‚Šçš„ 12%ï¼Œé€™é€šå¸¸æ˜¯æŠ€èƒ½åœ–ç¤ºæœ€èˆ’æœçš„å¤§å°
    img.style.width = "12vmin";  
    img.style.height = "12vmin";
    img.style.minWidth = "60px"; // è¨­å®šæœ€å°åƒç´ ä¿è­‰ä½éšæ‰‹æ©Ÿä¸æœƒçœ‹ä¸è¦‹
    img.style.minHeight = "60px";
    
    img.style.objectFit = "contain";
    effect.appendChild(img);
  } else {
    // å¦å‰‡ç•¶ä½œ Emoji æ–‡å­—è™•ç†
    effect.innerText = skill.icon || "âœ¨";
    effect.style.color = skill.color;
    effect.style.fontSize = "10vmin"; // Emoji ä¹Ÿè¦å‹•æ…‹å¤§å°
  }

  // å¥—ç”¨ç™¼å…‰æ•ˆæœ (ç™¼å…‰åŠå¾‘ä¹Ÿéš¨è¢å¹•å¤§å°ç¸®æ”¾)
  effect.style.filter = `drop-shadow(0 0 2vmin ${skill.glowColor || skill.color})`;

  // ä½ç½®èˆ‡éš¨æ©Ÿåç§» (åç§»ä¹Ÿä½¿ç”¨ % é¿å…è§£æåº¦ç ´å£)
  const jitterX = (Math.random() - 0.5) * 15; 
  effect.style.left = `calc(50% + ${jitterX}%)`;
  effect.style.top = "40%"; 

  container.appendChild(effect);
  
  // 1.2 ç§’å¾Œç§»é™¤
  setTimeout(() => {
    if (effect.parentNode) effect.remove();
  }, 1200);
}

/**
 * ============================================================
 * 1. ä»‹é¢æ¨¡å¼èˆ‡æ§åˆ¶é …åˆ‡æ›
 * ============================================================
 */

// å€åŸŸèˆ‡æ¨¡å¼è®Šæ•¸
let currentRegion = "æ–°æ‰‹æ£®æ—"; 
let battleMode = 'adventure'; 


// åˆ‡æ›æˆ°é¬¥æ¨¡å¼ (å†’éšª/BOSS)
function toggleBattleMode(mode) {
  if (battleInterval) {
    alert("æˆ°é¬¥ä¸­ç„¡æ³•åˆ‡æ›æ¨¡å¼ï¼");
    return;
  }
  battleMode = mode;
  // åˆ‡æ›å°æ‡‰æ§åˆ¶å€åŸŸçš„é¡¯ç¤º
  document.getElementById("adventureControls").style.display = (mode === 'adventure') ? 'block' : 'none';
  document.getElementById("bossControls").style.display = (mode === 'boss') ? 'block' : 'none';
  
  // æ›´æ–°æŒ‰éˆ•è¦–è¦ºç‹€æ…‹
  document.getElementById("btnModeAdv").style.background = (mode === 'adventure') ? '' : '#444';
  document.getElementById("btnModeBoss").style.background = (mode === 'boss') ? '' : '#444';
  
  if (mode === 'boss') renderBossList();
}

/**
 * ============================================================
 * 2. æ•¸æ“šèˆ‡ç‹€æ…‹æ›´æ–° (HP/Mana/Log)
 * ============================================================
 */

// æ›´æ–°æˆ°é¬¥ç›¸é—œè¡€æ¢èˆ‡æ•¸æ“š UI
function updateBattleUI() {
  const stats = getCombatStats();
  const curHp = Math.max(0, Math.floor(game.currentHp));
  const maxHp = stats.maxHp;

  // æ›´æ–°æˆ°é¬¥é¢æ¿ä¸­çš„ç©å®¶ HP
  const pText = document.getElementById("pBattleHpText");
  const pBar = document.getElementById("pBattleHpBar");
  if (pText) pText.innerText = `${curHp} / ${maxHp}`;
  if (pBar) pBar.style.width = (curHp / maxHp * 100) + "%";

  // æ›´æ–°æ€ªç‰© HP
  if (currentMonster) {
    const mHp = Math.max(0, Math.floor(currentMonster.curHp));
    const mText = document.getElementById("mHpText");
    const mBar = document.getElementById("mHpBar");
    if (mText) mText.innerText = `${mHp} / ${currentMonster.maxHp}`;
    if (mBar) mBar.style.width = (mHp / currentMonster.maxHp * 100) + "%";
  }

  // åŒæ­¥æ›´æ–°ä¸»ä»‹é¢ç‹€æ…‹
  const mainHpText = document.getElementById("hpText");
  const mainHpBar = document.getElementById("hpBar");
  if (mainHpText) mainHpText.innerText = `${curHp} / ${maxHp}`;
  if (mainHpBar) mainHpBar.style.width = (curHp / maxHp * 100) + "%";
  
  const manaEl = document.getElementById("mana");
  if (manaEl) manaEl.innerText = Math.floor(game.mana).toLocaleString();
}

// æ–°å¢æˆ°é¬¥è¨Šæ¯åˆ°æ—¥èªŒ (å¾ä¸Šæ–¹æ’å…¥)
function addBattleLog(msg) {
  const log = document.getElementById("battleLog");
  if (log) {
    const div = document.createElement("div");
    div.innerHTML = msg;
    log.insertBefore(div, log.firstChild);
  }
}

/**
 * ============================================================
 * 3. å‹•æ…‹å…ƒä»¶æ¸²æŸ“ (BOSS åˆ—è¡¨èˆ‡ Buff åœ–ç¤º)
 * ============================================================
 */

// æ¸²æŸ“ BOSS æŒ‘æˆ°åˆ—è¡¨å¡ç‰‡
function renderBossList() {
  const list = document.getElementById("bossList");
  if (!list) return;
  list.innerHTML = "";

  bossData.forEach(boss => {
    const card = document.createElement("div");
    card.style = `
      flex: 0 0 140px; height: 180px; 
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 1px solid #f1c40f; border-radius: 12px; padding: 10px;
      display: flex; flex-direction: column; justify-content: space-between;
      align-items: center; text-align: center; scroll-snap-align: start;
      position: relative; transition: transform 0.2s; cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    `;
    
    card.onmouseover = () => card.style.transform = "translateY(-5px)";
    card.onmouseout = () => card.style.transform = "translateY(0)";
    card.onclick = () => startBossBattle(boss);

    card.innerHTML = `
      <div style="position:absolute; top:-8px; left:10px; background:#f1c40f; color:#000; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; z-index:1;">
        Lv.${boss.lv}
      </div>
      <div style="width: 70px; height: 70px; margin-top: 5px; border-radius: 8px; overflow: hidden; border: 1px solid rgba(241, 196, 15, 0.3);">
        <img src="${boss.img}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://via.placeholder.com/70?text=BOSS'">
      </div>
      <div style="width: 100%;">
        <div style="font-weight: bold; font-size: 13px; color: #fff; margin: 5px 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
          ${boss.name}
        </div>
        <div style="font-size: 10px; color: #f1c40f;">âœ¨ ${boss.rewardMana.toLocaleString()}</div>
      </div>
      <button style="width: 100%; padding: 5px; font-size: 11px; background: #e74c3c; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer;">
        æŒ‘æˆ°
      </button>
    `;
    list.appendChild(card);
  });
}

// æˆ°é¬¥ä¸­æ¸²æŸ“è¢«å‹•æŠ€èƒ½ Buff åœ–ç¤º
function updateBattleBuffs() {
  const container = document.getElementById("battle-buffs");
  if (!container) return;
  container.innerHTML = "";

  const passiveCounts = {}; 

  for (let slot in game.equipment) {
    const item = game.equipment[slot];
    if (!item || !item.name) continue;

    for (let keyword in equipPassivesDB) {
      if (item.name.includes(keyword)) {
        if (!passiveCounts[keyword]) {
          passiveCounts[keyword] = {
            count: 1,
            data: equipPassivesDB[keyword],
            icon: item.icon
          };
        } else {
          passiveCounts[keyword].count++;
        }
      }
    }
  }

  for (let key in passiveCounts) {
    const entry = passiveCounts[key];
    const p = entry.data;
    const buffEl = document.createElement("div");
    buffEl.style.cssText = `
      display: flex; align-items: center; gap: 4px; padding: 2px 8px;
      background: rgba(0,0,0,0.6); border: 1px solid ${p.color};
      border-radius: 4px; color: ${p.color}; font-size: 11px;
    `;

    const isPath = entry.icon && (entry.icon.includes('/') || entry.icon.includes('.'));
    let iconHtml = isPath 
      ? `<img src="${entry.icon}" style="width:16px; height:16px; object-fit:contain;">`
      : `<span style="font-size:14px; line-height:1;">${entry.icon || "âœ¨"}</span>`;

    const countText = entry.count > 1 ? `<b style="margin-left:4px; color:#fff;">x${entry.count}</b>` : "";
    buffEl.innerHTML = `${iconHtml} <span>${p.name}${countText}</span>`;
    container.appendChild(buffEl);
  }
}

/**
 * ============================================================
 * 1. å€åŸŸç®¡ç†èˆ‡æº–å‚™
 * ============================================================
 */

// åˆ‡æ›å†’éšªå€åŸŸé‚è¼¯
function changeRegion(val) {
  if (battleInterval) {
    alert("æˆ°é¬¥ä¸­ç„¡æ³•åˆ‡æ›å€åŸŸï¼");
    // å¼·åˆ¶å°‡ä¸‹æ‹‰é¸å–®é‚„åŸç‚ºç•¶å‰å€åŸŸ
    document.getElementById("regionSelect").value = currentRegion;
    return;
  }
  currentRegion = val;
  document.getElementById("battleStatus").innerText = `å·²æŠµé”ï¼š${currentRegion}`;
}

/**
 * ============================================================
 * 2. æˆ°é¬¥å•Ÿå‹•å…¥å£ (ä¸€èˆ¬å†’éšª)
 * ============================================================
 */

function startBattle() {
  // åŸºæœ¬æ¢ä»¶æª¢æŸ¥ï¼šè‹¥å·²åœ¨æˆ°é¬¥æˆ–é«”åŠ›ç‚º 0 å‰‡ä¸åŸ·è¡Œ
  if (battleInterval || game.currentHp <= 0) return;
  
  // é‡ç½®ç‹€æ…‹æ–‡å­—èˆ‡è¦–è¦º
  document.getElementById("battleStatus").innerText = "";
  document.getElementById("battleStatus").style.color = "#f1c40f"; 

  // 1. éš¨æ©ŸæŠ½é¸ç•¶å‰å€åŸŸæ€ªç‰©
  const areaData = regions[currentRegion];
  const monsterList = areaData.monsters;
  const rand = Math.floor(Math.random() * monsterList.length);
  const selected = monsterList[rand];
  
  // å»ºç«‹ç•¶å‰æˆ°é¬¥æ€ªç‰©ç‰©ä»¶
  currentMonster = { ...selected, maxHp: selected.hp, curHp: selected.hp };

  // 2. åˆå§‹åŒ–æˆ°é¬¥ä»‹é¢å…§å®¹
  document.getElementById("battlePlayerImg").src = document.getElementById("avatarImg").src;
  document.getElementById("playerSideName").innerText = `ã€${document.getElementById("nameDisplay").innerText}ã€‘`;
  document.getElementById("bossImg").src = ""; // ä¸€èˆ¬æˆ°é¬¥ä¸é¡¯ç¤º BOSS å¤§åœ–
  document.getElementById("mName").innerText = `${currentMonster.name} (Lv.${currentMonster.lv})`;

  // 3. åˆ‡æ›å…ƒä»¶é¡¯ç¤ºç‹€æ…‹
  document.getElementById("playerBattleArea").style.display = "block";
  document.getElementById("monsterArea").style.display = "block";
  document.getElementById("vsTitle").style.display = "block";
  document.getElementById("startBattleBtn").style.display = "none";
  document.getElementById("stopBattleBtn").style.display = "block";

  // 4. åŒæ­¥ UI èˆ‡å•Ÿå‹•è¨ˆæ™‚å™¨
  updateBattleUI();
  updateBattleBuffs(); 
  initializeBattle();
  
  battleInterval = setInterval(battleTick, 1000);
}

/**
 * ============================================================
 * 3. æˆ°é¬¥å•Ÿå‹•å…¥å£ (BOSS æŒ‘æˆ°)
 * ============================================================
 */

function startBossBattle(boss) {
  if (game.currentHp <= 0) { 
    alert("é«”åŠ›ä¸è¶³ï¼"); 
    return; 
  }
  
  // éš±è— BOSS åˆ—è¡¨æ§åˆ¶é …ä»¥é˜²å¹²æ“¾ï¼Œä¸¦è¨­ç½®æŒ‘æˆ°ç‹€æ…‹
  document.getElementById("bossControls").style.display = "none";
  document.getElementById("battleStatus").innerText = "";
  document.getElementById("battleStatus").style.color = "#e74c3c"; // BOSS æˆ°ä½¿ç”¨è­¦å‘Šç´…

  // 1. å»ºç«‹ BOSS æˆ°é¬¥è³‡æ–™ (åŠ å…¥ isBoss æ¨™è¨˜)
  currentMonster = { ...boss, maxHp: boss.hp, curHp: boss.hp, isBoss: true };
  
  // 2. æ›´æ–°é ­åƒèˆ‡åç¨±
  document.getElementById("battlePlayerImg").src = document.getElementById("avatarImg").src;
  document.getElementById("playerSideName").innerText = `ã€${document.getElementById("nameDisplay").innerText}ã€‘`;
  document.getElementById("bossImg").src = boss.img;
  document.getElementById("mName").innerText = `ã€BOSSã€‘${currentMonster.name}`;

  // 3. åˆ‡æ›å…ƒä»¶é¡¯ç¤ºç‹€æ…‹
  document.getElementById("playerBattleArea").style.display = "block";
  document.getElementById("monsterArea").style.display = "block";
  document.getElementById("vsTitle").style.display = "block";
  document.getElementById("startBattleBtn").style.display = "none";
  document.getElementById("stopBattleBtn").style.display = "block";
  
  // 4. æ›´æ–° UI èˆ‡å•Ÿå‹•è¨ˆæ™‚å™¨
  updateBattleUI();
  updateBattleBuffs(); 
  initializeBattle();

  battleInterval = setInterval(battleTick, 1000);
}

/**
 * ============================================================
 * æˆ°é¬¥è¨ˆæ™‚å¾ªç’°é‚è¼¯ (Battle Tick)
 * ============================================================
 * 
function battleTick() {
    // 1. å®‰å…¨æª¢æŸ¥ï¼šå¦‚æœæˆ°é¬¥å·²çµæŸæˆ–æ€ªç‰©ä¸å­˜åœ¨ï¼Œç«‹å³æ¸…ç†ä¸¦é€€å‡º
    if (!currentMonster || game.currentHp <= 0 || currentMonster.curHp <= 0) {
        if (battleInterval) {
            clearInterval(battleInterval);
            battleInterval = null;
        }
        return;
    }

    // 2. æ•¸æ“šåŒæ­¥ï¼šç¢ºä¿æˆ°é¬¥ä¸Šä¸‹æ–‡å­˜åœ¨ (å¦‚æœæ„å¤–ä¸Ÿå¤±å‰‡è£œé½Š)
    if (!window.battleContext) {
        window.battleContext = { stats: getCombatStats(), turnCount: 0 };
    }
    window.battleContext.turnCount++;

    // 3. åŸæœ‰é‚è¼¯é©é…ï¼šå†·å»æ™‚é–“è™•ç† (ä¿æŒåŸæœ‰è®Šé‡å)
    if (typeof currentCooldowns === 'undefined') window.currentCooldowns = {};
    for (let skillId in currentCooldowns) {
        if (currentCooldowns[skillId] > 0) currentCooldowns[skillId]--;
    }

    // --- æ ¸å¿ƒé‡æ§‹æ¨¡å¡Šå‘¼å« ---
    
    // åŸ·è¡Œè£å‚™è¢«å‹•èˆ‡ä¸»å‹•æŠ€èƒ½ (è™•ç† dmg, heal, mana)
    processEquipmentActions(); 

    // å†æ¬¡æª¢æŸ¥æ€ªç‰©è¡€é‡ (é˜²æ­¢è£å‚™æŠ€èƒ½ç›´æ¥æ“Šæ®º)
    if (currentMonster.curHp <= 0) {
        finalizeBattle("win");
        return;
    }

    // åŸ·è¡Œç©å®¶è¡Œå‹• (ä¸»å‹•æŠ€èƒ½æˆ–æ™®æ”»)
    processPlayerAction();

    // å†æ¬¡æª¢æŸ¥æ€ªç‰©è¡€é‡
    if (currentMonster.curHp <= 0) {
        finalizeBattle("win");
        return;
    }

    // åŸ·è¡Œæ€ªç‰©è¡Œå‹•èˆ‡ç©å®¶ååˆ¶
    processMonsterAction();

    // åŸ·è¡Œç©å®¶æ­»äº¡æª¢æŸ¥
    if (game.currentHp <= 0) {
        finalizeBattle("lose");
        return;
    }

    // 4. UI çµ±ä¸€æ›´æ–° (èª¿ç”¨ä½ åŸæœ¬çš„å‡½å¼)
    updateBattleUI();
}

/**
 * æˆ°é¬¥çµ‚é»é©é…å™¨
 * ç¢ºä¿èª¿ç”¨ä½ åŸæœ‰çš„ winBattle æˆ– stopBattle
 */
function finalizeBattle(result) {
    if (battleInterval) {
        clearInterval(battleInterval);
        battleInterval = null;
    }

    if (result === "win") {
        currentMonster.curHp = 0;
        updateBattleUI();
        // èª¿ç”¨ä½ åŸæœ‰çš„å‹åˆ©é‚è¼¯ (å«æ‰è½ã€ç¶“é©—è¨ˆç®—)
        if (typeof winBattle === "function") setTimeout(winBattle, 300);
    } else {
        game.currentHp = 0;
        updateBattleUI();
        // èª¿ç”¨ä½ åŸæœ‰çš„å¤±æ•—é‚è¼¯
        if (typeof stopBattle === "function") stopBattle("ä½ è¢«æ‰“æ•—äº†ï¼Œæ’¤é€€å›å®¶...");
    }
}

/**
 * æˆ°é¬¥åˆå§‹åŒ–é‚è¼¯
 * è™•ç†æ‰€æœ‰ã€Œé€²å ´æ™‚ã€è§¸ç™¼çš„æ•ˆæœ
 */
function initializeBattle() {
    if (!currentMonster) return;

    addBattleLog(`<div style="color:#f39c12;">âš”ï¸ èˆ‡ ${currentMonster.name} çš„æˆ°é¬¥é–‹å§‹äº†ï¼</div>`);

    // 1. åˆå§‹åŒ–æˆ°é¬¥ä¸Šä¸‹æ–‡ (Combat Context)
    // å°‡æ‰€æœ‰æˆ°é¬¥ä¸­æœƒè®Šå‹•çš„åŠ æˆæš«å­˜åœ¨é€™è£¡ï¼Œä¸å½±éŸ¿åŸå§‹å­˜æª”æ•¸æ“š
    window.battleContext = {
        stats: getCombatStats(), // åŸºç¤å±¬æ€§è¤‡æœ¬
        buffs: [],               // å­˜æ”¾æˆ°é¬¥ä¸­ç²å¾—çš„å¢ç›Š
        turnCount: 0,
        isFinished: false
    };

    // 2. è™•ç†è£å‚™è¢«å‹•/æŠ€èƒ½çš„å…¥å ´æ•ˆæœ
    processEntryEffects(game.equipment, "equipment");

    // 3. è™•ç†ç©å®¶æŠ€èƒ½çš„å…¥å ´æ•ˆæœ (ä¾‹å¦‚è¢«å‹•æŠ€èƒ½)
    if (game.equippedSkills) {
        processEntryEffects(game.equippedSkills, "skills");
    }

    // 4. æ›´æ–°ä¸€æ¬¡ UIï¼Œç¢ºä¿åŠ æˆå¾Œçš„è¡€é‡/å±¬æ€§æ­£ç¢ºé¡¯ç¤º
    updateBattleUI();
}

/**
 * çµ±ä¸€è™•ç†å…¥å ´æ•ˆæœçš„è¼”åŠ©å‡½å¼
 * @param {Object|Array} sources ä¾†æºå°è±¡ (è£å‚™åˆ—æˆ–æŠ€èƒ½é™£åˆ—)
 * @param {String} type é¡å‹æ¨™è¨˜
 */
function processEntryEffects(sources, type) {
    for (let key in sources) {
        const item = sources[key];
        if (!item) continue;

        // é‚è¼¯ Aï¼šå¦‚æœæ˜¯è£å‚™ï¼Œæª¢æŸ¥å…¶é—œéµå­—å°æ‡‰çš„è¢«å‹•åº«
        if (type === "equipment" && item.name) {
            for (let keyword in equipPassivesDB) {
                if (item.name.includes(keyword)) {
                    const passive = equipPassivesDB[keyword];
                    if (passive.onBattleStart) {
                        executeEntryLogic(passive, "è¢«å‹•", item.name);
                    }
                }
            }
        }
        
        // é‚è¼¯ Bï¼šç›´æ¥æª¢æŸ¥å°è±¡æ˜¯å¦å…§å»º onBattleStart (é©ç”¨æ–¼æŠ€èƒ½æˆ–ç‰¹å®šç‰©ä»¶)
        if (item.onBattleStart) {
            executeEntryLogic(item, "æ•ˆæœ", item.name || item.id);
        }
    }
}

/**
 * åŸ·è¡Œå…·é«”çš„å…¥å ´é‚è¼¯
 */
function executeEntryLogic(effectObj, prefix, sourceName) {
    try {
        // å‚³å…¥ç•¶å‰ä¸Šä¸‹æ–‡ä¾›æ•ˆæœå‡½æ•¸ä¿®æ”¹å±¬æ€§æˆ–åŸ·è¡Œå‹•ä½œ
        const result = effectObj.onBattleStart(window.battleContext, currentMonster);
        
        if (result && result.log) {
            addBattleLog(`<div><span style="color:#9b59b6;">ã€${prefix}ï¼š${sourceName}ã€‘</span> ${result.log}</div>`);
        }
        
        // å¦‚æœæœ‰ç‰¹æ•ˆï¼Œåœ¨æ­¤è§¸ç™¼
        if (effectObj.effectType && typeof spawnSkillEffect === "function") {
            spawnSkillEffect(effectObj);
        }
    } catch (err) {
        console.error(`å…¥å ´æ•ˆæœåŸ·è¡Œå¤±æ•— [${sourceName}]:`, err);
    }
}

/**
 * è™•ç†è£å‚™èˆ‡è¢«å‹•çš„ä¸»å‹•è§¸ç™¼é‚è¼¯
 * åŒ…å«ï¼šå‚·å®³ã€æ¢å¾©ã€è¼”åŠ©(Buff)
 */
function processEquipmentActions() {
    let phaseResults = {
        totalDmg: 0,
        totalHeal: 0,
        manaGain: 0,
        buffsApplied: []
    };

    for (let slot in game.equipment) {
        const item = game.equipment[slot];
        if (!item || !item.skills) continue;

        item.skills.forEach(skillName => {
            const eSkill = (typeof equipSkillsDB !== 'undefined') ? equipSkillsDB[skillName] : null;
            
            // 1. è§¸ç™¼åˆ¤å®š
            if (eSkill && Math.random() < (eSkill.chance || 0)) {
                // 2. åŸ·è¡Œæ•ˆæœä¸¦ç²å–çµæœç‰©ä»¶
                // å‚³å…¥ battleContext ç¢ºä¿è£å‚™èƒ½æ ¹æ“šç•¶å‰æˆ°é¬¥å±¬æ€§è¨ˆç®—
                const result = eSkill.onEffect(window.battleContext.stats, currentMonster);
                
                if (!result) return;

                // 3. æ ¹æ“šæ•ˆæœé¡å‹é€²è¡Œã€Œçµæœç´¯åŠ ã€
                if (result.dmg) phaseResults.totalDmg += Number(result.dmg);
                if (result.heal) phaseResults.totalHeal += Number(result.heal);
                if (result.manaGain) phaseResults.manaGain += Number(result.manaGain);
                
                // 4. è™•ç†è¼”åŠ©é¡æ•ˆæœ (ä¾‹å¦‚å¢åŠ è‡¨æ™‚é˜²ç¦¦ã€æš´æ“Šç­‰)
                if (result.buff) {
                    // å°‡ buff æ¨å…¥ context ä¸­ï¼Œä¾›å¾ŒçºŒç’°ç¯€åˆ¤å®š
                    window.battleContext.buffs.push({
                        name: eSkill.name,
                        effect: result.buff, // ä¾‹å¦‚ { defAdd: 10 }
                        duration: result.duration || 1
                    });
                }

                // 5. çµ±ä¸€æ¸²æŸ“æ—¥èªŒèˆ‡ç‰¹æ•ˆ
                renderActionLog(eSkill, result);
            }
        });
    }

    // 6. çµ±ä¸€çµç®—éšæ®µçµæœ (Settle)
    settlePhaseResults(phaseResults);
}

/**
 * çµç®—å™¨ï¼šçµ±ä¸€è™•ç†æ•¸å€¼è®Šæ›´
 */
function settlePhaseResults(results) {
    // è™•ç†å‚·å®³
    if (results.totalDmg > 0) {
        currentMonster.curHp = Math.max(0, (Number(currentMonster.curHp) || 0) - results.totalDmg);
    }

    // è™•ç†æ²»ç™‚ (ç¢ºä¿ä¸æº¢å‡º)
    if (results.totalHeal > 0) {
        const maxHp = getTotalStat('hp');
        game.currentHp = Math.min(maxHp, (Number(game.currentHp) || 0) + results.totalHeal);
    }

    // è™•ç†è³‡æº
    if (results.manaGain > 0) {
        game.mana = (Number(game.mana) || 0) + results.manaGain;
    }

    updateBattleUI();
}

/**
 * æ ¼å¼åŒ–è¼¸å‡ºè£å‚™å‹•ä½œæ—¥èªŒ
 */
function renderActionLog(config, result) {
    let msg = `<span style="color:${config.color}">ã€è£å‚™æŠ€èƒ½ï¼š${config.name}ã€‘</span> ${result.log || ""}`;
    
    let details = [];
    if (result.dmg > 0) details.push(`é€ æˆ <span style="color:#2ecc71;">${Math.floor(result.dmg)}</span> å‚·å®³`);
    if (result.heal > 0) details.push(`æ¢å¾© <span style="color:#ff7675;">${Math.floor(result.heal)}</span> HP`);
    if (result.manaGain > 0) details.push(`å›è¦† <span style="color:#3498db;">${result.manaGain}</span> MP`);
    
    addBattleLog(`<div>${msg} ${details.join('ï¼Œ')}</div>`);
    
    if (typeof spawnSkillEffect === "function") spawnSkillEffect(config);
}

/**
 * è™•ç†ç©å®¶è¡Œå‹•éšæ®µ
 * å„ªå…ˆç´šï¼šä¸»å‹•æŠ€èƒ½ > æ™®é€šæ”»æ“Š (æ™®æ”»æœƒè§¸ç™¼æ€ªç‰©æŠ€èƒ½åˆ¤å®š)
 */
function processPlayerAction() {
    // 1. æª¢æŸ¥ç©å®¶æ˜¯å¦æœ‰å¯ç”¨çš„ä¸»å‹•æŠ€èƒ½
    const skillToUse = getAvailableSkill();

    if (skillToUse) {
        // --- åŸ·è¡ŒæŠ€èƒ½é‚è¼¯ ---
        executePlayerSkill(skillToUse);
    } else {
        // --- åŸ·è¡Œæ™®é€šæ”»æ“Šé‚è¼¯ (å«æ€ªç‰©ååˆ¶) ---
        executeNormalAttack();
    }
}

/**
 * å°‹æ‰¾ç•¶å‰å¯é‡‹æ”¾çš„æŠ€èƒ½
 */
function getAvailableSkill() {
    if (!game.equippedSkills || game.equippedSkills.length === 0) return null;

    const available = game.equippedSkills
        .map(id => allSkills.find(s => s.id === id))
        .filter(s => s && (currentCooldowns[s.id] || 0) <= 0 && game.mana >= s.cost);

    if (available.length > 0) {
        // éš¨æ©Ÿé¸ä¸€å€‹ç¬¦åˆè§¸ç™¼æ©Ÿç‡çš„æŠ€èƒ½
        const candidate = available[Math.floor(Math.random() * available.length)];
        return (Math.random() < candidate.chance) ? candidate : null;
    }
    return null;
}

/**
 * åŸ·è¡Œç©å®¶ä¸»å‹•æŠ€èƒ½ (å‚·å®³/è¼”åŠ©/æ¢å¾©)
 */
function executePlayerSkill(skill) {
    game.mana -= skill.cost;
    currentCooldowns[skill.id] = skill.cooldown;

    const result = skill.onEffect(window.battleContext.stats, currentMonster);
    
    // æŠ€èƒ½é€šå¸¸å…·æœ‰é«˜å„ªå…ˆç´šï¼Œç›´æ¥çµç®—æ•ˆæœ (ä¸è§¸ç™¼æ€ªç‰©çš„æ™®æ”»ååˆ¶)
    let logMsg = `<span style="color:${skill.color}">ã€${skill.name}ã€‘</span> ${result.log}`;
    addBattleLog(`<div>${logMsg} é€ æˆ <span style="color:#2ecc71;">${Math.floor(result.dmg || 0)}</span> å‚·å®³</div>`);

    // çµç®—æŠ€èƒ½æ•¸å€¼
    if (result.dmg) {
        currentMonster.curHp = Math.max(0, currentMonster.curHp - result.dmg);
    }
    if (result.heal) {
        const maxHp = getTotalStat('hp');
        game.currentHp = Math.min(maxHp, game.currentHp + result.heal);
    }

    if (typeof spawnSkillEffect === "function") spawnSkillEffect(skill);
    updateBattleUI();
}

/**
 * åŸ·è¡Œæ™®é€šæ”»æ“Šé‚è¼¯
 * é€™è£¡åŒ…å«ä½ è¦æ±‚çš„ï¼šåˆ¤æ–·æ˜¯å¦è§¸ç™¼æ€ªç‰©æŠ€èƒ½ååˆ¶
 */
function executeNormalAttack() {
    const stats = window.battleContext.stats;
    let actionLog = `<span style="color:#ccc;">æ™®é€šæ”»æ“Šï¼š</span> `;

    // 1. åˆ¤å®šæ€ªç‰©æ˜¯å¦åœ¨ç©å®¶æ™®æ”»æ™‚è§¸ç™¼æŠ€èƒ½ (ååˆ¶)
    // å‡è¨­æ€ªç‰©æœ‰ 20% æ©Ÿç‡åœ¨ç©å®¶æ™®æ”»æ™‚ã€Œé–ƒé¿ä¸¦åæ“Šã€æˆ–ã€Œç™¼å‹•é˜²ç¦¦æŠ€èƒ½ã€
    const monsterCounterSkill = (currentMonster.skills && Math.random() < 0.2) 
        ? currentMonster.skills[Math.floor(Math.random() * currentMonster.skills.length)] 
        : null;

    if (monsterCounterSkill) {
        // æ€ªç‰©ç™¼å‹•äº†æŠ€èƒ½ååˆ¶ï¼Œç©å®¶æ™®æ”»è¢«ä¸­æ–·æˆ–å—åˆ°å½±éŸ¿
        const mResult = monsterCounterSkill.onEffect(0, stats, currentMonster); // å‚³å…¥ 0 è¡¨ç¤ºé€™æ˜¯ååˆ¶è§¸ç™¼
        addBattleLog(`<div style="color:#e67e22;">âš¡ è­¦å‘Šï¼${currentMonster.name} åœ¨ä½ æ”»æ“Šæ™‚ç™¼å‹•äº† ${mResult.log}</div>`);
        
        // å¦‚æœæ€ªç‰©æŠ€èƒ½å¸¶æœ‰å‚·å®³ï¼Œç›´æ¥æ‰£é™¤ç©å®¶è¡€é‡
        if (mResult.dmg) {
            game.currentHp = Math.max(0, game.currentHp - mResult.dmg);
        }
        return; // æ™®æ”»è¢«ä¸­æ–·
    }

    // 2. æ­£å¸¸çš„æ™®æ”»å‚·å®³è¨ˆç®—
    let baseDmg = Math.max(1, Math.floor((stats.atk * stats.atk) / (stats.atk + currentMonster.def)));
    
    // æš´æ“Šåˆ¤å®š
    const isCrit = Math.random() * 100 < stats.critRate;
    if (isCrit) {
        baseDmg = Math.floor(baseDmg * stats.critMulti);
        actionLog += `<span style="color:#f1c40f; font-weight:bold;">[æš´æ“Š x${stats.critMulti.toFixed(1)}!!] </span>`;
    }

    currentMonster.curHp = Math.max(0, currentMonster.curHp - baseDmg);
    addBattleLog(`<div>${actionLog}é€ æˆ <span style="color: #2ecc71;">${baseDmg}</span> å‚·å®³</div>`);
    updateBattleUI();
}

/**
 * è™•ç†æ€ªç‰©è¡Œå‹•éšæ®µ
 * åŒ…å«ï¼šæ€ªç‰©æŠ€èƒ½/æ™®æ”»ã€ç©å®¶é–ƒé¿åˆ¤å®šã€ç©å®¶è¢«å‹•ååˆ¶
 */
function processMonsterAction() {
    if (currentMonster.curHp <= 0 || window.battleContext.isFinished) return;

    const stats = window.battleContext.stats;
    let finalIncomingDmg = 0;
    let monsterActionLog = "";

    // 1. ç©å®¶é–ƒé¿åˆ¤å®š (æœ€å„ªå…ˆç´š)
    if (Math.random() * 100 < stats.dodgeRate) {
        addBattleLog(`<div style="color: #3498db;">ğŸƒ é–ƒé¿ï¼ä½ è¼•å·§åœ°é¿é–‹äº† ${currentMonster.name} çš„æ”»æ“Š</div>`);
        return; // å®Œå…¨é¿é–‹ï¼Œå¾ŒçºŒé‚è¼¯ä¸åŸ·è¡Œ
    }

    // 2. æ±ºå®šæ€ªç‰©è¡Œç‚ºï¼šæŠ€èƒ½æˆ–æ™®æ”»
    const usedSkill = (currentMonster.skills && currentMonster.skills.length > 0 && Math.random() < 0.25) 
                      ? currentMonster.skills[Math.floor(Math.random() * currentMonster.skills.length)] 
                      : null;

    if (usedSkill) {
        // æ€ªç‰©æŠ€èƒ½é‚è¼¯
        const mAtkData = currentMonster.atkRange || [1, 10];
        const mBaseAtk = Math.floor(Math.random() * (mAtkData[1] - mAtkData[0] + 1)) + mAtkData[0];
        const result = usedSkill.onEffect(mBaseAtk, stats, currentMonster);
        
        finalIncomingDmg = result.dmg || 0;
        monsterActionLog = `<div style="color: ${usedSkill.color || '#f39c12'};">â˜… ${currentMonster.name} ${result.log}</div>`;
        
        if (result.heal > 0) {
            currentMonster.curHp = Math.min(currentMonster.hp, currentMonster.curHp + result.heal);
        }
    } else {
        // æ€ªç‰©æ™®é€šåæ“Š
        const mAtkData = currentMonster.atkRange || [1, 10];
        const mBaseAtk = Math.floor(Math.random() * (mAtkData[1] - mAtkData[0] + 1)) + mAtkData[0];
        finalIncomingDmg = Math.max(1, Math.floor((mBaseAtk * mBaseAtk) / (mBaseAtk + stats.def + 1)));
        monsterActionLog = `<div style="color: #e74c3c;">${currentMonster.name} ç™¼èµ·åæ“Š</div>`;
    }

    // 3. ã€é—œéµï¼šç©å®¶ååˆ¶ç’°ç¯€ã€‘åœ¨å‚·å®³çµç®—å‰åŸ·è¡Œ
    // æˆ‘å€‘æª¢æŸ¥è£å‚™è¢«å‹•ä¸­æ˜¯å¦æœ‰ onBeforeHit (å—æ“Šå‰è§¸ç™¼)
    finalIncomingDmg = processPlayerCounters(finalIncomingDmg);

    // 4. è­·ç›¾æ¸›å‚·è™•ç† (å±¬æ–¼é˜²ç¦¦ç‹€æ…‹)
    if (finalIncomingDmg > 0 && game.shieldTime && Date.now() < game.shieldTime) {
        const reduction = Math.floor(finalIncomingDmg * (game.shieldReduce || 0.3));
        finalIncomingDmg -= reduction;
        monsterActionLog += ` <span style="color:#3498db;">(ğŸ›¡ï¸ è­·ç›¾å¸æ”¶ ${reduction})</span>`;
    }

    // 5. æœ€çµ‚å‚·å®³è½å¯¦
    addBattleLog(monsterActionLog);
    if (finalIncomingDmg > 0) {
        game.currentHp = Math.max(0, (Number(game.currentHp) || 0) - finalIncomingDmg);
        addBattleLog(`<div>é€ æˆäº† <span style="color: #e74c3c;">${Math.floor(finalIncomingDmg)}</span> é»å‚·å®³</div>`);
    }

    updateBattleUI();
}

/**
 * ç©å®¶ååˆ¶è™•ç†å™¨
 * æƒææ‰€æœ‰è¢«å‹•èˆ‡ç‹€æ…‹ï¼Œæ±ºå®šæ˜¯å¦æ¸›å°‘å‚·å®³æˆ–åå½ˆå‚·å®³
 */
function processPlayerCounters(incomingDmg) {
    let currentDmg = incomingDmg;

    for (let slot in game.equipment) {
        const item = game.equipment[slot];
        if (!item || !item.name) continue;

        for (let keyword in equipPassivesDB) {
            if (item.name.includes(keyword)) {
                const p = equipPassivesDB[keyword];
                
                // åŸ·è¡Œå—æ“Šå‰çš„ååˆ¶é‚è¼¯
                if (p.onBeforeHit && Math.random() < (p.chance || 1)) {
                    const counterResult = p.onBeforeHit(currentMonster, currentDmg);
                    if (counterResult) {
                        if (counterResult.log) addBattleLog(counterResult.log);
                        if (counterResult.reduceDmg) currentDmg -= counterResult.reduceDmg;
                        if (counterResult.reflectDmg) {
                            currentMonster.curHp = Math.max(0, currentMonster.curHp - counterResult.reflectDmg);
                            addBattleLog(`<div>ğŸ’¥ åå½ˆé€ æˆ ${Math.floor(counterResult.reflectDmg)} é»å‚·å®³ï¼</div>`);
                        }
                    }
                }
            }
        }
    }
    return Math.max(0, currentDmg);
}



 * ============================================================
 * 1. å‹åˆ©çµç®—ç³»çµ± (Reward & Drops)
 * ============================================================
 */
function winBattle() {
  if (!currentMonster) return;

  const isBossBattle = currentMonster.isBoss === true;
  const monsterName = currentMonster.name;
  const log = document.getElementById("battleLog");

  // --- A. åŸºç¤çå‹µï¼šé­”åŠ›èˆ‡ææ–™ ---
  let dropItemName = currentMonster.dropMat || "æœªçŸ¥ææ–™";
  game.materials[dropItemName] = (game.materials[dropItemName] || 0) + 1;

  // æ ¹æ“šç­‰ç´šèˆ‡æ˜¯å¦ç‚º BOSS è¨ˆç®—é­”åŠ›çå‹µ
  let rewardMana = isBossBattle 
    ? Math.floor(2000 * Math.pow(1.114, currentMonster.lv)) 
    : Math.floor(250 * Math.pow(1.114, currentMonster.lv));
  game.mana += rewardMana;

  // --- B. è£å‚™æ‰è½åˆ¤å®š ---
  let dropMsgs = [];

  if (isBossBattle) {
    // BOSS å°ˆå±¬æ‰è½ (åŸ·è¡Œ onDeath)
    if (typeof currentMonster.onDeath === 'function') {
      try {
        const specialDrops = currentMonster.onDeath(currentMonster);
        if (Array.isArray(specialDrops)) {
          specialDrops.forEach(item => {
            if (item) {
              game.inventory.push(item);
              dropMsgs.push(`<span style="color: var(--rarity-${item.rarity})">[${item.name}]</span>`);
            }
          });
        }
      } catch (e) { console.error("Boss æ‰è½åŸ·è¡Œå‡ºéŒ¯:", e); }
    } 
    
    // BOSS è£œåº•æ©Ÿåˆ¶ï¼šè‹¥æ²’ä¸­å°ˆå±¬ï¼Œ30% æ©Ÿç‡ç²å¾—ä¿åº•ç¶ è£ä»¥ä¸Šçš„éš¨æ©Ÿè£å‚™
    if (dropMsgs.length === 0 && Math.random() < 0.3) {
      const fallback = generateRandomEquip(currentMonster.lv);
      if (fallback) {
        if (fallback.rarity < 1) fallback.rarity = 1; 
        game.inventory.push(fallback);
        dropMsgs.push(`<span style="color: var(--rarity-${fallback.rarity})">[${fallback.name}]</span>`);
      }
    }
  } else {
    // æ™®é€šæ€ªæ‰è½åˆ¤å®š (30% æ©Ÿç‡)
    if (Math.random() < 0.3) {
      const commonEquip = generateRandomEquip(currentMonster.lv);
      if (commonEquip) {
        game.inventory.push(commonEquip);
        dropMsgs.push(`<span style="color: var(--rarity-${commonEquip.rarity})">[${commonEquip.name}]</span>`);
      }
    }
  }

  // --- C. UI æ—¥èªŒèˆ‡è¦–è¦ºåé¥‹ ---
  let equipMsg = dropMsgs.length > 0 ? ` ä¸¦ç²å¾—äº† ${dropMsgs.join("ã€")}` : "";

  if (log) {
    if (isBossBattle) {
      log.innerHTML = `<div style="color: #f1c40f; font-weight: bold; border: 1px solid #f1c40f; padding: 10px; border-radius: 8px; margin: 5px 0; background: rgba(241, 196, 15, 0.1);">ğŸ† å‚³å¥‡è¨ä¼æˆåŠŸï¼æ“Šæ•—äº† ${monsterName}<br>çå‹µï¼š${rewardMana.toLocaleString()} âœ¨ã€${dropItemName}${equipMsg}</div>` + log.innerHTML;
    } else {
      log.innerHTML = `<div style="color: #3498db; margin: 3px 0; padding-left: 5px; border-left: 3px solid #3498db;">å‹åˆ©ï¼ç²å¾— ${rewardMana.toLocaleString()} âœ¨ã€${dropItemName}${equipMsg}</div>` + log.innerHTML;
    }
  }

  // --- D. å­˜æª”èˆ‡å¾ŒçºŒè¡Œç‚º ---
  document.getElementById("battleStatus").innerText = isBossBattle ? `é¦–é ˜æŒ‘æˆ°æˆåŠŸï¼` : `å‹åˆ©ï¼ç²å¾—çå‹µ...`;
  saveData();
  renderInventory(); 

  if (isBossBattle) {
    stopBattle(`æˆåŠŸæ“Šæ•—äº†é¦–é ˜ ${monsterName}ï¼`);
  } else {
    currentMonster = null;
    // å»¶é²ä¸€æ®µæ™‚é–“å¾Œè‡ªå‹•é€²å…¥ä¸‹ä¸€å ´æˆ°é¬¥
    setTimeout(() => {
      if (game.currentHp > 0) {
        startBattle(); 
      } else {
        stopBattle("é«”åŠ›ä¸è¶³ï¼Œè‡ªå‹•æˆ°é¬¥åœæ­¢");
      }
    }, 1200); 
  }
}

/**
 * ============================================================
 * 2. çµ‚æ­¢æˆ°é¬¥èˆ‡ä»‹é¢å¾©åŸ (Stop & Cleanup)
 * ============================================================
 */
function stopBattle(reason = "æˆ°é¬¥åœæ­¢") {
  // 1. åœæ­¢è¨ˆæ™‚å™¨
  if (battleInterval) { 
    clearInterval(battleInterval); 
    battleInterval = null; 
  }
  currentMonster = null;

  // 2. éš±è—æˆ°é¬¥å°ˆå±¬å…ƒä»¶
  document.getElementById("playerBattleArea").style.display = "none";
  document.getElementById("monsterArea").style.display = "none";
  document.getElementById("vsTitle").style.display = "none";
  
  // 3. æ¢å¾© BOSS åˆ—è¡¨é¡¯ç¤º (å¦‚æœåœ¨ BOSS æ¨¡å¼)
  if (typeof battleMode !== 'undefined' && battleMode === 'boss') {
    document.getElementById("bossControls").style.display = "block";
  }

  // 4. åˆ‡æ›æŒ‰éˆ•ç‹€æ…‹
  document.getElementById("startBattleBtn").style.display = "block";
  document.getElementById("stopBattleBtn").style.display = "none";

  // 5. æ¸…ç©ºè¢«å‹•æŠ€èƒ½åœ–æ¨™ (è§£æ±ºæ¨™ç±¤æ®˜ç•™å•é¡Œ)
  const buffContainer = document.getElementById("battle-buffs");
  if (buffContainer) {
    buffContainer.innerHTML = ""; 
  }

  // 6. åˆ·æ–°ç‹€æ…‹æ¨™ç±¤ (ä¿æŒåŸæœ¬çš„é»ƒè‰²èˆ‡é‚è¼¯)
  const statusEl = document.getElementById("battleStatus");
  if (statusEl) {
    statusEl.innerText = reason; 
    statusEl.style.color = "#f1c40f"; // ä¿æŒä½ åŸæœ¬çš„é»ƒè‰²
  }
  
  // 7. æ›´æ–°å…¨åŸŸ UI
  updateUI();
}


/**
 * ============================================================
 * é€²éšéš¨æ©Ÿè£å‚™ç”Ÿæˆå™¨ (Advanced Equipment Generator)
 * ============================================================
 */
function generateRandomEquip(lv) {
  try {
    // ===== 1. å…§éƒ¨åŸºç¤é…ç½®èˆ‡è³‡æºåº« =====
    const types = ["head", "top", "bottom", "shoes", "mainHand", "offHand", "necklace", "ring1"];
    const rarityNames = ["æ™®é€š", "ç¨€æœ‰", "å²è©©", "å‚³å¥‡"];
    const internalIcons = {
      head: "ğŸ“", top: "ğŸ‘•", bottom: "ğŸ‘–", shoes: "ğŸ‘Ÿ",
      mainHand: "âš”ï¸", offHand: "ğŸ›¡ï¸", necklace: "ğŸ“¿", ring1: "ğŸ’"
    };
    const internalNames = {
      head: ["é ­ç›”", "æˆ°ç›”", "æ³•å¸½"], top: ["èƒ¸ç”²", "é•·è¢", "é–å­ç”²"],
      bottom: ["è­·è…¿", "æˆ°è¤²", "è£™è¡£"], shoes: ["é•·é´", "æˆ°é´", "è¼•éˆé´"],
      mainHand: ["é•·åŠ", "æ³•æ–", "æˆ°éŒ˜"], offHand: ["ç›¾ç‰Œ", "å’’æ–‡æ›¸", "è­·è…•"],
      necklace: ["é ¸é£¾", "è­·èº«ç¬¦", "é …éŠ"], ring1: ["æˆ’æŒ‡", "æŒ‡ç’°", "åˆ»å°æˆ’"]
    };
    const prefixes = {
      0: ["ç”Ÿé½çš„", "ç ´æçš„", "ç²—ç³™çš„", "æ™®é€šçš„", "è€èˆŠçš„"],
      1: ["ç²¾è‰¯çš„", "å¼·åŒ–å‹", "å£«å…µçš„", "ç£¨ç·´éçš„", "é‹’åˆ©çš„", "å …å›ºçš„"],
      2: ["æ¥µè‡´çš„", "å¤§å¸«ç´š", "å®ˆè­·è€…", "éˆé­‚ä¹‹", "è‹±å‹‡çš„", "ä¸æœ½çš„"],
      3: ["ç¥è–çš„", "æ»…ä¸–ä¹‹", "ä¸Šå¤éºç•™", "è«¸ç¥çš„", "æœ«æ—¥å’†å“®", "è™›ç©ºä¹‹æº"]
    };

    const prefixBonusData = {
      "ç”Ÿé½çš„": { atk: -1 * Math.floor(lv * 0.1) }, 
      "ç²¾è‰¯çš„": { hp: Math.floor(lv * 2.0) }, 
      "å¼·åŒ–å‹": { def: Math.floor(lv * 0.5) }, 
      "é‹’åˆ©çš„": { atk: Math.floor(lv * 0.8) },
      "å …å›ºçš„": { def: Math.floor(lv * 0.8) }, 
      "æ¥µè‡´çš„": { atk: Math.floor(lv * 1.5), str: Math.floor(lv * 0.2) },
      "å¤§å¸«ç´š": { str: Math.floor(lv * 0.3), int: Math.floor(lv * 0.3), agi: Math.floor(lv * 0.3) }, 
      "å®ˆè­·è€…": { def: Math.floor(lv * 1.2), vit: Math.floor(lv * 0.4) },
      "ä¸æœ½çš„": { hp: Math.floor(lv * 8.0), vit: Math.floor(lv * 0.5) }, 
      "ç¥è–çš„": { all: Math.floor(lv * 0.4) }, 
      "æ»…ä¸–ä¹‹": { atk: Math.floor(lv * 2.5), luk: Math.floor(lv * 0.2) }, 
      "è«¸ç¥çš„": { str: Math.floor(lv * 0.5), int: Math.floor(lv * 0.5), med: Math.floor(lv * 0.5) }, 
      "ä¸Šå¤éºç•™": { hp: Math.floor(lv * 10.0), def: Math.floor(lv * 1.5) }
    };

    // ===== 2. éš¨æ©ŸæŠ½å–ç¨€æœ‰åº¦ã€éƒ¨ä½èˆ‡åç¨± =====
    const type = types[Math.floor(Math.random() * types.length)];
    const roll = Math.random();
    let r = 0;
    if (roll < 0.01) r = 3;
    else if (roll < 0.06) r = 2;
    else if (roll < 0.31) r = 1;

    const pList = prefixes[r];
    const selectedPrefix = pList[Math.floor(Math.random() * pList.length)];
    const selectedBaseName = internalNames[type][Math.floor(Math.random() * internalNames[type].length)];

    // ===== 3. Budget é ç®—åˆ†é…ç³»çµ± =====
    const budgetFactor = 1.2; 
    const rarityFactor = [1.0, 1.5, 2.2, 3.2];
    let budget = lv * budgetFactor * rarityFactor[r];

    const statCost = {
      atk: 2.0, def: 1.8, hp: 0.4,
      str: 1.0, agi: 1.0, int: 1.0,
      vit: 1.0, luk: 0.9, med: 0.8
    };

    // é€™è£¡ç¶­æŒåŸæœ‰çš„ bias
    const bias = {
      mainHand: { atk: 0.45, str: 0.25, int: 0.25 },
      offHand: { def: 0.35, vit: 0.35 },
      top: { def: 0.4, hp: 0.3, vit: 0.2 },
      bottom: { def: 0.35, hp: 0.35 },
      necklace: { hp: 0.3, med: 0.35, luk: 0.2 },
      ring1: { str: 0.3, agi: 0.3, int: 0.3 },
      shoes: { agi: 0.4, hp: 0.3 },
      head: { hp: 0.3, int: 0.3 }
    }[type] || { hp: 0.5, str: 0.5 };

    let stats = { atk: 0, def: 0, hp: 0 };
    let extraStats = { str: 0, agi: 0, int: 0, vit: 0, luk: 0, med: 0 };

    // === æ–°å¢ï¼šæ ¹æ“šç¨€æœ‰åº¦é™åˆ¶å‰¯å±¬æ€§æ¢ç›®æ•¸é‡ ===
    // r=0(1æ¢), r=1(2æ¢), r=2(4æ¢), r=3(6æ¢)
    const slotCounts = [1, 2, 4, 6];
    const maxSlots = slotCounts[r];
    const allExtraKeys = Object.keys(extraStats);
    // éš¨æ©ŸæŒ‘é¸å‡ºæœ¬æ¬¡è£å‚™å¯ä»¥æ“æœ‰çš„å‰¯å±¬æ€§ key
    const allowedExtraKeys = allExtraKeys
      .sort(() => Math.random() - 0.5)
      .slice(0, maxSlots);

    // åŸºç¤åˆ†é…ï¼šåªåˆ†é…çµ¦å…è¨±çš„ key
    for (let key in bias) {
      const share = budget * bias[key];
      const value = Math.floor(share / (statCost[key] || 1));
      
      if (stats.hasOwnProperty(key)) {
        stats[key] += value;
      } else if (allowedExtraKeys.includes(key)) {
        extraStats[key] += value;
      }
      // æ³¨æ„ï¼šå¦‚æœ key ä¸åœ¨ allowed å…§ï¼Œé ç®—æœƒç•™çµ¦å¾Œé¢çš„è£œå¼·æ­¥é©Ÿ
      budget -= share;
    }

    // å‰©é¤˜é ç®—éš¨æ©Ÿè£œå¼·ï¼šåš´æ ¼é™åˆ¶åœ¨ allowedExtraKeys å…§
    while (budget > 1) {
      const k = allowedExtraKeys[Math.floor(Math.random() * allowedExtraKeys.length)];
      if (budget >= statCost[k]) {
        extraStats[k] += 1;
        budget -= statCost[k];
      } else break;
    }

    // ===== 4. Prefix è©ç¶´ç³»çµ±æ³¨å…¥ =====
    const bonus = prefixBonusData[selectedPrefix];
    if (bonus) {
      for (let key in bonus) {
        if (key === 'all') {
          // 'all' å±¬æ–¼ç‰¹æ®ŠåŠ æˆï¼Œé€šå¸¸ä¸è¨ˆå…¥æ¢ç›®é™åˆ¶ï¼Œæˆ–åªåŠ åœ¨å·²æœ‰æ¢ç›®ä¸Š
          // é€™è£¡ä¾ç…§ä½ åŸå§‹é‚è¼¯ï¼Œå…¨å±¬æ€§ç›´æ¥æ³¨å…¥
          for (let s in extraStats) extraStats[s] += Math.floor(lv * 0.4);
        } else if (stats.hasOwnProperty(key)) {
          stats[key] += bonus[key];
        } else if (extraStats.hasOwnProperty(key)) {
          // å¦‚æœè©ç¶´åŠ äº†åŸæœ¬æ²’é–‹çš„æ§½ä½ï¼Œç›´æ¥åŠ ä¸Šå» (è¦–ç‚ºè©ç¶´çš„é¡å¤–çå‹µ)
          extraStats[key] += bonus[key];
        }
      }
    }

    return {
      id: Date.now() + Math.random(),
      type: type,
      rarity: r,
      name: `[Lv.${lv}] ${rarityNames[r]} Â· ${selectedPrefix}${selectedBaseName}`,
      atk: Math.max(0, stats.atk),
      def: Math.max(0, stats.def),
      hp: Math.max(0, stats.hp),
      extraStats: extraStats,
      icon: internalIcons[type] || "â“"
    };

  } catch (error) {
    console.error("ç”ŸæˆéŒ¯èª¤:", error);
    return null;
  }
}
/**
 * ============================================================
 * è¨‚è£½è£å‚™ç”Ÿæˆå™¨ (Advanced Equipment Generator)
 * ============================================================
 */

function createUniqueItem(templateId, lv = 1) {
  const template = uniqueItemTemplates[templateId];
  if (!template) return null;

  let newItem = JSON.parse(JSON.stringify(template));
  newItem.id = Date.now() + Math.random();
  newItem.lv = lv;
  newItem.templateId = templateId;
  
  // åˆå§‹åŒ–å‰¯å±¬æ€§ï¼Œé¿å… UI æ¸²æŸ“å¡æ­»
  newItem.extraStats = newItem.extraStats || { str: 0, agi: 0, int: 0, vit: 0, luk: 0, med: 0 };

  // ===== 1. åŒæ­¥å¾Œçš„è©ç¶´å¼·åº¦ (èˆ‡éš¨æ©Ÿè£å‚™ä¸€è‡´çš„ 0.x~2.x ä¿‚æ•¸) =====
  const prefixBonus = {
    // ç¨€æœ‰ (1) ç´šåˆ¥
    "ç²¾éŠçš„": { atk: Math.floor(lv * 0.5) }, 
    "å“è¶Šä¹‹": { hp: Math.floor(lv * 4.0) }, 
    "æ´—éŠçš„": { def: Math.floor(lv * 0.5) },
    "å …å›ºçš„": { def: Math.floor(lv * 0.8) }, 
    "é‹’åˆ©çš„": { atk: Math.floor(lv * 0.8) },

    // å²è©© (2) ç´šåˆ¥
    "æ¥µè‡´çš„": { atk: Math.floor(lv * 1.5), luk: Math.floor(lv * 0.1) }, 
    "å¤§å¸«ç´š": { str: Math.floor(lv * 0.3), agi: Math.floor(lv * 0.3) }, 
    "å®ˆè­·è€…": { def: Math.floor(lv * 1.2), vit: Math.floor(lv * 0.3) }, 
    "ä¸æœ½çš„": { hp: Math.floor(lv * 8.0), med: Math.floor(lv * 0.2) },

    // å‚³å¥‡ (3) ç´šåˆ¥
    "ç¥è–çš„": { all: Math.floor(lv * 0.4) }, 
    "è«¸ç¥çš„": { str: Math.floor(lv * 0.5), int: Math.floor(lv * 0.5), med: Math.floor(lv * 0.5) },
    "æ»…ä¸–ä¹‹": { atk: Math.floor(lv * 2.5), luk: Math.floor(lv * 0.2) }, 
    "ä¸Šå¤éºç•™": { hp: Math.floor(lv * 10.0), def: Math.floor(lv * 1.5) },
    
    // æ™®é€š (0) ç´šåˆ¥
    "ç‰¹è£½çš„": { hp: Math.floor(lv * 1.5) },
    "å·¥åŒ çš„": { def: Math.floor(lv * 0.2) },
    "æ”¹è‰¯å‹": { atk: Math.floor(lv * 0.2) }
  };

  const rarityPrefixes = {
    0: ["ç‰¹è£½çš„", "å·¥åŒ çš„", "æ”¹è‰¯å‹"],
    1: ["ç²¾éŠçš„", "å“è¶Šä¹‹", "æ´—éŠçš„", "å …å›ºçš„", "é‹’åˆ©çš„"],
    2: ["æ¥µè‡´çš„", "å¤§å¸«ç´š", "å®ˆè­·è€…", "ä¸æœ½çš„"],
    3: ["ç¥è–çš„", "è«¸ç¥çš„", "æ»…ä¸–ä¹‹", "ä¸Šå¤éºç•™"]
  };

  // ===== 2. éš¨æ©Ÿé¸å–è©ç¶´ =====
  const r = newItem.rarity || 0;
  const pList = rarityPrefixes[r] || rarityPrefixes[0];
  const randomPrefix = pList[Math.floor(Math.random() * pList.length)];
  
  // ===== 3. æ³¨å…¥è©ç¶´åŠ æˆ =====
  const bonus = prefixBonus[randomPrefix];
  if (bonus) {
    for (let key in bonus) {
      if (key === 'all') {
        ['str', 'agi', 'int', 'vit', 'luk', 'med'].forEach(s => {
          newItem.extraStats[s] = (newItem.extraStats[s] || 0) + Math.floor(lv * 0.4);
        });
      } else if (['atk', 'def', 'hp'].includes(key)) {
        newItem[key] = (newItem[key] || 0) + bonus[key];
      } else {
        newItem.extraStats[key] = (newItem.extraStats[key] || 0) + bonus[key];
      }
    }
  }

  // ===== 4. è™•ç†åç¨±çµ„åˆ =====
  const rarityNames = ["æ™®é€š", "ç¨€æœ‰", "å²è©©", "å‚³å¥‡"];
  newItem.name = `[Lv.${lv}] ${rarityNames[r]} Â· ${randomPrefix}${template.name.trim()}`;

  // ===== 5. è™•ç†æ¨¡æ¿åŸæœ‰çš„ç¯„åœæ•¸å€¼ (Ranges) =====
  if (newItem.ranges) {
    const getRandomValue = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    for (let stat in newItem.ranges) {
      const val = newItem.ranges[stat];
      let rolledVal = Array.isArray(val) ? getRandomValue(val[0], val[1]) : (val || 0);
      
      if (['atk', 'def', 'hp'].includes(stat)) {
        newItem[stat] = (newItem[stat] || 0) + rolledVal;
      } else {
        newItem.extraStats[stat] = (newItem.extraStats[stat] || 0) + rolledVal;
      }
    }
    delete newItem.ranges; // æ¸²æŸ“å‰æ¸…é™¤ç¯„åœå®šç¾©
  }

  return newItem;
}

/**
 * ============================================================
 * å…Œæ›ç¢¼ç³»çµ±
 * ============================================================
 */
function processExchange() {
  const inputCode = document.getElementById("exchangeInput").value.trim().toUpperCase();
  const hintEl = document.getElementById("exchangeHint");
  const data = exchangeCodesDB[inputCode];

  // --- 1. æª¢æŸ¥åºè™Ÿæ˜¯å¦å­˜åœ¨ ---
  if (!data) {
    hintEl.innerHTML = "âŒ åºè™ŸéŒ¯èª¤æˆ–å·²éæœŸ";
    return;
  }

  // --- 2. æª¢æŸ¥æ˜¯å¦å·²ç¶“å…Œæ›é (æ–°å¢é™åˆ¶) ---
  if (game.usedCodes && game.usedCodes.includes(inputCode)) {
    hintEl.innerHTML = "âŒ æ­¤åºè™Ÿå·²ç¶“å…Œæ›éå›‰ï¼";
    return;
  }

  // --- 3. æª¢æŸ¥èƒŒåŒ…ç´ ææ˜¯å¦è¶³å¤  ---
  for (let matName in data.cost) {
    const requiredAmount = data.cost[matName];
    const currentAmount = game.materials[matName] || 0;
    
    if (currentAmount < requiredAmount) {
      hintEl.innerHTML = `âŒ ç´ æä¸è¶³ï¼šéœ€è¦ ${matName} x${requiredAmount}`;
      return;
    }
  }

  // --- 4. åŸ·è¡Œæ‰£é™¤ç´ æ ---
  for (let matName in data.cost) {
    game.materials[matName] -= data.cost[matName];
  }

  // --- 5. ç™¼æ”¾çå‹µ ---
  if (data.reward.type === "mana") {
    game.mana += data.reward.value;
  } 
  else if (data.reward.type === "uniqueEquip") {
    const equip = createUniqueItem(data.reward.id, data.reward.lv);
    if (equip) game.inventory.push(equip);
  }

  // --- 6. ç´€éŒ„å·²ä½¿ç”¨åºè™Ÿ (æ–°å¢é™åˆ¶) ---
  if (!game.usedCodes) game.usedCodes = [];
  game.usedCodes.push(inputCode);

  // --- 7. æ›´æ–°ä»‹é¢èˆ‡å­˜æª” ---
  document.getElementById("exchangeInput").value = "";
  hintEl.innerHTML = `âœ… æˆåŠŸå…Œæ›ï¼š${data.name}`;
  
  if (typeof updateUI === "function") updateUI();
  if (typeof saveData === "function") saveData();
}


/**
 * ============================================================
 * è¨­å®šèˆ‡å­˜æª”ç³»çµ±
 * ============================================================
 */

// 1. åŸ·è¡Œä¸‹è¼‰å­˜æª”æª”æ¡ˆ
function exportSaveFile() {
  const date = new Date();
  const dateString = date.toISOString().split('T')[0];
  const filename = `Legend_Save_${dateString}.sav`;
  
  // ç¢ºä¿ä¸‹è¼‰çš„æ˜¯æœ€æ–°çš„ game æ•¸æ“š
  const saveData = JSON.stringify(game, null, 2);
  const blob = new Blob([saveData], { type: 'application/json' });
  
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  alert("å­˜æª”æª”æ¡ˆå·²ä¸‹è¼‰è‡³æ‚¨çš„è¨­å‚™ã€‚");
}

// è™•ç†ä¸Šå‚³å­˜æª”æª”æ¡ˆ (ä¿®æ­£ Key å€¼è¡çª)
function importSaveFile(input) {
  const file = input.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const decodedData = JSON.parse(e.target.result);
      
      // é©—è­‰å­˜æª”å…§å®¹ (ç¢ºä¿å®ƒæ˜¯ä½ çš„éŠæˆ²è³‡æ–™)
      if (decodedData && (typeof decodedData.mana !== 'undefined' || typeof decodedData.charLv !== 'undefined')) {
        if (confirm("æª”æ¡ˆè§£ææˆåŠŸï¼ç¢ºå®šè¦è¦†è“‹ç›®å‰é€²åº¦ä¸¦é‡å•ŸéŠæˆ²å—ï¼Ÿ")) {
          // æ ¸å¿ƒä¿®æ­£ï¼šåŠ å…¥ flag é˜²æ­¢éºè¨€å­˜æª”
          canSave = false; 
          
          // æ ¸å¿ƒä¿®æ­£ï¼šå°‡è³‡æ–™å¯«å…¥èˆ‡ initGame ç›¸åŒçš„ Key
          localStorage.setItem(SAVE_KEY, JSON.stringify(decodedData)); 
          
          alert("é€²åº¦åŒ¯å…¥æˆåŠŸï¼Œå³å°‡é‡å•ŸéŠæˆ²ï¼");
          location.reload(); // é‡æ•´å¾Œ initGame() æœƒè®€å–æ–°çš„ SAVE_KEY
        }
      } else {
        alert("åŒ¯å…¥å¤±æ•—ï¼šé€™ä¼¼ä¹ä¸æ˜¯æœ‰æ•ˆçš„å­˜æª”æª”æ¡ˆã€‚");
      }
    } catch (err) {
      alert("æª”æ¡ˆè®€å–å‡ºéŒ¯ï¼Œè«‹ç¢ºä¿å®ƒæ˜¯æ­£ç¢ºçš„ .sav æˆ– .json æª”æ¡ˆã€‚");
      console.error(err);
    }
    input.value = '';
  };
  reader.readAsText(file);
}

// åˆªé™¤ç´€éŒ„é‚è¼¯ (çµ±ä¸€ä½¿ç”¨ SAVE_KEY)
function confirmReset() {
  if (confirm("ğŸš¨ è­¦å‘Šï¼šç¢ºå®šè¦åˆªé™¤æ‰€æœ‰é€²åº¦å—ï¼Ÿ")) {
    if (confirm("é€™æœƒæ¸…ç©ºæ‰€æœ‰æ•¸æ“šä¸¦é‡æ–°é–‹å§‹ï¼ŒçœŸçš„ç¢ºå®šï¼Ÿ")) {
      // æ ¸å¿ƒä¿®æ­£ï¼šé˜²æ­¢éºè¨€å­˜æª”
      canSave = false; 
      
      localStorage.removeItem(SAVE_KEY); // åªåˆªé™¤éŠæˆ²å­˜æª”ï¼Œä¸å½±éŸ¿å…¶ä»–å¯èƒ½çš„ç·©å­˜
      alert("æ•¸æ“šå·²æ¸…ç©ºï¼");
      location.reload();
    }
  }
}

// 5. æ›´æ–°æœ€å¾Œå­˜æª”æ™‚é–“é¡¯ç¤º
function updateSaveTime() {
  const now = new Date();
  const timeStr = now.getHours().toString().padStart(2, '0') + ":" + 
                  now.getMinutes().toString().padStart(2, '0') + ":" + 
                  now.getSeconds().toString().padStart(2, '0');
  const el = document.getElementById("lastSaveTime");
  if (el) el.innerText = timeStr;
}

/**
 * ============================================================
 * å…¨å±€å®šæ™‚å™¨ (Global Game Loop) 
 * ============================================================
 */
setInterval(() => {
  // 1. é­”åŠ›ç”¢å‡º (MPS / 10)
  game.mana += manaPerSecond() / 10;
  
  // 2. è„«æˆ°ç‹€æ…‹ä¸‹çš„ç”Ÿå‘½å€¼å›å¾©
  if (game.currentHp < getMaxHp() && !battleInterval) {
    // åŸºç¤å›è¡€ + å†¥æƒ³åŠ æˆ
    let regen = (getMaxHp() * 0.005) + (game.med * 0.5); 
    game.currentHp = Math.min(getMaxHp(), game.currentHp + regen / 10);
    
    updateBattleUI(); 
  }

  // 3. åŸºç¤æ•¸å€¼é¡¯ç¤ºæ›´æ–° (é­”åŠ›)
  const manaEl = document.getElementById("mana");
  if (manaEl) manaEl.innerText = Math.floor(game.mana).toLocaleString();

}, 100);

// åˆæ¬¡å•Ÿå‹• UI
updateUI();
</script>

</div>
</div>
</body>

</html>



