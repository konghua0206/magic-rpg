<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é­”æ³•ä¿®ç…‰ RPGï¼šæ¸¬è©¦ç‰ˆ</title>
<link rel="stylesheet" href="css/style.css">
</head>

<body>

<nav class="sidebar">
  <div class="nav-item active" onclick="switchPage('character')"><span>ğŸ‘¤</span>è§’è‰²</div>
  <div class="nav-item" onclick="switchPage('battle')"><span>âš”ï¸</span>æˆ°é¬¥</div>
  <div class="nav-item" onclick="switchPage('skills')"><span>ğŸ“œ</span>æŠ€èƒ½</div>
  <div class="nav-item" onclick="switchPage('inventory')"><span>ğŸ’</span>èƒŒåŒ…</div>
  <div class="nav-item" id="nav-settings" onclick="switchPage('settings')"><span>âš™ï¸</span>è¨­å®š</div>
</nav>

<div class="main-wrapper">
  <div class="main-content">
    <div class="magic">âœ¨ <span id="mana">0</span></div>
    <div class="mps" style="text-align:center; opacity:0.8; font-size:12px; margin-bottom: 15px;">é­”åŠ›æµå‹•ï¼š<span id="mps">0</span>/s</div>

<div id="page-character" class="page active">
  <div style="text-align: center; margin-bottom: 15px;">
    <div id="nameDisplay" style="font-weight:bold; font-size:20px; color:var(--primary); letter-spacing: 1px;">æœªå‘½åå‹‡è€…</div>
    <input type="text" id="nameInput" style="display:none;" maxlength="8">
    <div class="small">Level <span id="charLv">1</span></div>
  </div>

  <div class="card" style="padding: 10px;">
    <div style="width: 100%; aspect-ratio: 1/1; position: relative; overflow: hidden; border-radius: 12px; border: 2px solid var(--primary); background: #000; margin-bottom: 20px;">
      <img id="avatarImg" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" src="https://via.placeholder.com/400" />
      <button id="editBtn" style="position: absolute; bottom: 10px; right: 10px; width: auto; font-size: 10px; padding: 5px 10px; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);">ç·¨è¼¯é ­åƒ/ID</button>
      <input type="file" id="avatarInput" style="display:none;" accept="image/*">
    </div>

    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; justify-items: center; padding: 10px;">
      <div class="equip-slot" id="slot-head" data-label="é ­éƒ¨">ğŸ“</div>
      <div class="equip-slot" id="slot-top" data-label="ä¸Šè¡£">ğŸ‘˜</div>
      <div class="equip-slot" id="slot-necklace" data-label="é …éŠ">ğŸ“¿</div>
      
      <div class="equip-slot" id="slot-mainHand" data-label="ä¸»æ‰‹">ğŸ—¡ï¸</div>
      <div class="equip-slot" id="slot-offHand" data-label="å‰¯æ‰‹">ğŸ›¡ï¸</div>
      <div class="equip-slot" id="slot-ring1" data-label="æˆ’æŒ‡1">ğŸ’</div>

      
      <div class="equip-slot" id="slot-bottom" data-label="ä¸‹è¡£">ğŸ‘–</div>
      <div class="equip-slot" id="slot-shoes" data-label="é‹å­">ğŸ‘</div>
      <div class="equip-slot" id="slot-ring2" data-label="æˆ’æŒ‡2">ğŸ’</div>

    </div>
  </div>

  <div class="card">
    <strong>ğŸ“Š å±¬æ€§é¢æ¿</strong>
    <div class="small" style="margin: 10px 0;">ç”Ÿå‘½å€¼ HP: <span id="hpText">0 / 0</span></div>
    <div style="width: 100%; height: 10px; background: #441111; border-radius: 5px; overflow: hidden; margin-bottom: 15px;">
      <div id="hpBar" style="width: 100%; height: 100%; background: #ff4d4d; transition: width 0.3s;"></div>
    </div>
    <div class="attr"><span>âš”ï¸ æ”»æ“Š ATK</span> <span id="atk">0</span></div>
    <div class="attr"><span>ğŸ›¡ï¸ é˜²ç¦¦ DEF</span> <span id="def">0</span></div>
    <hr style="opacity:0.1; margin: 15px 0;">
    <div class="small" style="margin-bottom: 10px;">å¯ç”¨èƒ½åŠ›é»ï¼š<span id="points">0</span></div>
    <div class="attr"><span>ğŸ“˜ æ™ºåŠ›ï¼š<span id="int">0</span></span> <button style="width:36px; padding:4px;" onclick="addAttr('int')">+</button></div>
    <div class="attr"><span>â³ å†¥æƒ³ï¼š<span id="med">0</span></span> <button style="width:36px; padding:4px;" onclick="addAttr('med')">+</button></div>
    <div class="attr"><span>â¤ï¸ é«”è³ªï¼š<span id="vit">0</span></span> <button style="width:36px; padding:4px;" onclick="addAttr('vit')">+</button></div>
    <button id="upgradeChar" style="margin-top: 10px;">è§’è‰²å‡ç´š (<span id="charCost">0</span>âœ¨)</button>
  </div>
</div>

<div id="page-skills" class="page" style="display:none;">
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <strong>ğŸ”® æŠ€èƒ½é…ç½®</strong>
      <span class="small">å·²ç¶å®š: <span id="activeSkillCount">0</span> / 3</span>
    </div>
    
    <div id="skillList" style="display:flex; flex-direction:column; gap:10px;">
      </div>
    
    <div class="small" style="margin-top:15px; color:rgba(255,255,255,0.4); text-align:center;">
      â€» é ˜æ‚ŸæŠ€èƒ½éœ€æ¶ˆè€—é­”åŠ›èˆ‡ç‰¹å®š BOSS ææ–™
    </div>
  </div>
</div>

<div id="page-settings" class="page">
  <div class="card">
    <h3 style="margin-top: 0; color: var(--primary);">âš™ï¸ éŠæˆ²è¨­å®š</h3>
    <p class="small">åœ¨é€™è£¡ç®¡ç†ä½ çš„å†’éšªé€²åº¦èˆ‡éŠæˆ²é¸é …ã€‚</p>
    
    <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">

    <div class="card">
  <strong style="color: var(--primary);">ğŸ’¾ å­˜æª”ç®¡ç†</strong>
  <p class="small">å°‡ä½ çš„é€²åº¦ä¸‹è¼‰ç‚ºæª”æ¡ˆä¿å­˜ï¼Œæˆ–ä¸Šå‚³æª”æ¡ˆæ¢å¾©é€²åº¦ã€‚</p>
  
  <div style="display: flex; gap: 10px; margin-top: 10px;">
    <button onclick="exportSaveFile()" style="flex: 1; background: #3498db;">ä¸‹è¼‰å­˜æª”æª”</button>
    <button onclick="document.getElementById('importFileInput').click()" style="flex: 1; background: #2ecc71;">ä¸Šå‚³å­˜æª”æª”</button>
  </div>
  
  <input type="file" id="importFileInput" style="display:none;" accept=".sav,.json" onchange="importSaveFile(this)">
</div>

    <div style="padding: 15px; border: 1px dashed #e74c3c; border-radius: 12px; background: rgba(231, 76, 60, 0.05);">
      <strong style="color: #e74c3c; display: block; margin-bottom: 5px;">âš ï¸ å±éšªå€åŸŸ</strong>
      <span class="small">åˆªé™¤å¾Œå°‡å¤±å»æ‰€æœ‰ç­‰ç´šã€è£å‚™ã€ææ–™èˆ‡é­”åŠ›ã€‚æ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚</span>
      
      <button class="danger-btn" onclick="confirmReset()" style="margin-top: 15px; background: #e74c3c;">
        åˆªé™¤æ‰€æœ‰éŠæˆ²ç´€éŒ„
      </button>
    </div>
  </div>
  
  <div class="card">
    <div class="small" style="text-align: center;">
      éŠæˆ²ç‰ˆæœ¬ï¼šv0.1<br>
      æœ€å¾Œå­˜æª”æ™‚é–“ï¼š<span id="lastSaveTime">--:--:--</span>
    </div>
  </div>
</div>

<div id="page-battle" class="page">
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h3 style="margin: 0; color: var(--primary);">å†’éšªèˆ‡è¨ä¼</h3>
      <div style="display: flex; gap: 5px;">
        <button id="btnModeAdv" onclick="toggleBattleMode('adventure')" style="padding: 5px 10px; font-size: 12px;">å†’éšªæ¨¡å¼</button>
        <button id="btnModeBoss" onclick="toggleBattleMode('boss')" style="padding: 5px 10px; font-size: 12px; background: #444;">BOSS æŒ‘æˆ°</button>
      </div>
    </div>

    <div id="adventureControls">
      <select id="regionSelect" onchange="changeRegion(this.value)" style="width: 100%; padding: 10px; background: #222; color: #fff; border: 1px solid var(--primary); border-radius: 8px; margin-bottom: 10px;">
        </select>
    </div>

    <div id="bossControls" style="display:none;">
      <div id="bossList" style="display: flex; gap: 12px; overflow-x: auto; padding: 10px 5px; scroll-snap-type: x mandatory;"></div>
      <div class="small" style="text-align:center; color:rgba(255,255,255,0.4); margin-top:5px;">â† å·¦å³æ»‘å‹•é¸æ“‡å°æ‰‹ â†’</div>
    </div>

    <div id="battleStatus" style="text-align: center; margin: 15px 0; min-height: 24px; color: #f1c40f;">æº–å‚™å°±ç·’</div>

<div id="battleDisplayArea" style="display: flex; flex-direction: column; gap: 12px;">
  
  <div id="playerBattleArea" class="card" style="display:none; position: relative; overflow: hidden; min-height: 130px; border-left: 5px solid var(--primary); padding: 15px; background: rgba(0,0,0,0.5);">
    <img id="battlePlayerImg" src="" style="position: absolute; right: -5px; top: -5px; height: 130%; opacity: 0.7; pointer-events: none; mask-image: linear-gradient(to left, black, transparent); -webkit-mask-image: linear-gradient(to left, black, transparent); object-fit: contain; z-index: 0;">
    
    <div style="position: relative; z-index: 1; width: 60%;">
      <div id="playerSideName" style="font-weight: bold; color: var(--primary); font-size: 18px; text-shadow: 0 0 5px #000;">ã€ç©å®¶ã€‘</div>
      <div style="font-size: 14px; margin-top: 4px; color: #eee;">HP: <span id="pBattleHpText" style="font-family: monospace;">0 / 0</span></div>
      <div style="width:100%; height:12px; background:rgba(0,0,0,0.6); border-radius:6px; overflow:hidden; margin-top:8px; border: 1px solid rgba(255,255,255,0.1);">
        <div id="pBattleHpBar" style="width:100%; height:100%; background:linear-gradient(90deg, #2ecc71, #27ae60); transition: width 0.3s;"></div>
      </div>
    </div>
  </div>

  <div id="vsTitle" style="display:none; text-align: center; color: #666; font-weight: bold; font-style: italic; font-size: 20px; margin: -5px 0;">V.S.</div>

  <div id="monsterArea" class="card" style="display:none; position: relative; overflow: hidden; min-height: 130px; border-right: 5px solid #e74c3c; padding: 15px; background: rgba(0,0,0,0.5);">
    <img id="bossImg" src="" style="position: absolute; left: -5px; top: -5px; height: 130%; opacity: 0.7; pointer-events: none; mask-image: linear-gradient(to right, black, transparent); -webkit-mask-image: linear-gradient(to right, black, transparent); object-fit: contain; z-index: 0;">
    
    <div style="position: relative; z-index: 1; width: 60%; margin-left: auto; text-align: right;">
      <div id="mName" style="font-weight: bold; color: #e74c3c; font-size: 18px; text-shadow: 0 0 5px #000;">æ€ªç‰©åç¨±</div>
      <div style="font-size: 14px; margin-top: 4px; color: #eee;">HP: <span id="mHpText" style="font-family: monospace;">0 / 0</span></div>
      <div style="width:100%; height:12px; background:rgba(0,0,0,0.6); border-radius:6px; overflow:hidden; margin-top:8px; border: 1px solid rgba(255,255,255,0.1);">
        <div id="mHpBar" style="width:100%; height:100%; background:linear-gradient(90deg, #ff4d4d, #ff9f43); transition: width 0.3s;"></div>
      </div>
    </div>
  </div>
</div>

    <button id="startBattleBtn" onclick="startBattle()" style="margin-top: 10px;">é–‹å§‹æœå°‹æ•µäºº</button>
    <button id="stopBattleBtn" onclick="stopBattle('å·²æ’¤é›¢æˆ°å ´')" style="display:none; background:#555; margin-top: 10px;">æ’¤é€€ / åœæ­¢</button>
  </div>

  <div class="card" style="margin-top: 15px; padding: 10px;">
    <div id="battleLog" style="height: 150px; overflow-y: auto; font-size: 12px; display: flex; flex-direction: column; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px;"></div>
  </div>
</div>

<div id="page-inventory" class="page">
  <div class="card">
    <div style="display:flex; gap:10px; margin-bottom:15px;">
      <button onclick="setInvTab('equip')" id="btnTabEquip" style="flex:1;">è£å‚™</button>
      <button onclick="setInvTab('material')" id="btnTabMat" style="flex:1; background:#444;">ææ–™</button>
    </div>

    <div id="quickSellArea" style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05);">
      <div class="small" style="margin-bottom: 8px; color: var(--primary);">ğŸ’° å¿«é€Ÿè²©å”®è£å‚™</div>
      <div style="display: flex; gap: 8px; align-items: center;">
        <select id="sellRarityFilter" style="flex: 2; background:#222; color:#fff; border:1px solid #444; border-radius:4px; padding:4px;">
          <option value="0">åƒ…é™ï¼šæ™®é€š (ç™½)</option>
          <option value="1">åŒ…å«ï¼šç¨€æœ‰ (è—) ä»¥ä¸‹</option>
          <option value="2">åŒ…å«ï¼šå²è©© (ç´«) ä»¥ä¸‹</option>
        </select>
        <button onclick="bulkSell()" style="flex: 1; background: #e74c3c; padding: 5px; font-size: 12px; color: white; border: none; border-radius: 4px; cursor: pointer;">ç¢ºèªè²©å”®</button>
      </div>
    </div>

    <div id="inventoryContainer"></div>
  </div>
</div>

<div id="itemModal" class="modal-overlay" onclick="closeModal()">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div id="modalRarity" class="modal-rarity">RARITY</div>
    <div id="modalIcon" style="font-size: 40px; margin: 10px 0;">ğŸ›¡ï¸</div>
    <strong id="modalName" style="font-size: 18px;">è£å‚™åç¨±</strong>
    <div id="modalStats" class="modal-stats" style="margin: 15px 0; line-height: 1.6;">å±¬æ€§è®€å–ä¸­...</div>
    <button id="unequipBtn" style="background: #444;">å¸ä¸‹è£å‚™</button>
    <button onclick="closeModal()" style="background: none; border: 1px solid #555; margin-top: 10px; font-size: 12px; width: auto; padding: 5px 15px;">é—œé–‰</button>
  </div>
</div>

<footer class="copyright-notice">
  &copy; 2026 konghua_0206. All Rights Reserved.
</footer>

<script src="js/skills.js"></script>
<script src="js/monsters.js"></script>
<script src="js/monsters_dropdown.js"></script>
<script src="js/bosses.js"></script>

<script>
/**
 * ============================================================
 * æ ¸å¿ƒæ•¸æ“šåˆå§‹åŒ–èˆ‡æŒä¹…åŒ– (Core Data & Persistence)
 * è² è²¬å®šç¾©éŠæˆ²ç‹€æ…‹ã€è¼‰å…¥/å„²å­˜ç©å®¶é€²åº¦
 * ============================================================
 */

// 1. å®šç¾©å”¯ä¸€çš„å­˜æª”æ¨™ç±¤
const SAVE_KEY = "magicRPG_v2"; 
const MAX_LEVEL = 100; // ç©å®¶ç­‰ç´šä¸Šé™

// 2. å®šç¾©ç”¢ç”Ÿåˆå§‹è³‡æ–™çš„å‡½å¼
function getDefaultGameData() {
  return {
    charName: "æœªå‘½åå‹‡è€…", 
    avatarImage: "images/30N8diAK4J1Y928MusBotd.jpg",
    mana: 0, 
    charLv: 1, 
    points: 0, 
    int: 0, 
    med: 0, 
    vit: 0, 
    currentHp: 100,
    
    // --- æŠ€èƒ½ç³»çµ±æ–°å¢è³‡æ–™ ---
    learnedSkills: [],    // å·²ç¿’å¾—æŠ€èƒ½çš„ ID é™£åˆ— (ä¾‹å¦‚: ["fireball"])
    equippedSkills: [],   // ç›®å‰ç¶å®šåœ¨æˆ°é¬¥ä¸­çš„æŠ€èƒ½ ID (æœ€å¤š 3 å€‹)
    
    // --- ç‰©å“èˆ‡ææ–™ ---
    inventory: [], 
    materials: {
      "å¤è€é¹¿è§’": 0,      // é è¨­åˆ—å‡ºåŸºç¤ BOSS ææ–™æ–¹ä¾¿è¿½è¸ª
      "å®ˆè­·è€…æ ¸å¿ƒ": 0,
      "æ·±æ·µéˆé­‚": 0
    },
    
    // --- è£å‚™æ§½ä½ ---
    equipment: { 
      head: null, top: null, bottom: null, shoes: null, 
      mainHand: null, offHand: null, necklace: null, ring1: null, ring2: null 
    }
  };
}

// 3. å®£å‘Šå…¨åŸŸè®Šæ•¸ game (å…ˆä¸è³¦å€¼)
let game;

// 4. åˆå§‹åŒ–éŠæˆ²é‚è¼¯
function initGame() {
    const savedData = localStorage.getItem(SAVE_KEY);
    if (savedData) {
        try {
            // åˆä½µå­˜æª”èˆ‡é è¨­å€¼ï¼Œç¢ºä¿æ–°èˆŠç‰ˆç›¸å®¹
            game = Object.assign(getDefaultGameData(), JSON.parse(savedData));
            console.log("å­˜æª”è¼‰å…¥æˆåŠŸ");
        } catch (e) {
            console.error("å­˜æª”æå£ï¼Œé‡ç½®ç‚ºæ–°éŠæˆ²");
            game = getDefaultGameData();
        }
    } else {
        game = getDefaultGameData();
        console.log("ç„¡å­˜æª”ç´€éŒ„ï¼Œé–‹å•Ÿæ–°éŠæˆ²");
    }
        if (typeof renderRegionDropdown === "function") {
        renderRegionDropdown();
    }
    // ç¢ºä¿æ‰€æœ‰ UI é¡¯ç¤ºæœ€æ–°è³‡æ–™
    if (typeof updateUI === "function") updateUI(); 
}

// 5. å…¶ä»–å…¨åŸŸç‹€æ…‹
let isEditing = false;
let currentInvTab = 'equip';
let battleInterval = null;
let currentMonster = null;
const slotIcons = { head:"ğŸ“", top:"ğŸ‘˜", bottom:"ğŸ‘–", shoes:"ğŸ‘", mainHand:"ğŸ—¡ï¸", offHand:"ğŸ›¡ï¸", necklace:"ğŸ“¿", ring1:"ğŸ’", ring2:"ğŸ’" };

// 6. åŸ·è¡Œåˆå§‹åŒ– (æ”¾æœ€å¾Œ)
initGame();

// 7. å®šç¾©çµ±ä¸€çš„å­˜æª”å‡½å¼
function saveData() { 
    localStorage.setItem(SAVE_KEY, JSON.stringify(game)); 
    // åŒæ­¥æ›´æ–°è¨­å®šé é¢çš„æœ€å¾Œå­˜æª”æ™‚é–“
    updateSaveTime(); 
    console.log("éŠæˆ²å·²è‡ªå‹•å­˜æª”");
}

// 8. ç•¶ç€è¦½å™¨è¦–çª—æº–å‚™é—œé–‰æˆ–é‡æ–°æ•´ç†æ™‚ï¼ŒåŸ·è¡Œæœ€å¾Œä¸€æ¬¡å­˜æª”
window.addEventListener("beforeunload", function (e) {
    // åªæœ‰åœ¨ canSave è¨±å¯çš„æƒ…æ³ä¸‹æ‰åŸ·è¡Œå­˜æª”
    // é€™æ¨£åœ¨ confirmReset æˆ– importSaveFile é—œé–‰è¨±å¯å¾Œï¼Œå°±ä¸æœƒæŠŠèˆŠè³‡æ–™å¯«å› LocalStorage
    if (typeof canSave !== 'undefined' && canSave) {
        saveData();
    }
});

/**
 * ============================================================
 * å±¬æ€§æ•¸å€¼é‹ç®—ä¸­å¿ƒ (Stat Calculation Engine)
 * è² è²¬è™•ç†æ‰€æœ‰è£å‚™åŠ æˆã€è§’è‰²æˆé•·èˆ‡å³æ™‚æ•¸å€¼è½‰æ›
 * ============================================================
 */

// åŠ ç¸½æ‰€æœ‰ç©¿æˆ´è£å‚™çš„å±¬æ€§
function getEquipStats() {
  let s = { atk:0, def:0, hp:0 };
  for(let k in game.equipment) { if(game.equipment[k]) { s.atk+=game.equipment[k].atk; s.def+=game.equipment[k].def; s.hp+=game.equipment[k].hp; } }
  return s;
}

// å–å¾—ç•¶å‰æœ€å¤§è¡€é‡ (æ•´åˆä½ åŸæœ¬çš„å…¬å¼)
function getMaxHp() {
  // å–å¾—è£å‚™åŠ æˆ (ç¢ºä¿ getEquipStats å‡½å¼å­˜åœ¨)
  const e = (typeof getEquipStats === "function") ? getEquipStats() : { hp: 0, atk: 0, def: 0 };
  
  // åŸæœ¬å…¬å¼ï¼š(åŸºç¤ + ç­‰ç´šåŠ æˆ + è£å‚™åŠ æˆ) * (1 + é«”è³ªåŠ æˆ)
  return Math.floor((100 + game.charLv * 30 + e.hp) * (1 + game.vit * 0.05));
}

// å–å¾—æˆ°é¬¥ç”¨å±¬æ€§ (æ•´åˆæ”»æ“Šèˆ‡é˜²ç¦¦)
function getCombatStats() {
  const e = (typeof getEquipStats === "function") ? getEquipStats() : { hp: 0, atk: 0, def: 0 };
  
  return {
    atk: 10 + (game.int * 5) + (e.atk || 0),   // æ™ºåŠ›åŠ æˆ + è£å‚™æ”»æ“Š
    def: 5 + (game.vit * 2) + (e.def || 0),    // é«”è³ªåŠ æˆ + è£å‚™é˜²ç¦¦
    maxHp: getMaxHp()                         // ç›´æ¥èª¿ç”¨ä½ åŸæœ¬çš„å…¬å¼
  };
}

// è¨ˆç®—ç¸½æ”»æ“ŠåŠ› (ç­‰ç´šåŸºç¤ + æ™ºåŠ›åŠ æˆ + è£å‚™)
function getAtk() { return (game.charLv*5)+(game.int*8)+getEquipStats().atk; }

// è¨ˆç®—ç¸½é˜²ç¦¦åŠ› (é«”åŠ›åŸºç¤ + è£å‚™)
function getDef() { return (game.vit*2)+getEquipStats().def; }

// è¨ˆç®—æ¯ç§’ç”¢ç”Ÿçš„é­”åŠ› (MPS)
function manaPerSecond() { return Math.floor((game.charLv*2)*(1+game.int*0.01)); }


/**
 * ============================================================
 * ä½¿ç”¨è€…ä»‹é¢é©…å‹• (UI Driving & Interaction)
 * è² è²¬å°‡æ•¸æ“šè®Šå‹•åæ˜ åˆ°ç•«é¢ï¼Œä»¥åŠè™•ç†æŒ‰éˆ•é»æ“Šäº‹ä»¶
 * ============================================================
 */

// æ›´æ–°ç•«é¢ä¸Šæ‰€æœ‰çš„æ•¸å€¼èˆ‡é€²åº¦æ¢
function updateUI() {
  document.getElementById("mana").innerText = Math.floor(game.mana);
  document.getElementById("mps").innerText = manaPerSecond();
  document.getElementById("charLv").innerText = game.charLv;
  document.getElementById("nameDisplay").innerText = game.charName;
  document.getElementById("points").innerText = game.points;
  document.getElementById("int").innerText = game.int;
  document.getElementById("med").innerText = game.med;
  document.getElementById("vit").innerText = game.vit;
  document.getElementById("atk").innerText = getAtk();
  document.getElementById("def").innerText = getDef();
  document.getElementById("charCost").innerText = Math.floor(50 * Math.pow(1.3, game.charLv-1));
  
  const mHp = getMaxHp();
  document.getElementById("hpText").innerText = `${Math.floor(game.currentHp)} / ${mHp}`;
  document.getElementById("hpBar").style.width = (game.currentHp/mHp*100) + "%";
  if(game.avatarImage) document.getElementById("avatarImg").src = game.avatarImage;

  // æ¸²æŸ“è£å‚™æ§½ä½ç‹€æ…‹
  for (let sid in slotIcons) {
    let el = document.getElementById(`slot-${sid}`);
    if (game.equipment[sid]) {
      el.innerText = game.equipment[sid].icon;
      el.className = "equip-slot occupied";
      el.style.borderColor = `var(--rarity-${game.equipment[sid].rarity})`;
      el.onclick = () => showEquipDetail(sid);
    } else {
      el.innerText = slotIcons[sid];
      el.className = "equip-slot";
      el.style.borderColor = "";
      el.onclick = null;
    }
  }
}

// åˆ‡æ›ä¸»é é¢åˆ†é 
function switchPage(p) {
  // 1. åˆ‡æ›åˆ†é é¡¯ç¤º
  document.querySelectorAll('.page').forEach(pg => {
    pg.classList.remove('active');
    pg.style.display = 'none';
  });
  
  const target = document.getElementById('page-' + p);
  if (target) {
    target.classList.add('active');
    target.style.display = 'block';
  }

  // 2. æ›´æ–°å´é‚Šæ¬„æŒ‰éˆ•é«˜äº®
  document.querySelectorAll('.nav-item').forEach(nav => {
    nav.classList.remove('active');
    // å¢åŠ å®‰å…¨æ€§æª¢æŸ¥ï¼Œç¢ºä¿ onclick å±¬æ€§å­˜åœ¨
    const clickAttr = nav.getAttribute('onclick');
    if (clickAttr && clickAttr.includes(`'${p}'`)) {
      nav.classList.add('active');
    }
  });

  // 3. æ ¹æ“šåˆ†é åŸ·è¡Œå°æ‡‰çš„æ¸²æŸ“é‚è¼¯
  if (p === 'inventory') {
    renderInventory();
  }
  
  if (p === 'battle') {
    updateBattleUI();
  }

  // âœ… æ–°å¢ï¼šå¦‚æœæ˜¯åˆ‡æ›åˆ°æŠ€èƒ½åˆ†é ï¼ŒåŸ·è¡ŒæŠ€èƒ½åˆ—è¡¨æ¸²æŸ“
  if (p === 'skills') {
    if (typeof renderSkills === "function") {
      renderSkills();
    } else {
      console.warn("renderSkills å‡½å¼å°šæœªå®šç¾©ï¼Œè«‹ç¢ºä¿æŠ€èƒ½ç³»çµ±ä»£ç¢¼å·²åŠ å…¥è…³æœ¬ä¸­ã€‚");
    }
  }
}

// å±¬æ€§é»åŠ é»è™•ç†
function addAttr(a) { if(game.points > 0) { game[a]++; game.points--; updateUI(); saveData(); } }

// è§’è‰²ç­‰ç´šæå‡è™•ç†
document.getElementById("upgradeChar").onclick = () => {
  let cost = Math.floor(50 * Math.pow(1.3, game.charLv-1));
  if (game.mana >= cost) { game.mana -= cost; game.charLv++; game.points += 5; updateUI(); saveData(); }
};


/**
 * ============================================================
 * è§’è‰²æª”æ¡ˆç®¡ç† (Profile & Avatar Management)
 * è² è²¬è™•ç†æ›´åèˆ‡å¤§é ­è²¼ä¸Šå‚³
 * ============================================================
 */

// è™•ç†ç·¨è¼¯è³‡æ–™æ¨¡å¼åˆ‡æ›
document.getElementById("editBtn").onclick = function() {
  isEditing = !isEditing;
  const nameDisplay = document.getElementById("nameDisplay");
  const nameInput = document.getElementById("nameInput");
  if (isEditing) {
    this.innerText = "å„²å­˜è³‡æ–™";
    nameDisplay.style.display = "none";
    nameInput.style.display = "inline-block";
    nameInput.value = game.charName;
    document.getElementById("avatarInput").click();
  } else {
    game.charName = nameInput.value || "æœªå‘½åå‹‡è€…";
    this.innerText = "ç·¨è¼¯é ­åƒ/ID";
    nameDisplay.style.display = "inline-block";
    nameInput.style.display = "none";
    saveData();
    updateUI();
  }
};

// è™•ç†å¤§é ­è²¼åœ–ç‰‡è®€å– (Base64)
document.getElementById("avatarInput").onchange = (e) => {
  const file = e.target.files[0];
  if (file && file.size < 1024 * 1024) {
    const reader = new FileReader();
    reader.onload = ev => { game.avatarImage = ev.target.result; updateUI(); saveData(); };
    reader.readAsDataURL(file);
  } else if(file) alert("åœ–ç‰‡å¤ªå¤§å›‰ (é™ 1MB)");
};


/**
 * ============================================================
 * èƒŒåŒ…èˆ‡è£å‚™ç³»çµ± (Inventory & Equipment System)
 * è² è²¬è£å‚™çš„ç©¿æˆ´ã€å¸ä¸‹ã€è²©è³£èˆ‡åˆ—è¡¨æ¸²æŸ“
 * ============================================================
 */

// é¡¯ç¤ºè£å‚™è©³ç´°å½ˆçª—
function showEquipDetail(slotId) {
    const item = game.equipment[slotId];
    if (!item) return;
    document.getElementById("itemModal").style.display = "flex";
    const rarityNames = ["æ™®é€š", "ç¨€æœ‰", "å²è©©", "å‚³å¥‡"];
    document.getElementById("modalRarity").innerText = rarityNames[item.rarity];
    document.getElementById("modalRarity").style.color = `var(--rarity-${item.rarity})`;
    document.getElementById("modalName").innerText = item.name;
    document.getElementById("modalIcon").innerText = item.icon;
    document.getElementById("modalStats").innerHTML = `âš”ï¸ ATK +${item.atk}<br>ğŸ›¡ï¸ DEF +${item.def}<br>â¤ï¸ HP +${item.hp}`;
    document.getElementById("unequipBtn").onclick = () => unequipItem(slotId);
}

function closeModal() { document.getElementById("itemModal").style.display = "none"; }

// å¸ä¸‹è£å‚™
function unequipItem(slotId) {
    game.inventory.push(game.equipment[slotId]);
    game.equipment[slotId] = null;
    closeModal();
    updateUI();
    saveData();
}

// çµ±ä¸€çš„è£å‚™åƒ¹å€¼è¨ˆç®—å…¬å¼
function getEquipValue(item) {
    // åŸºç¤åƒ¹å€¼ 50ï¼Œæ¯æå‡ä¸€å€‹å“è³ªç­‰ç´šå¢åŠ  50
    // å…¬å¼ï¼š(0+1)*50=50, (1+1)*50=100, (2+1)*50=150...
    return (item.rarity + 1) * 50;
}

// è²©è³£èƒŒåŒ…ç‰©å“
function sellItem(id) {
    const idx = game.inventory.findIndex(i => i.id === id);
    if (idx === -1) return;
    
    const item = game.inventory[idx];
    // ä½¿ç”¨çµ±ä¸€å…¬å¼å–å¾—åƒ¹æ ¼
    const price = getEquipValue(item);
    
    if (confirm(`ç¢ºå®šè¦è³£æ‰ [${item.name}] å—ï¼Ÿ (åƒ¹å€¼: âœ¨${price})`)) {
        game.mana += price;
        game.inventory.splice(idx, 1);
        renderInventory();
        updateUI();
        saveData();
    }
}

// æ¸²æŸ“èƒŒåŒ…å…§å®¹
function renderInventory() {
  const container = document.getElementById("inventoryContainer");
  if (!container) return;
  container.innerHTML = "";

  if (currentInvTab === 'equip') {
    if (game.inventory.length === 0) {
      container.innerHTML = `<div class="small" style="text-align:center; padding:20px;">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ...</div>`;
      return;
    }
    game.inventory.forEach(item => {
      let div = document.createElement("div");
      div.className = `item-card`;
      div.style.borderLeftColor = `var(--rarity-${item.rarity})`;
      div.innerHTML = `
        <div style="flex:1">
          <strong>${item.icon} ${item.name}</strong><br>
          <span class="small">âš”ï¸${item.atk} ğŸ›¡ï¸${item.def} â¤ï¸${item.hp}</span>
        </div>
        <div style="display:flex; gap:5px;">
          <button style="width:50px; padding:5px; font-size:11px; background:#28a745;" onclick="equipItem(${item.id})">ç©¿ä¸Š</button>
          <button class="sell-btn" onclick="sellItem(${item.id})">è²©è³£</button>
        </div>`;
      container.appendChild(div);
    });
  } else {
    // ææ–™åˆ†é é‚è¼¯
    let hasMaterial = false;
    for (let mat in game.materials) {
      if (game.materials[mat] > 0) {
        hasMaterial = true;
        container.innerHTML += `<div class="item-card"><span>ğŸ“¦ ${mat}</span> <span>x${game.materials[mat]}</span></div>`;
      }
    }
    if (!hasMaterial) container.innerHTML = `<div class="small" style="text-align:center; padding:20px;">å°šç„¡ä»»ä½•ææ–™...</div>`;
  }
}

// åˆ‡æ›èƒŒåŒ…æ¨™ç±¤
function setInvTab(t) {
  currentInvTab = t;
  const btnEquip = document.getElementById("btnTabEquip");
  const btnMat = document.getElementById("btnTabMat");
  const sellArea = document.getElementById("quickSellArea");

  if (btnEquip) btnEquip.style.background = (t === 'equip') ? '' : '#444';
  if (btnMat) btnMat.style.background = (t === 'material') ? '' : '#444';
  
  // å¢åŠ å®‰å…¨æ€§æª¢æŸ¥ï¼Œé˜²æ­¢ sellArea é‚„æ²’è®€å–åˆ°å°±å ±éŒ¯
  if (sellArea) {
    sellArea.style.display = (t === 'equip') ? 'block' : 'none';
  }
  
  renderInventory();
}

// ç©¿ä¸Šè£å‚™è™•ç† (æœƒèˆ‡ç¾æœ‰è£å‚™æ›¿æ›)
function equipItem(id) {
  const idx = game.inventory.findIndex(i => i.id === id);
  const item = game.inventory[idx];
  if (game.equipment[item.type]) game.inventory.push(game.equipment[item.type]);
  game.equipment[item.type] = item;
  game.inventory.splice(idx, 1);
  renderInventory();
  updateUI();
  saveData();
}

//ä¸€éµè²©å”®åŠŸèƒ½:æ ¹æ“šé¸æ“‡çš„å“è³ªç­‰ç´šï¼Œå°‡èƒŒåŒ…å…§å°æ–¼ç­‰æ–¼è©²ç­‰ç´šçš„è£å‚™å…¨éƒ¨è³£æ‰
function bulkSell() {
    const filterEl = document.getElementById("sellRarityFilter");
    if (!filterEl) return;
    const maxRarity = parseInt(filterEl.value);
    
    const toSell = game.inventory.filter(item => item.rarity <= maxRarity);
    if (toSell.length === 0) {
        alert("æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è£å‚™ã€‚");
        return;
    }

    if (confirm(`ç¢ºå®šè²©å”® ${toSell.length} ä»¶è£å‚™å—ï¼Ÿ`)) {
        let totalIncome = 0;
        game.inventory = game.inventory.filter(item => {
            if (item.rarity <= maxRarity) {
                // ä½¿ç”¨çµ±ä¸€å…¬å¼ç´¯åŠ åƒ¹æ ¼
                totalIncome += getEquipValue(item);
                return false;
            }
            return true;
        });

        game.mana += totalIncome;
        alert(`æ‰¹æ¬¡è²©å”®å®Œæˆï¼Œå…±ç²å¾— âœ¨ ${totalIncome}`);
        renderInventory();
        updateUI();
        saveData();
    }
}

/**
 * ============================================================
 * æŠ€èƒ½ç³»çµ± (Skills System)
 * åŒ…å«ï¼šæŠ€èƒ½ç¿’å¾—ã€ç¶å®šæŠ€èƒ½
 * ============================================================
 */

// åˆå§‹åŒ–ç©å®¶æŠ€èƒ½æ•¸æ“š (æ”¾å…¥ getDefaultGameData)
// game.learnedSkills = ["fireball", "heal", "shield"]; // å‡è¨­é è¨­å…¨å­¸æœƒ
// game.equippedSkills = []; // ç›®å‰è£å‚™ä¸­çš„æŠ€èƒ½ ID

// æ¸²æŸ“æŠ€èƒ½åˆ—è¡¨
function renderSkills() {
  const container = document.getElementById("skillList");
  if (!container) return;
  container.innerHTML = "";
  
  allSkills.forEach(skill => {
    const isLearned = game.learnedSkills.includes(skill.id);
    const isEquipped = game.equippedSkills.includes(skill.id);
    
    const div = document.createElement("div");
    div.className = "item-card";
    div.style = `border-left: 4px solid ${isLearned ? skill.color : '#555'}; 
                 display:flex; justify-content:space-between; align-items:center; 
                 margin-bottom:10px; padding:12px; background:rgba(255,255,255,0.05); 
                 border-radius:8px;`;
    
    if (isLearned) {
      // å·²ç¿’å¾—ï¼šé¡¯ç¤ºè£å‚™åŠŸèƒ½
      div.innerHTML = `
        <div style="flex:1;">
          <div style="font-weight:bold; color:${skill.color}">${skill.name} <span style="font-size:10px; color:#aaa;">(æ¶ˆè€—: ${skill.cost}âœ¨)</span></div>
          <div class="small" style="color:#ccc;">${skill.desc}</div>
        </div>
        <button onclick="toggleSkill('${skill.id}')" style="width:80px; padding:8px; font-size:12px; background:${isEquipped ? '#e74c3c' : 'var(--primary)'}">
          ${isEquipped ? 'å¸ä¸‹' : 'è£å‚™'}
        </button>
      `;
    } else {
      // æœªç¿’å¾—ï¼šé¡¯ç¤ºå­¸ç¿’è¦æ±‚
      div.innerHTML = `
        <div style="flex:1;">
          <div style="font-weight:bold; color:#888;">${skill.name} (å°šæœªé ˜æ‚Ÿ)</div>
          <div class="small" style="color:#777;">éœ€æ±‚: ${skill.learnCost.toLocaleString()} âœ¨</div>
          <div class="small" style="color:#f1c40f;">ææ–™: ${skill.requireMat} x1</div>
        </div>
        <button onclick="learnSkill('${skill.id}')" style="width:80px; padding:8px; font-size:12px; background:#2c3e50; border:1px solid #f1c40f; color:#f1c40f;">
          é ˜æ‚Ÿ
        </button>
      `;
    }
    container.appendChild(div);
  });
  
  document.getElementById("activeSkillCount").innerText = game.equippedSkills.length;
}

// é ˜æ‚ŸæŠ€èƒ½é‚è¼¯
function learnSkill(id) {
  const skill = allSkills.find(s => s.id === id);
  if (!skill) return;

  // æª¢æŸ¥è³‡æº
  const hasMana = game.mana >= skill.learnCost;
  const hasMat = (game.materials[skill.requireMat] || 0) >= 1;

  if (!hasMana) { alert("é­”åŠ›ä¸è¶³ï¼"); return; }
  if (!hasMat) { alert(`ç¼ºä¹ææ–™: ${skill.requireMat}`); return; }

  if (confirm(`æ˜¯å¦æ¶ˆè€— ${skill.learnCost} é­”åŠ›èˆ‡ ${skill.requireMat} é ˜æ‚Ÿã€${skill.name}ã€‘ï¼Ÿ`)) {
    game.mana -= skill.learnCost;
    game.materials[skill.requireMat] = Math.max(0, (game.materials[skill.requireMat] || 0) - 1);
    game.learnedSkills.push(id);
    
    alert(`ğŸ‰ æˆåŠŸé ˜æ‚Ÿäº† ${skill.name}ï¼`);
    renderSkills();
    saveData();
    updateUI();
  }
}

function toggleSkill(id) {
  const index = game.equippedSkills.indexOf(id);
  if (index > -1) {
    game.equippedSkills.splice(index, 1);
  } else {
    if (game.equippedSkills.length >= 3) { // é™åˆ¶æœ€å¤šè£å‚™ 3 å€‹
      alert("æœ€å¤šåªèƒ½è£å‚™ 3 å€‹æŠ€èƒ½ï¼");
      return;
    }
    game.equippedSkills.push(id);
  }
  renderSkills();
  saveData();
}

/**
 * é€²éšé£„æµ®ç‰¹æ•ˆ (è§£æåº¦è‡ªé©æ‡‰)
 * @param {Object} skill - å‚³å…¥æŠ€èƒ½ç‰©ä»¶
 */
function spawnSkillEffect(skill) {
  const container = document.getElementById('battleDisplayArea');
  if (!container || container.offsetParent === null) return;

  const effect = document.createElement('div');
  effect.className = 'skill-popup';
  
  // å¼·åˆ¶è¨­å®šå®¹å™¨å±¤ç´šèˆ‡åŸºç¤æ¨£å¼ï¼Œé¿å…è¢« BOSS æˆ°å®¹å™¨æ¨£å¼å£“ç¸®
  effect.style.position = "absolute";
  effect.style.zIndex = "9999";
  effect.style.pointerEvents = "none";
  effect.style.display = "flex";
  effect.style.alignItems = "center";
  effect.style.justifyContent = "center";

  // --- åˆ¤æ–·æ˜¯åœ–ç‰‡é‚„æ˜¯æ–‡å­— ---
  if (skill.icon.includes('.') || skill.icon.includes('/')) {
    const img = document.createElement('img');
    img.src = skill.icon;
    
    // ã€æ ¸å¿ƒèª¿æ•´ã€‘ä½¿ç”¨ vmin ç¢ºä¿åœ¨ä¸åŒè§£æåº¦ä¸‹è¦–è¦ºå¤§å°ä¸€è‡´
    // 12vmin ä»£è¡¨è¢å¹•çŸ­é‚Šçš„ 12%ï¼Œé€™é€šå¸¸æ˜¯æŠ€èƒ½åœ–ç¤ºæœ€èˆ’æœçš„å¤§å°
    img.style.width = "12vmin";  
    img.style.height = "12vmin";
    img.style.minWidth = "60px"; // è¨­å®šæœ€å°åƒç´ ä¿è­‰ä½éšæ‰‹æ©Ÿä¸æœƒçœ‹ä¸è¦‹
    img.style.minHeight = "60px";
    
    img.style.objectFit = "contain";
    effect.appendChild(img);
  } else {
    // å¦å‰‡ç•¶ä½œ Emoji æ–‡å­—è™•ç†
    effect.innerText = skill.icon || "âœ¨";
    effect.style.color = skill.color;
    effect.style.fontSize = "10vmin"; // Emoji ä¹Ÿè¦å‹•æ…‹å¤§å°
  }

  // å¥—ç”¨ç™¼å…‰æ•ˆæœ (ç™¼å…‰åŠå¾‘ä¹Ÿéš¨è¢å¹•å¤§å°ç¸®æ”¾)
  effect.style.filter = `drop-shadow(0 0 2vmin ${skill.glowColor || skill.color})`;

  // ä½ç½®èˆ‡éš¨æ©Ÿåç§» (åç§»ä¹Ÿä½¿ç”¨ % é¿å…è§£æåº¦ç ´å£)
  const jitterX = (Math.random() - 0.5) * 15; 
  effect.style.left = `calc(50% + ${jitterX}%)`;
  effect.style.top = "40%"; 

  container.appendChild(effect);
  
  // 1.2 ç§’å¾Œç§»é™¤
  setTimeout(() => {
    if (effect.parentNode) effect.remove();
  }, 1200);
}
  
/**
 * ============================================================
 * å®Œæ•´æˆ°é¬¥ç³»çµ± (Combat System)
 * åŒ…å«ï¼šéš¨æ©Ÿè£å‚™ç”Ÿæˆã€è¡€æ¢æ­¸é›¶ç·©è¡ã€è‡ªå‹•çºŒæˆ°
 * ============================================================
 */

let currentRegion = "æ–°æ‰‹æ£®æ—"; // é è¨­å€åŸŸ

let battleMode = 'adventure'; // 'adventure' or 'boss'

// 2. éš¨æ©Ÿè£å‚™ç”Ÿæˆå™¨
function generateRandomEquip(lv) {
  const types = ["head", "top", "bottom", "shoes", "mainHand", "offHand"];
  const type = types[Math.floor(Math.random() * types.length)];
  const r = Math.random() < 0.05 ? 3 : (Math.random() < 0.15 ? 2 : (Math.random() < 0.4 ? 1 : 0));
  const rarityNames = ["æ™®é€š", "ç¨€æœ‰", "å²è©©", "å‚³å¥‡"];
  const multiplier = (1 + r * 0.5) * (lv / 5);
  
  return {
    id: Date.now() + Math.random(),
    type: type,
    rarity: r,
    name: `${rarityNames[r]}çš„ Lv.${lv} è£å‚™`,
    atk: Math.floor(10 * multiplier),
    def: Math.floor(5 * multiplier),
    hp: Math.floor(20 * multiplier),
    icon: slotIcons[type]
  };
}

// 2. åˆ‡æ›æ¨¡å¼
function toggleBattleMode(mode) {
  if (battleInterval) {
    alert("æˆ°é¬¥ä¸­ç„¡æ³•åˆ‡æ›æ¨¡å¼ï¼");
    return;
  }
  battleMode = mode;
  document.getElementById("adventureControls").style.display = (mode === 'adventure') ? 'block' : 'none';
  document.getElementById("bossControls").style.display = (mode === 'boss') ? 'block' : 'none';
  document.getElementById("btnModeAdv").style.background = (mode === 'adventure') ? '' : '#444';
  document.getElementById("btnModeBoss").style.background = (mode === 'boss') ? '' : '#444';
  
  if (mode === 'boss') renderBossList();
}

// 3. æ¸²æŸ“ BOSS åˆ—è¡¨
function renderBossList() {
  const list = document.getElementById("bossList");
  if (!list) return;
  list.innerHTML = "";

  bossData.forEach(boss => {
    const card = document.createElement("div");
    // è¨­å®šå¡ç‰‡æ¨£å¼
    card.style = `
      flex: 0 0 140px;
      height: 160px;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 1px solid #f1c40f;
      border-radius: 12px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      text-align: center;
      scroll-snap-align: start;
      position: relative;
      transition: transform 0.2s;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    `;
    
    // æ»‘é¼ ç§»å…¥æ•ˆæœ
    card.onmouseover = () => card.style.transform = "translateY(-5px)";
    card.onmouseout = () => card.style.transform = "translateY(0)";
    card.onclick = () => startBossBattle(boss);

    card.innerHTML = `
      <div style="position:absolute; top:-8px; left:10px; background:#f1c40f; color:#000; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold;">
        Lv.${boss.lv}
      </div>
      <div style="font-size: 24px; margin-top:10px;">ğŸ’€</div>
      <div style="font-weight: bold; font-size: 13px; color: #fff; margin: 5px 0;">${boss.name}</div>
      <div style="font-size: 11px; color: #f1c40f;">âœ¨ ${boss.rewardMana.toLocaleString()}</div>
      <button style="
        width: 100%; 
        padding: 5px; 
        font-size: 11px; 
        background: #e74c3c; 
        border: none; 
        border-radius: 4px; 
        color: white; 
        font-weight: bold;
        margin-top: 5px;
      ">æŒ‘æˆ°</button>
    `;
    list.appendChild(card);
  });
}

// 3.1 åˆ‡æ›å€åŸŸ
function changeRegion(val) {
  if (battleInterval) {
    alert("æˆ°é¬¥ä¸­ç„¡æ³•åˆ‡æ›å€åŸŸï¼");
    document.getElementById("regionSelect").value = currentRegion; // è·³å›åŸä½
    return;
  }
  currentRegion = val;
  document.getElementById("battleStatus").innerText = `å·²æŠµé”ï¼š${currentRegion}`;
}

// 3.2 é–‹å§‹æˆ°é¬¥
function startBattle() {
  if (battleInterval || game.currentHp <= 0) return;
  const areaData = regions[currentRegion];
  const monsterList = areaData.monsters;
  const rand = Math.floor(Math.random() * monsterList.length);
  currentMonster = { ...monsterList[rand], maxHp: monsterList[rand].hp, curHp: monsterList[rand].hp };

  // é¡åƒè³‡è¨Š
  document.getElementById("battlePlayerImg").src = document.getElementById("avatarImg").src;
  document.getElementById("playerSideName").innerText = `ã€${document.getElementById("nameDisplay").innerText}ã€‘`;
  document.getElementById("bossImg").src = ""; // ä¸€èˆ¬æ€ªä¸é¡¯åœ–æˆ–é¡¯ç¤ºé è¨­åœ–

  // UI åˆ‡æ›
  document.getElementById("playerBattleArea").style.display = "block";
  document.getElementById("monsterArea").style.display = "block";
  document.getElementById("vsTitle").style.display = "block";
  document.getElementById("startBattleBtn").style.display = "none";
  document.getElementById("stopBattleBtn").style.display = "block";
  document.getElementById("mName").innerText = `${currentMonster.name} (Lv.${currentMonster.lv})`;

  updateBattleUI();
  battleInterval = setInterval(battleTick, 1000);
}

// 4. é–‹å§‹ BOSS æˆ°é¬¥
function startBossBattle(boss) {
  if (game.currentHp <= 0) { alert("é«”åŠ›ä¸è¶³ï¼"); return; }
  
  // é¡åƒè³‡è¨Š
  document.getElementById("battlePlayerImg").src = document.getElementById("avatarImg").src;
  document.getElementById("playerSideName").innerText = `ã€${document.getElementById("nameDisplay").innerText}ã€‘`;
  
  currentMonster = { ...boss, maxHp: boss.hp, curHp: boss.hp, isBoss: true };
  document.getElementById("bossImg").src = boss.img;
  document.getElementById("mName").innerText = `ã€BOSSã€‘${currentMonster.name}`;

  // UI åˆ‡æ›
  document.getElementById("bossControls").style.display = "none";
  document.getElementById("playerBattleArea").style.display = "block";
  document.getElementById("monsterArea").style.display = "block";
  document.getElementById("vsTitle").style.display = "block";
  document.getElementById("startBattleBtn").style.display = "none";
  document.getElementById("stopBattleBtn").style.display = "block";
  
  updateBattleUI();
  battleInterval = setInterval(battleTick, 1000);
}

// 4. æˆ°é¬¥å¾ªç’°é‚è¼¯ (æ¯ä¸€ç§’è§¸ç™¼ä¸€æ¬¡)
function battleTick() {
  if (!currentMonster) return;

  // 1. å–å¾—è¨ˆç®—å¾Œçš„æ•¸å€¼ (åŒ…å«è£å‚™èˆ‡ç­‰ç´šåŠ æˆ)
  const stats = getCombatStats();
  
  // 2. ç©å®¶è¡Œå‹•æº–å‚™
  let baseDmg = 0;
  let actionLog = ""; 
  let skillTriggered = false;

  // --- A. æŠ€èƒ½åˆ¤å®š ---
  if (game.equippedSkills && game.equippedSkills.length > 0) {
    const randomId = game.equippedSkills[Math.floor(Math.random() * game.equippedSkills.length)];
    const skill = allSkills.find(s => s.id === randomId);

    // åˆ¤å®šæ©Ÿç‡èˆ‡é­”åŠ›
    if (skill && Math.random() < skill.chance) {
      if (game.mana >= skill.cost) {
        game.mana -= skill.cost;
        skillTriggered = true;

        // ã€æ–°å¢ï¼šè§¸ç™¼è¦–è¦ºç‰¹æ•ˆã€‘
        // é€™è£¡èª¿ç”¨ä¹‹å‰å»ºç«‹çš„ç‰¹æ•ˆå‡½æ•¸ï¼Œå‚³å…¥ç•¶å‰ç™¼å‹•çš„æŠ€èƒ½ç‰©ä»¶
        if (typeof spawnSkillEffect === "function") {
          spawnSkillEffect(skill);
        }

        if (skill.multiplier) {
          // æŠ€èƒ½å€ç‡ä½œç”¨æ–¼åŸºç¤æ”»æ“ŠåŠ›
          let effectiveAtk = stats.atk * skill.multiplier;
          baseDmg = Math.max(1, Math.floor((effectiveAtk * effectiveAtk) / (effectiveAtk + currentMonster.def)));
          actionLog = `<span style="color:${skill.color}">ã€${skill.name}ã€‘ç™¼å‹•ï¼</span> `;
        }
        
        if (skill.type === "heal") {
          let healAmt = Math.floor((stats.maxHp - game.currentHp) * (skill.ratio || 0));
          game.currentHp = Math.min(stats.maxHp, game.currentHp + healAmt);
          actionLog = `<span style="color:${skill.color}">ã€${skill.name}ã€‘æ²»ç™’ ${healAmt} HPï¼</span> `;
          // æ²»ç™’è¡“è‹¥ç„¡æ”»æ“ŠåŠ›ï¼ŒåŸºç¤å‚·å®³å‰‡èµ°æ™®æ”»
          let pAtk = stats.atk;
          baseDmg = Math.max(1, Math.floor((pAtk * pAtk) / (pAtk + currentMonster.def)));
        }
      } else {
        actionLog = `<span style="color:rgba(255,255,255,0.3); font-size:11px;">(é­”åŠ›ä¸è¶³æ–½å±• ${skill.name})</span> `;
      }
    }
  }


  // --- B. æ™®æ”»è¨ˆç®— (è‹¥æœªè§¸ç™¼æ”»æ“Šå‹æŠ€èƒ½) ---
  if (!skillTriggered) {
    if (actionLog === "") actionLog = `<span style="color:#ccc;">æ™®é€šæ”»æ“Šï¼š</span> `;
    let pAtk = stats.atk;
    baseDmg = Math.max(1, Math.floor((pAtk * pAtk) / (pAtk + currentMonster.def)));
  }

  // ç©å®¶é€ æˆå‚·å®³
  currentMonster.curHp -= baseDmg;
  addBattleLog(`<div>${actionLog}é€ æˆ <span style="color: #2ecc71;">${baseDmg}</span> å‚·å®³</div>`);

  // --- C. æ€ªç‰©åæ“Šè¨ˆç®— (åƒ…åœ¨æ€ªç‰©å­˜æ´»æ™‚) ---
  if (currentMonster.curHp > 0) {
    let mAtkData = currentMonster.atkRange || [currentMonster.lv * 5, currentMonster.lv * 10];
    let mBaseAtk = Math.floor(Math.random() * (mAtkData[1] - mAtkData[0] + 1)) + mAtkData[0];
    let mDamage = 0;
    let battleMsg = "";

    // --- æŠ€èƒ½ç™¼å‹•åˆ¤æ–· ---
    let usedSkill = null;
    // æª¢æŸ¥æ€ªç‰©æ˜¯å¦æœ‰æŠ€èƒ½ï¼Œä¸¦è¨­å®š 25% çš„ç¸½æŠ€èƒ½ç™¼å‹•ç‡
    if (currentMonster.skills && currentMonster.skills.length > 0 && Math.random() < 0.25) {
      usedSkill = currentMonster.skills[Math.floor(Math.random() * currentMonster.skills.length)];
    }

    if (usedSkill) {
      if (usedSkill.heal) {
        // A. æ²»ç™‚å‹æŠ€èƒ½
        let healAmt = Math.floor(currentMonster.hp * usedSkill.heal);
        currentMonster.curHp = Math.min(currentMonster.hp, currentMonster.curHp + healAmt);
        battleMsg = `<div style="color: #2ecc71;">${currentMonster.name} ${usedSkill.msg} (+${healAmt} HP)</div>`;
      } else {
        // B. å‚·å®³å‹æŠ€èƒ½ (å¥—ç”¨æŠ€èƒ½å€ç‡ power)
        let skillAtk = mBaseAtk * (usedSkill.power || 1);
        mDamage = Math.max(1, Math.floor((skillAtk * skillAtk) / (skillAtk + stats.def)));
        game.currentHp -= mDamage;
        battleMsg = `<div style="color: #f39c12;">â˜… ${currentMonster.name} ${usedSkill.msg} é€ æˆ ${mDamage} å‚·å®³</div>`;
      }
    } else {
      // C. æ™®é€šæ”»æ“Š (æ‚¨åŸæœ¬çš„éæ¸›æ›²ç·šå…¬å¼)
      mDamage = Math.max(1, Math.floor((mBaseAtk * mBaseAtk) / (mBaseAtk + stats.def)));
      game.currentHp -= mDamage;
      battleMsg = `<div style="color: #e74c3c;">${currentMonster.name} åæ“Šé€ æˆ ${mDamage} å‚·å®³</div>`;
    }

    addBattleLog(battleMsg);
  }

  // --- D. è¦–è¦ºæ›´æ–°èˆ‡å‹è² åˆ¤å®š ---
  updateBattleUI();

  if (currentMonster.curHp <= 0) {
    // åœæ­¢è¨ˆæ™‚å™¨ï¼Œé˜²æ­¢åœ¨ setTimeout æœŸé–“å¤šæ‰“ä¸€ä¸‹
    clearInterval(battleInterval);
    battleInterval = null;
    currentMonster.curHp = 0;
    updateBattleUI();
    // å»¶é²çµç®—ï¼Œæå‡è¦–è¦ºé«”é©—
    setTimeout(winBattle, 300);
  } else if (game.currentHp <= 0) {
    game.currentHp = 0;
    clearInterval(battleInterval);
    battleInterval = null;
    updateBattleUI();
    stopBattle("ä½ è¢«æ‰“æ•—äº†ï¼Œæ’¤é€€å›å®¶...");
  }
}

// è¼”åŠ©å‡½å¼ï¼šæ–°å¢æˆ°é¬¥è¨Šæ¯åˆ°æ—¥èªŒ
function addBattleLog(msg) {
  const log = document.getElementById("battleLog");
  if (log) {
    // ä½¿ç”¨ innerHTML ä¸¦çµåˆ flex-direction: column-reverse è®“æ–°è¨Šæ¯åœ¨æœ€ä¸Šæ–¹
    const div = document.createElement("div");
    div.innerHTML = msg;
    log.insertBefore(div, log.firstChild);
  }
}

// 5. å‹åˆ©çµç®—
function winBattle() {
  if (!currentMonster) return;

  // 1. ç´€éŒ„ç•¶å‰æ˜¯å¦ç‚º BOSS æˆ°
  const isBossBattle = currentMonster.isBoss === true;
  const monsterName = currentMonster.name;

  // 2. çµç®—åŸºç¤çå‹µ
  let dropItemName = currentMonster.dropMat || "æœªçŸ¥ææ–™";
  game.materials[dropItemName] = (game.materials[dropItemName] || 0) + 1;
  
  // å¦‚æœæ˜¯ BOSSï¼Œçµ¦äºˆé¡å¤–çš„é­”åŠ›çå‹µ (ä½¿ç”¨æ•¸æ“šåº«è¨­å®šçš„æˆ–é è¨­ 5 å€)
  let rewardMana = isBossBattle ? (currentMonster.rewardMana || currentMonster.lv * 500) : (currentMonster.lv * 100);
  game.mana += rewardMana;

  const log = document.getElementById("battleLog");
  let equipMsg = "";

  // 3. è£å‚™æ‰è½é‚è¼¯ (BOSS 100% æ‰è½ï¼Œä¸€èˆ¬æ€ª 30%)
  let dropChance = isBossBattle ? 1.0 : 0.3;
  if (Math.random() < dropChance) {
    const newEquip = generateRandomEquip(currentMonster.lv);
    // BOSS æ‰è½ä¿åº•è‡³å°‘æ˜¯ã€Œç¨€æœ‰(1)ã€ä»¥ä¸Š
    if (isBossBattle && newEquip.rarity < 1) newEquip.rarity = 1;
    
    game.inventory.push(newEquip);
    equipMsg = ` ä¸¦ç²å¾—äº† <span style="color: var(--rarity-${newEquip.rarity})">[${newEquip.name}]</span>`;
  }

  // 4. æ›´æ–°æ—¥èªŒé¡¯ç¤º
  if (log) {
    if (isBossBattle) {
      log.innerHTML = `<div style="color: #f1c40f; font-weight: bold; border: 1px solid #f1c40f; padding: 5px; border-radius: 5px; margin: 5px 0;">
        ğŸ† å‚³å¥‡è¨ä¼æˆåŠŸï¼æ“Šæ•—äº† ${monsterName}<br>ç²å¾— ${rewardMana} âœ¨ èˆ‡ ${dropItemName}${equipMsg}
      </div>` + log.innerHTML;
    } else {
      log.innerHTML = `<div style="color: #3498db;">å‹åˆ©ï¼ç²å¾— ${rewardMana} âœ¨ èˆ‡ ${dropItemName}${equipMsg}</div>` + log.innerHTML;
    }
  }

  document.getElementById("battleStatus").innerText = isBossBattle ? `é¦–é ˜æŒ‘æˆ°æˆåŠŸï¼` : `å‹åˆ©ï¼ç²å¾—çå‹µ...`;
  
  // 5. æ ¸å¿ƒä¿®æ”¹ï¼šåˆ¤æ–·çºŒæˆ°é‚è¼¯
  if (isBossBattle) {
    // å¦‚æœæ˜¯ BOSSï¼Œç›´æ¥å‘¼å«åœæ­¢æˆ°é¬¥ï¼Œä¸é€²å…¥ä¸‹æ–¹çš„ setTimeout
    stopBattle(`æˆåŠŸæ“Šæ•—äº†é¦–é ˜ ${monsterName}ï¼`);
    saveData(); // æ“Šæ•— BOSS å‹™å¿…ç«‹å³å­˜æª”
  } else {
    // å¦‚æœæ˜¯ä¸€èˆ¬æ€ªç‰©ï¼Œæ¸…ç©ºå¯¦é«”ä¸¦æº–å‚™ä¸‹ä¸€å ´
    currentMonster = null;
    saveData();
    
    setTimeout(() => {
      // ç¢ºä¿åœ¨å»¶é²æœŸé–“ç©å®¶æ²’æœ‰æ‰‹å‹•åœæ­¢æˆ°é¬¥
      if (game.currentHp > 0) {
        startBattle(); 
      } else {
        stopBattle("é«”åŠ›ä¸è¶³ï¼Œè‡ªå‹•æˆ°é¬¥åœæ­¢");
      }
    }, 1200); 
  }
}

// 6. çµ‚æ­¢æˆ°é¬¥èˆ‡å¾©åŸä»‹é¢
function stopBattle(reason = "æˆ°é¬¥åœæ­¢") {
  if (battleInterval) { clearInterval(battleInterval); battleInterval = null; }
  currentMonster = null;

  document.getElementById("playerBattleArea").style.display = "none";
  document.getElementById("monsterArea").style.display = "none";
  document.getElementById("vsTitle").style.display = "none";
  
  if (battleMode === 'boss') {
    document.getElementById("bossControls").style.display = "block";
  }

  document.getElementById("startBattleBtn").style.display = "block";
  document.getElementById("stopBattleBtn").style.display = "none";
  document.getElementById("battleStatus").innerText = reason;
  updateUI();
}

// 7. æ›´æ–°æˆ°é¬¥ç›¸é—œ UI
function updateBattleUI() {
  const stats = getCombatStats();
  const curHp = Math.max(0, Math.floor(game.currentHp));
  const maxHp = stats.maxHp;

  // æ›´æ–°æˆ°é¬¥åˆ†é è¡€æ¢
  const pText = document.getElementById("pBattleHpText");
  const pBar = document.getElementById("pBattleHpBar");
  if (pText) pText.innerText = `${curHp} / ${maxHp}`;
  if (pBar) pBar.style.width = (curHp / maxHp * 100) + "%";

  // æ›´æ–°æ€ªç‰©è¡€æ¢
  if (currentMonster) {
    const mHp = Math.max(0, Math.floor(currentMonster.curHp));
    const mText = document.getElementById("mHpText");
    const mBar = document.getElementById("mHpBar");
    if (mText) mText.innerText = `${mHp} / ${currentMonster.maxHp}`;
    if (mBar) mBar.style.width = (mHp / currentMonster.maxHp * 100) + "%";
  }

  // åŒæ­¥æ›´æ–°ä¸»ä»‹é¢å·¦ä¸Šè§’è¡€æ¢ (ä¸å‘¼å«è€—èƒ½çš„ updateUI)
  const mainHpText = document.getElementById("hpText");
  const mainHpBar = document.getElementById("hpBar");
  if (mainHpText) mainHpText.innerText = `${curHp} / ${maxHp}`;
  if (mainHpBar) mainHpBar.style.width = (curHp / maxHp * 100) + "%";
  
  // æ›´æ–°é­”åŠ›é¡¯ç¤º
  const manaEl = document.getElementById("mana");
  if (manaEl) manaEl.innerText = Math.floor(game.mana).toLocaleString();
}

/**
 * ============================================================
 * è¨­å®šèˆ‡å­˜æª”ç³»çµ±
 * ============================================================
 */

// 1. åŸ·è¡Œä¸‹è¼‰å­˜æª”æª”æ¡ˆ
function exportSaveFile() {
  const date = new Date();
  const dateString = date.toISOString().split('T')[0];
  const filename = `Legend_Save_${dateString}.sav`;
  
  // ç¢ºä¿ä¸‹è¼‰çš„æ˜¯æœ€æ–°çš„ game æ•¸æ“š
  const saveData = JSON.stringify(game, null, 2);
  const blob = new Blob([saveData], { type: 'application/json' });
  
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  alert("å­˜æª”æª”æ¡ˆå·²ä¸‹è¼‰è‡³æ‚¨çš„è¨­å‚™ã€‚");
}

// è™•ç†ä¸Šå‚³å­˜æª”æª”æ¡ˆ (ä¿®æ­£ Key å€¼è¡çª)
function importSaveFile(input) {
  const file = input.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const decodedData = JSON.parse(e.target.result);
      
      // é©—è­‰å­˜æª”å…§å®¹ (ç¢ºä¿å®ƒæ˜¯ä½ çš„éŠæˆ²è³‡æ–™)
      if (decodedData && (typeof decodedData.mana !== 'undefined' || typeof decodedData.charLv !== 'undefined')) {
        if (confirm("æª”æ¡ˆè§£ææˆåŠŸï¼ç¢ºå®šè¦è¦†è“‹ç›®å‰é€²åº¦ä¸¦é‡å•ŸéŠæˆ²å—ï¼Ÿ")) {
          // æ ¸å¿ƒä¿®æ­£ï¼šåŠ å…¥ flag é˜²æ­¢éºè¨€å­˜æª”
          canSave = false; 
          
          // æ ¸å¿ƒä¿®æ­£ï¼šå°‡è³‡æ–™å¯«å…¥èˆ‡ initGame ç›¸åŒçš„ Key
          localStorage.setItem(SAVE_KEY, JSON.stringify(decodedData)); 
          
          alert("é€²åº¦åŒ¯å…¥æˆåŠŸï¼Œå³å°‡é‡å•ŸéŠæˆ²ï¼");
          location.reload(); // é‡æ•´å¾Œ initGame() æœƒè®€å–æ–°çš„ SAVE_KEY
        }
      } else {
        alert("åŒ¯å…¥å¤±æ•—ï¼šé€™ä¼¼ä¹ä¸æ˜¯æœ‰æ•ˆçš„å­˜æª”æª”æ¡ˆã€‚");
      }
    } catch (err) {
      alert("æª”æ¡ˆè®€å–å‡ºéŒ¯ï¼Œè«‹ç¢ºä¿å®ƒæ˜¯æ­£ç¢ºçš„ .sav æˆ– .json æª”æ¡ˆã€‚");
      console.error(err);
    }
    input.value = '';
  };
  reader.readAsText(file);
}

// åˆªé™¤ç´€éŒ„é‚è¼¯ (çµ±ä¸€ä½¿ç”¨ SAVE_KEY)
function confirmReset() {
  if (confirm("ğŸš¨ è­¦å‘Šï¼šç¢ºå®šè¦åˆªé™¤æ‰€æœ‰é€²åº¦å—ï¼Ÿ")) {
    if (confirm("é€™æœƒæ¸…ç©ºæ‰€æœ‰æ•¸æ“šä¸¦é‡æ–°é–‹å§‹ï¼ŒçœŸçš„ç¢ºå®šï¼Ÿ")) {
      // æ ¸å¿ƒä¿®æ­£ï¼šé˜²æ­¢éºè¨€å­˜æª”
      canSave = false; 
      
      localStorage.removeItem(SAVE_KEY); // åªåˆªé™¤éŠæˆ²å­˜æª”ï¼Œä¸å½±éŸ¿å…¶ä»–å¯èƒ½çš„ç·©å­˜
      alert("æ•¸æ“šå·²æ¸…ç©ºï¼");
      location.reload();
    }
  }
}

// 5. æ›´æ–°æœ€å¾Œå­˜æª”æ™‚é–“é¡¯ç¤º
function updateSaveTime() {
  const now = new Date();
  const timeStr = now.getHours().toString().padStart(2, '0') + ":" + 
                  now.getMinutes().toString().padStart(2, '0') + ":" + 
                  now.getSeconds().toString().padStart(2, '0');
  const el = document.getElementById("lastSaveTime");
  if (el) el.innerText = timeStr;
}

/**
 * ============================================================
 * å…¨å±€å®šæ™‚å™¨ (Global Game Loop) 
 * ============================================================
 */
setInterval(() => {
  // 1. é­”åŠ›ç”¢å‡º (MPS / 10)
  game.mana += manaPerSecond() / 10;
  
  // 2. è„«æˆ°ç‹€æ…‹ä¸‹çš„ç”Ÿå‘½å€¼å›å¾©
  if (game.currentHp < getMaxHp() && !battleInterval) {
    // åŸºç¤å›è¡€ + å†¥æƒ³åŠ æˆ
    let regen = (getMaxHp() * 0.005) + (game.med * 0.5); 
    game.currentHp = Math.min(getMaxHp(), game.currentHp + regen / 10);
    
    updateBattleUI(); 
  }

  // 3. åŸºç¤æ•¸å€¼é¡¯ç¤ºæ›´æ–° (é­”åŠ›)
  const manaEl = document.getElementById("mana");
  if (manaEl) manaEl.innerText = Math.floor(game.mana).toLocaleString();

}, 100);

// åˆæ¬¡å•Ÿå‹• UI
updateUI();
</script>

</div>
</div>
</body>
</html>